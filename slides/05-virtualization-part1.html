<!DOCTYPE html>
<html lang="en"><head>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/tabby.min.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.8.26">

  <meta name="author" content="Jordi Mateo Fornés">
  <title>AMSA - Fall 2025 – Virtualització i Contenidors</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../site_libs/revealjs/dist/theme/quarto-0fde88a82f0356838740f155f1088782.css">
  <link rel="stylesheet" href="styles.css">
  <link href="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Virtualització i Contenidors</h1>
  <p class="subtitle">Unitat 5 · Administració i Manteniment de Sistemes i Aplicacions (AMSA)</p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Jordi Mateo Fornés 
</div>
</div>
</div>

</section>
<section id="què-és-la-virtualització" class="slide level2 smaller">
<h2>Què és la virtualització?</h2>
<p>La virtualització és una tecnologia que permet executar múltiples sistemes complets (SO, aplicacions i maquinari virtualitzat) sobre un únic host físic.</p>
<div class="fragment">
<h3 id="per-a-què-serveix">Per a què serveix?</h3>
<ul>
<li class="fragment"><strong>Aïllament</strong>: cada màquina virtual s’executa de manera independent, sense interferir amb les altres.</li>
<li class="fragment"><strong>Flexibilitat</strong>: permet crear, modificar i eliminar entorns ràpidament.</li>
<li class="fragment"><strong>Eficiència de recursos</strong>: aprofita millor el hardware compartint CPU, memòria i emmagatzematge.</li>
<li class="fragment"><strong>Facilitat de desplegament i manteniment</strong>: simplifica proves, rèpliques, desastres i actualitzacions.</li>
</ul>
</div>
</section>
<section id="emulació-i-virtualització" class="slide level2 smaller">
<h2>Emulació i virtualització</h2>
<div class="columns">
<div class="column" style="width:50%;">
<h3 id="emulació">Emulació</h3>
<ul>
<li class="fragment">Reprodueix una arquitectura diferent de la del host (p.&nbsp;ex. executar programari ARM en un host x86).</li>
<li class="fragment">Més lenta, perquè s’han de traduir instruccions.</li>
<li class="fragment">Útil per a <strong>compatibilitat</strong>, proves o sistemes antics.</li>
</ul>
<div class="center-container fragment">
<p>Exemple: QEMU en mode full emulation.</p>
</div>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb1-1"><a></a>Host (x86)</span>
<span id="cb1-2"><a></a>   ↓ traducció</span>
<span id="cb1-3"><a></a>Guest (ARM)  --&gt; Lenta</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div><div class="column" style="width:50%;">
<h3 id="virtualització">Virtualització</h3>
<ul>
<li class="fragment">Guest i host <strong>comparteixen</strong> la mateixa arquitectura.</li>
<li class="fragment">El hypervisor aprofita instruccions de hardware → rendiment molt proper al natiu.</li>
<li class="fragment">Útil per executar diversos SO al mateix temps en un host.</li>
</ul>
<div class="center-container fragment">
<p>Exemples: KVM, VMware, Hyper-V.</p>
</div>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb2-1"><a></a>Host (x86)</span>
<span id="cb2-2"><a></a>   ↓ execució directa</span>
<span id="cb2-3"><a></a>Guest (x86) --&gt; Proper al natiu</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</div></div>
</section>
<section id="hypervisor" class="slide level2 smaller">
<h2>Hypervisor</h2>
<p>Un hypervisor és el programari que crea, executa i gestiona màquines virtuals (VMs). Permet compartir el maquinari físic entre diversos sistemes operatius.</p>
<div class="columns">
<div class="column" style="width:50%;">
<h3 id="type-1-bare-metal">Type 1 (bare metal)</h3>
<ul>
<li class="fragment">S’executa directament sobre el hardware (no hi ha un SO host).</li>
<li class="fragment">Més rendiment, menys latència i millor seguretat.</li>
<li class="fragment">Utilitzat en servidors i centres de dades.</li>
<li class="fragment">Exemples: VMware ESXi, Microsoft Hyper-V Server, Xen.</li>
</ul>
</div><div class="column" style="width:50%;">
<h3 id="type-2-hosted">Type 2 (hosted)</h3>
<ul>
<li class="fragment">S’executa a sobre d’un sistema operatiu host.</li>
<li class="fragment">Més senzill d’instal·lar i ideal per a entorns de desenvolupament o escriptori.</li>
<li class="fragment">Lleugerament menys eficient.</li>
<li class="fragment">Exemples: VirtualBox, VMware Workstation, Parallels.</li>
</ul>
</div></div>
</section>
<section id="arquitectura-típiques" class="slide level2">
<h2>Arquitectura típiques</h2>
<div class="center-container">
<p><img data-src="../figs/slides/01-foundations-of-systems-administration/virtualitzacio.png"></p>
</div>
</section>
<section id="paravirtualització" class="slide level2 smaller">
<h2>Paravirtualització</h2>
<p>El sistema operatiu guest es modifica per cooperar amb el VMM:</p>
<ul>
<li class="fragment"><strong>CPU paravirtualitzada</strong>: ús de hypercalls en lloc d’instruccions privilegiades.</li>
<li class="fragment"><strong>MMU paravirtualitzada</strong>: gestió compartida de les taules de pàgines.</li>
<li class="fragment"><strong>I/O paravirtualitzada</strong>: dispositius virtuals optimitzats (Virtio).</li>
</ul>
<div class="fragment">
<p>El VMM exposa <strong>hypercalls</strong> per:</p>
<ul>
<li class="fragment">Activar/desactivar interrupcions</li>
<li class="fragment">Canviar taules de pàgines</li>
<li class="fragment">Accedir a perifèrics virtualitzats</li>
</ul>
</div>
<div class="fragment center-container">
<p>El VMM pot injectar <strong>interrupcions virtuals</strong> a través d’esdeveniments.</p>
</div>
</section>
<section id="intel-vt-" class="slide level2 smaller">
<h2>Intel VT-</h2>
<ul>
<li class="fragment">Extensió que transforma x86 en una arquitectura virtualitzable.
<ul>
<li class="fragment"><strong>Root mode</strong>: s’executa el VMM</li>
<li class="fragment"><strong>Non-root mode</strong>: s’executen els guests</li>
</ul></li>
<li class="fragment">Cada instància en non-root mode manté un VMCS (Virtual Machine Control Structure) amb:
<ul>
<li class="fragment">Estat del guest (registres, CR3, IDTR, etc.)</li>
<li class="fragment">Estat intern invisible</li>
</ul></li>
<li class="fragment">Transicions:
<ul>
<li class="fragment"><strong>VM Entry</strong>: càrrega l’estat del guest des del VMCS</li>
<li class="fragment"><strong>VM Exit</strong>: guarda l’estat del guest i restaura el del host</li>
</ul></li>
</ul>
</section>
<section id="com-guardarrestaurar-una-vm" class="slide level2 smaller">
<h2>Com guardar/restaurar una VM?</h2>
<p>Una màquina virtual es pot guardar, copiar o restaurar perquè està formada per un conjunt d’arxius que descriuen:</p>
<ul>
<li class="fragment">L’estat de la VM (configuració)</li>
<li class="fragment">El disc dur virtual</li>
<li class="fragment">(Opcional) Snapshots o estats suspesos</li>
</ul>
<div class="fragment">
<p>Cada hypervisor utilitza formats propis:</p>
<ul>
<li class="fragment">VMware: .vmx (configuració), .vmdk (disc virtual)</li>
<li class="fragment">VirtualBox: .vbox (configuració), .vdi (disc virtual)</li>
<li class="fragment">KVM/QEMU: .qcow2, .img (disc virtual)</li>
</ul>
</div>
<div class="fragment center-container">
<p>Per exemple, quan vau realitar la pràctica 2, us vaig facilitar una imatge .vmdk de VMware.</p>
</div>
</section>
<section id="característiques" class="slide level2">
<h2>Característiques</h2>
<table class="caption-top">
<colgroup>
<col style="width: 42%">
<col style="width: 57%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Avantatges</strong></th>
<th><strong>Inconvenients</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Permeten executar <strong>arquitectures i SO diferents</strong></td>
<td><strong>Més pesants</strong>: cal un SO complet → <strong>mida de la imatge elevada</strong></td>
</tr>
<tr class="even">
<td><strong>Aïllament i seguretat</strong> molt alts</td>
<td><strong>Temps d’arrencada</strong> més lent que contenidors</td>
</tr>
<tr class="odd">
<td>Es poden <strong>compartir i importar imatges</strong> fàcilment</td>
<td><strong>Interoperabilitat limitada</strong> entre hypervisors (formats diferents)</td>
</tr>
</tbody>
</table>
<aside class="notes">
<ul>
<li>Recorda-los que una VM ocupa “com un ordinador real” → per això les imatges poden ser de diversos GB.</li>
<li>Subratlla que compartir una imatge d’una VM vol dir reproduir exactament el mateix entorn (molt útil en docència i DevOps).</li>
<li>Compara amb contenidors: VM = PC complet, contenidor = procés aïllat.</li>
<li>Explica que la interoperabilitat no està garantida: un .vmdk no sempre funciona en VirtualBox o QEMU sense conversió.</li>
</ul>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section id="com-podem-millorar-una-màquina-virtual" class="slide level2">
<h2>Com podem millorar una màquina virtual?</h2>
<ul>
<li class="fragment">Imaginem que volem executar un programa senzill, com un petit servidor web.</li>
<li class="fragment">Amb una VM, necessitem instal·lar un sistema operatiu complet (Linux, Windows…).</li>
<li class="fragment">Això vol dir:
<ul>
<li class="fragment">Molt més espai en disc (GB de la imatge)</li>
<li class="fragment">Més memòria RAM per al SO</li>
<li class="fragment">Temps d’arrencada força més elevat</li>
</ul></li>
</ul>
</section>
<section id="però-és-realment-necessari-un-so-complet" class="slide level2 smaller">
<h2>Però… és realment necessari un SO complet?</h2>
<ul>
<li class="fragment">Un servidor web no necessita totes les funcions del kernel.</li>
<li class="fragment">Ens agradaria dir-li al sistema:
<ul>
<li class="fragment"><strong>Executa aquest procés, però aïllat de la resta del sistema.</strong></li>
</ul></li>
<li class="fragment">Un servidor web no necessita:
<ul>
<li class="fragment">funcions d’inici de sessió,</li>
<li class="fragment">gestió d’usuaris complexa,</li>
<li class="fragment">serveis de fons innecessaris,</li>
<li class="fragment">processos del sistema que no tenen res a veure amb l’aplicació</li>
</ul></li>
</ul>
<div class="fragment center-container">
<p>un paquet mínim que inclou biblioteques + configuració + aplicació, executat de manera aïllada però sense un SO complet per cada instància.</p>
</div>
</section>
<section id="quantes-vegades-hem-sentit-això" class="slide level2 smaller">
<h2>Quantes vegades hem sentit això?</h2>
<div class="fragment center-container">
<p><strong>Works on my machine</strong></p>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<ul>
<li class="fragment">Al meu PC funciona… però al teu no.</li>
<li class="fragment">A l’entorn de tests va perfecte, però en producció peta.</li>
<li class="fragment">La versió de la llibreria X és diferent.</li>
<li class="fragment">Aquest programa necessita permisos que aquí no té.</li>
<li class="fragment">Funciona a la meva màquina virtual… però al servidor no.</li>
</ul>
</div><div class="column" style="width:50%;">
<ul>
<li class="fragment">Dependències diferents</li>
<li class="fragment">Versions de llibreries inconsistents</li>
<li class="fragment">Configuracions de sistema no iguals</li>
<li class="fragment">Permisos, usuaris o paths que no coincideixen</li>
<li class="fragment">Serveis que al teu entorn estan actius, però en un altre no</li>
</ul>
</div></div>
</section>
<section id="contenidors" class="slide level2 smaller">
<h2>Contenidors</h2>
<div class="center-container">
<p>La característica que estem buscant rep el nom de contenidors.</p>
</div>
<div class="fragment">
<p>Els contenidors no aparareixen com a tals al kernel de Linux. Són una combinació de diverses funcionalitats del nucli:</p>
<ul>
<li class="fragment"><strong>Namespaces</strong> → Aïllen processos</li>
<li class="fragment"><strong>cgroups v2</strong> → Limiten i controlen recursos (CPU, memòria, E/S…)</li>
<li class="fragment"><strong>Overlay filesystems</strong> → Proporcionen sistemes d’arxius lleugers i capaços d’apilar capes</li>
</ul>
</div>
<div class="fragment center-container">
<p>La combinació d’aquests tres elements crea l’efecte que nosaltres anomenem contenidors.</p>
</div>
</section>
<section id="cgroups---control-de-recursos" class="slide level2 smaller">
<h2>cgroups - Control de recursos</h2>
<p>Els cgroups són una funcionalitat del kernel que permet limitar i controlar els recursos que utilitza un grup de processos (o un contenidor).</p>
<div class="fragment">
<p>Aquests límits poden ser:</p>
<ul>
<li class="fragment">CPU: quant temps de processador poden consumir</li>
<li class="fragment">Memòria: límit de RAM i swap</li>
<li class="fragment">Disc (I/O): velocitat de lectura/escriptura</li>
<li class="fragment">Xarxa: ample de banda</li>
</ul>
</div>
<div class="fragment center-container">
<p><strong>Per què són importants?</strong> Eviten que un procés o contenidor monopolitzi el sistema.</p>
</div>
</section>
<section id="namespaces---aïllament" class="slide level2 smaller">
<h2>Namespaces - Aïllament</h2>
<p>Els namespaces permeten que cada contenidor tingui la seva pròpia visió del sistema, com si fos un entorn independent</p>
<ul>
<li class="fragment">PID → processos propis</li>
<li class="fragment">UTS → hostname propi</li>
<li class="fragment">NET → interfícies de xarxa i rutes separades</li>
<li class="fragment">MNT → sistema de fitxers aïllat</li>
<li class="fragment">USER → UIDs/GIDs independents</li>
<li class="fragment">IPC → recursos IPC separats</li>
<li class="fragment">CGROUP namespaces → cgroups propis</li>
</ul>
<div class="center-container fragment">
<p>Efecte de màquina virtualitzada, però compartint el mateix nucli real.</p>
</div>
</section>
<section id="overlay-filesystems" class="slide level2 smaller">
<h2>Overlay Filesystems</h2>
<p>Els contenidors utilitzen OverlayFS (o variants) per gestionar un sistema d’arxius:</p>
<ul>
<li class="fragment">Les capes inferiors són de només lectura (base de la imatge).</li>
<li class="fragment">La capa superior és d’escriptura, on viu el que modifica el contenidor.</li>
<li class="fragment">Diversos contenidors poden compartir les capes inferiors → estalvi d’espai i eficiència.</li>
</ul>
<div class="fragment">
<p>Això fa que les imatges siguin:</p>
<ul>
<li class="fragment">Lleugeres</li>
<li class="fragment">Ràpides de desplegar</li>
<li class="fragment">Facils de distribuir i versionar</li>
</ul>
</div>
</section>
<section id="arquitectura-simplificada" class="slide level2 smaller">
<h2>Arquitectura simplificada</h2>
<div class="columns">
<div class="column" style="width:60%;">
<p>Aquesta figura mostra com un contenidor és, en realitat, un conjunt de processos normals del sistema Linux:</p>
<ul>
<li class="fragment">El kernel és compartit per tots els processos.</li>
<li class="fragment">systemd (o un altre init) gestiona processos de l’amfitrió.</li>
<li class="fragment">Els programes normals (A, B, C…) conviuen en el mateix sistema.</li>
<li class="fragment">Els processos del contenidor també són processos normals, però:
<ul>
<li class="fragment">Estan aïllats per namespaces,</li>
<li class="fragment">Tenen límits de recursos amb cgroups,</li>
<li class="fragment">Veuen un sistema de fitxers propi (OverlayFS).</li>
</ul></li>
</ul>
</div><div class="column" style="width:40%;">
<p><img data-src="../figs/slides/04-virt/container_simple.png" style="width:80.0%"></p>
<div class="center-container fragment">
<p>Tot i estar dins del contenidor, segueixen sent processos Linux del host.</p>
</div>
</div></div>
</section>
<section id="motors-o-llibreries-de-contenidors" class="slide level2 smaller">
<h2>Motors o Llibreries de Contenidors</h2>
<h3 id="lxc-linux-containers">LXC (Linux Containers)</h3>
<ul>
<li class="fragment">Sistema de contenidors de baix nivell integrat al kernel.</li>
<li class="fragment">Contenidors de sistema complet (semblants a mini-màquines lleugeres).</li>
<li class="fragment">Ideal per entorns que necessiten un sistema d’inici complet (init, serveis…).</li>
<li class="fragment">És la base tècnica sobre la qual Docker es va inspirar als inicis.</li>
</ul>
</section>
<section id="motors-o-llibreries-de-contenidors-1" class="slide level2 smaller">
<h2>Motors o Llibreries de Contenidors</h2>
<h3 id="containerd">containerd</h3>
<ul>
<li class="fragment">Motor de contenidors de baix nivell.</li>
<li class="fragment">Gestiona el cicle de vida dels contenidors (crear, executar, aturar, eliminar).</li>
<li class="fragment">Utilitza <strong>runc</strong> per crear els contenidors reals.</li>
</ul>
</section>
<section id="motors-o-llibreries-de-contenidors-2" class="slide level2 smaller">
<h2>Motors o Llibreries de Contenidors</h2>
<h3 id="docker">Docker</h3>
<ul>
<li class="fragment">Plataforma molt estesa per crear, distribuir i executar contenidors.</li>
<li class="fragment">Enfocada en contenidors d’aplicacions, no de sistema.</li>
<li class="fragment">Funcionalitats integrades:
<ul>
<li class="fragment">imatges en capes</li>
<li class="fragment">xarxes virtuals</li>
<li class="fragment">volums</li>
<li class="fragment">API, logs, build…</li>
<li class="fragment">Buildkit sistema principal de construcció</li>
</ul></li>
</ul>
</section>
<section id="motors-o-llibreries-de-contenidors-3" class="slide level2 smaller">
<h2>Motors o Llibreries de Contenidors</h2>
<h3 id="podman">Podman</h3>
<ul>
<li class="fragment">Alternativa moderna i compatible amb Docker.</li>
<li class="fragment">No necessita daemon: cada contenidor és un procés del propi usuari.</li>
<li class="fragment">Permet executar contenidors com usuari normal (rootless).</li>
<li class="fragment">Compatible amb:
<ul>
<li class="fragment">imatges Docker</li>
<li class="fragment">comandes Docker (alias docker=podman)</li>
<li class="fragment">Kubernetes (podman generate kube)</li>
<li class="fragment">Permet executar <code>pods</code> (grups de contenidors) sense <code>kubelet</code></li>
</ul></li>
</ul>
</section>
<section id="passos-per-executar-un-contenidor-i" class="slide level2 smaller">
<h2>Passos per executar un contenidor (I)</h2>
<ol type="1">
<li class="fragment"><strong>Escriure un Containerfile</strong> → Descriu com ha de ser el contenidor:
<ul>
<li class="fragment">sistema base</li>
<li class="fragment">dependències</li>
<li class="fragment">fitxers a copiar</li>
<li class="fragment">com s’executa l’aplicació</li>
</ul></li>
<li class="fragment"><strong>Construir la imatge</strong> → A partir del Containerfile, el <em>Engine</em> crea una imatge. Pots pensar en la imatge com un .ova o .vmdk de VirtualBox:
<ul>
<li class="fragment">conté el sistema d’arxius</li>
<li class="fragment">és immutable (<em>entre cometes</em>)</li>
<li class="fragment">es pot copiar o distribuir (<em>portable</em>)</li>
</ul></li>
</ol>
</section>
<section id="passos-per-executar-un-contenidor-ii" class="slide level2 smaller">
<h2>Passos per executar un contenidor (II)</h2>
<ol start="3" type="1">
<li class="fragment"><strong>Executar un contenidor</strong>: Amb una imatge, el motor ( Engine / containerd + runc):
<ul>
<li class="fragment">crea un sistema d’arxius aïllat (OverlayFS)</li>
<li class="fragment">aplica namespaces i cgroups</li>
<li class="fragment">arrenca el procés principal del contenidor</li>
</ul></li>
</ol>
<div class="fragment center-container">
<p>Els passos 1 i 2 només es fan un cop per crear la imatge. Per executar el contenidor, només cal el pas 3.</p>
</div>
</section>
<section id="què-és-una-imatge-de-contenidor" class="slide level2 smaller">
<h2>Què és una imatge de contenidor?</h2>
<p>Un contenidor s’executa a partir d’una <strong>imatge OCI</strong> (Open Container Initiative). Una imatge conté:</p>
<ul>
<li class="fragment">Root filesystem: El sistema d’arxius que el contenidor veu com a <strong>arrel (/)</strong>:
<ul>
<li class="fragment">binaris</li>
<li class="fragment">llibreries</li>
<li class="fragment">fitxers de configuració</li>
</ul></li>
<li class="fragment">Metadades que indiquen com s’ha d’executar el contenidor:
<ul>
<li class="fragment">variables d’entorn</li>
<li class="fragment">comanda o entrypoint</li>
<li class="fragment">ports exposats</li>
<li class="fragment">usuaris</li>
<li class="fragment">configuració de xarxa</li>
<li class="fragment">punts de muntatge (volums)</li>
</ul></li>
</ul>
</section>
<section id="manifest.json" class="slide level2 smaller">
<h2><code>manifest.json</code></h2>
<p>És el mapa general de la imatge.</p>
<p>Conté:</p>
<ul>
<li class="fragment">identificador de les capes (layers)</li>
<li class="fragment">el fitxer de configuració a utilitzar</li>
<li class="fragment">el tipus de sistema d’arxius</li>
<li class="fragment">checksums (sha256) per assegurar integritat</li>
</ul>
<div class="center-container fragment">
<p>Pensa en el manifest com l’índex de tot el que forma la imatge.</p>
</div>
</section>
<section id="config.json" class="slide level2 smaller">
<h2><code>config.json</code></h2>
<p>Defineix el comportament del contenidor quan s’executi.</p>
<p>Conté:</p>
<ul>
<li class="fragment">Entrypoint i Cmd</li>
<li class="fragment">Variables d’entorn</li>
<li class="fragment">Usuari d’execució</li>
<li class="fragment">Volums</li>
<li class="fragment">Directori de treball (WORKDIR)</li>
<li class="fragment">Autor, timestamps, historial de construcció</li>
<li class="fragment">Informació d’arquitectura (amd64, arm64…)</li>
</ul>
<div class="center-container fragment">
<p>El config és la <strong>recepta</strong> que diu com s’ha d’executar la imatge.</p>
</div>
</section>
<section id="capes-duna-imatge-de-contenidor" class="slide level2">
<h2>Capes d’una imatge de contenidor</h2>
<ul>
<li class="fragment">El filesystem d’una imatge està format per diverses capes apilades (OverlayFS).</li>
<li class="fragment">Cada capa representa un conjunt de canvis respecte la capa anterior (instal·lar paquets, afegir fitxers…).</li>
<li class="fragment">Les capes són de només lectura i es poden reutilitzar entre imatges diferents → estalvi d’espai i eficiència.</li>
</ul>
<div class="center-container fragment">
<p>Les capes són com <strong>commits</strong>: cada una és un increment sobre l’anterior.</p>
</div>
</section>
<section id="característiques-dels-contenidors" class="slide level2 smaller">
<h2>Característiques dels contenidors</h2>
<div class="columns">
<div class="column" style="width:50%;">
<h3 id="avantatges">Avantatges</h3>
<ul>
<li class="fragment"><p><strong>Alt rendiment</strong>: Els contenidors s’executen gairebé a velocitat nativa perquè són processos d’usuari que comparteixen el kernel del host.</p></li>
<li class="fragment"><p><strong>Desplegament molt ràpid</strong>: Arranquen instantàniament, ja que no cal inicialitzar un sistema operatiu complet.</p></li>
<li class="fragment"><p><strong>Interoperabilitat d’execució</strong>: Poden funcionar amb diferents engines i runtimes (Docker, containerd, CRI-O, Podman, runc…).</p></li>
</ul>
</div><div class="column" style="width:50%;">
<h3 id="desavantatges">Desavantatges</h3>
<ul>
<li class="fragment">Només per a Linux</li>
<li class="fragment">Depenen de funcionalitats del kernel de Linux (namespaces, cgroups, OverlayFS).</li>
<li class="fragment">Per això les imatges sempre són Linux encara que executis Docker a Windows/Mac.</li>
<li class="fragment">Aïllament reduït</li>
<li class="fragment">Comparteixen el kernel del host → menor seguretat que la virtualització completa (VMs), on cada màquina té el seu kernel.</li>
</ul>
</div></div>
</section>
<section id="immutable-però-modificable" class="slide level2 smaller">
<h2>Immutable però modificable</h2>
<ul>
<li class="fragment">Les imatges de contenidors són <strong>immutables</strong>: La imatge original no canvia mai.</li>
<li class="fragment">Però quan un contenidor s’executa, sí que es pot modificar.</li>
<li class="fragment">Com és possible?</li>
</ul>
<div class="center-container fragment">
<p><strong>Perquè NO és una còpia bit a bit</strong></p>
</div>
<ul>
<li class="fragment">Els contenidors utilitzen un filesystem en capes (OverlayFS):</li>
<li class="fragment">Les capes inferiors (base image) són només lectura.</li>
<li class="fragment">El contenidor té una capa superior (writable layer) on fa els canvis.</li>
<li class="fragment">Totes les modificacions (fitxers nous, modificats o eliminats) van només a la capa superior.</li>
<li class="fragment">El commit d’un contenidor crea una nova imatge amb els canvis de la capa superior.</li>
</ul>
<div class="center-container fragment">
<p>La imatge no canvia. El contenidor sí.</p>
</div>
</section>
<section id="portable-si-però-no-totalment" class="slide level2 smaller">
<h2>Portable si … però no totalment</h2>
<ul>
<li class="fragment">Les imatges de contenidors són <strong>portables</strong>: es poden copiar i executar en qualsevol sistema amb el mateix motor (Docker, Podman, containerd…).</li>
<li class="fragment">Però hi ha algunes limitacions:
<ul>
<li class="fragment"><strong>Arquitectura</strong>: una imatge x86 no funcionarà en un host ARM. (Tot i que existeix multi-arch amb manifest i buildx.)</li>
<li class="fragment"><strong>Dependències del kernel</strong>: els contenidors depenen de funcionalitats específiques del kernel (namespaces, cgroups, OverlayFS). Si el host no les suporta, el contenidor no funcionarà.</li>
<li class="fragment"><strong>Recursos del host</strong>: si el host no té suficients recursos (CPU, memòria, disc), el contenidor pot no funcionar correctament</li>
<li class="fragment">Els contenidors no encapsulen el kernel ABI, per tant, si una aplicació depèn d’una versió específica del kernel, pot no funcionar en un host amb un kernel diferent.</li>
</ul></li>
</ul>
</section>
<section id="vms-vs-contenidors" class="slide level2 smaller">
<h2>VMs vs Contenidors</h2>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>Quan utilitzar màquines virtuals (VMs)</strong></p>
<ul>
<li class="fragment">Control complet del sistema operatiu (kernel propi, drivers, init, serveis…)</li>
<li class="fragment">Aïllament molt fort: Ideal per seguretat estricta o entorns multi-tenant desconfiats.</li>
<li class="fragment">Compatibilitat d’arquitectura</li>
<li class="fragment">Necessitat d’emular o executar altres arquitectures i sistemes.</li>
</ul>
</div><div class="column" style="width:50%;">
<p><strong>Quan utilitzar contenidors</strong></p>
<ul>
<li class="fragment">Desplegament molt ràpid: S’aixequen gairebé instantàniament.</li>
<li class="fragment">Consum reduït de recursos: Comparteixen el kernel → menys RAM i CPU.</li>
<li class="fragment">Ideals per aplicacions i serveis.</li>
</ul>
</div></div>
</section>
<section id="arquitectura-docker" class="slide level2">
<h2>Arquitectura Docker</h2>
<div class="center-container">
<p><img data-src="../figs/slides/04-virt/docker-on-linux.png" style="width:70.0%"></p>
</div>
</section>
<section id="components-principals-docker" class="slide level2 smaller">
<h2>Components principals Docker</h2>
<ul>
<li class="fragment"><strong>Docker client</strong>: interfície d’usuari (CLI, GUI, API)</li>
<li class="fragment"><strong>Docker Engine</strong>: motor de contenidors
<ul>
<li class="fragment"><strong>containerd</strong>: Gestiona el cicle de vida dels contenidors (crear, aturar, eliminar).</li>
<li class="fragment"><strong>runc</strong>: Crea el contenidor real utilitzant namespaces i cgroups. (És l’única part que parla directament amb el kernel.)</li>
<li class="fragment"><strong>libnetwork</strong>: Gestió de xarxes virtuals (bridges, NAT, interfaces virtuals).</li>
<li class="fragment"><strong>graphdriver</strong>: Gestió d’imatges i del sistema de capes (OverlayFS, btrfs, zfs…). Recentment anomenat <strong>snapshotter</strong>.</li>
<li class="fragment"><strong>plugins</strong>: Extensions per storage, logging i networking.</li>
</ul></li>
<li class="fragment"><strong>Kernel de Linux</strong>: El kernel és on realment s’executa el contenidor.
<ul>
<li class="fragment">Network stack, system calls, VFS…</li>
<li class="fragment">Namespaces, cgroups v2, OverlayFS</li>
</ul></li>
</ul>
<div class="center-container fragment">
<p>Docker és només una capa d’orquestració. Els contenidors els crea el kernel.</p>
</div>
</section>
<section id="installació-de-docker-a-ec2-i" class="slide level2">
<h2>Instal·lació de Docker a EC2 (I)</h2>
<ul>
<li class="fragment">Instal·lar el paquet amb <code>dnf</code> a Amazon Linux 2:</li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a></a><span class="fu">sudo</span> dnf install docker <span class="at">-y</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li class="fragment">Iniciar el servei de Docker:</li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a></a><span class="fu">sudo</span> systemctl enable <span class="at">--now</span> docker</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li class="fragment">Comprovar la instal·lació:</li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a></a><span class="ex">docker</span> <span class="at">--version</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="installació-de-docker-a-ec2-ii" class="slide level2">
<h2>Instal·lació de Docker a EC2 (II)</h2>
<ul>
<li class="fragment">Per a poder executar comandes de Docker sense necessitat de ser un usuari root, afegirem el nostre usuari al grup docker:</li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a></a><span class="fu">sudo</span> usermod <span class="at">-a</span> <span class="at">-G</span> docker ec2-user</span>
<span id="cb6-2"><a></a><span class="ex">newgrp</span> docker <span class="co"># Per a aplicar els canvis</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li class="fragment">Actualitzarem els permissos del socket de Docker per permetre als usuaris del grup docker llegir i escriure el fitxer: <code>/var/run/docker.sock</code></li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a></a><span class="fu">sudo</span> chmod g+rw /var/run/docker.sock</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="experiment-1-temps-darrencada" class="slide level2 smaller">
<h2>Experiment 1: Temps d’arrencada</h2>
<p>En aquest experiment compararem la velocitat d’arrencada d’una màquina virtual (VM) amb la d’un contenidor Docker.</p>
<ol type="1">
<li class="fragment"><strong>Màquina Virtual (VM)</strong>:
<ul>
<li class="fragment">Utilitzeu VirtualBox per crear una màquina virtual amb Debian.</li>
<li class="fragment">Mesureu el temps d’arrencada des de l’inici fins que el sistema està llest per a l’ús. <code>systemd-analyze</code> és una eina útil per això.</li>
</ul></li>
<li class="fragment"><strong>Contenidor Docker</strong>:
<ul>
<li class="fragment">Creeu un contenidor Docker utilitzant la imatge oficial de Debian.</li>
<li class="fragment">Mesureu el temps d’arrencada del contenidor des de la comanda <code>docker run</code> fins que el procés principal està en execució. Podeu utilitzar la comanda <code>time</code> per mesurar-ho.<br>
</li>
<li class="fragment">Per exemple: <code>time docker run --rm debian sleep 1</code></li>
</ul></li>
</ol>
</section>
<section id="exemple-1-i" class="slide level2">
<h2>Exemple 1 (I)</h2>
<h3 id="imagineu-un-servidor-amb-molts-recursos">Imagineu un servidor amb molts recursos</h3>
<div class="center-container">
<p><img data-src="../figs/slides/04-virt/server-0.png" style="width:60.0%"></p>
</div>
</section>
<section id="exemple-1-ii" class="slide level2">
<h2>Exemple 1 (II)</h2>
<h3 id="despleguem-primer-una-aplicació-amb-java">Despleguem primer una aplicació amb JAVA</h3>
<div class="center-container">
<p><img data-src="../figs/slides/04-virt/server-1.png" style="width:60.0%"></p>
</div>
</section>
<section id="exemple-1-iii" class="slide level2">
<h2>Exemple 1 (III)</h2>
<h3 id="despleguem-després-una-amb-python">Despleguem després una amb Python</h3>
<div class="center-container">
<p><img data-src="../figs/slides/04-virt/server-2.png" style="width:60.0%"></p>
</div>
</section>
<section id="exemple-1-iv" class="slide level2">
<h2>Exemple 1 (IV)</h2>
<h3 id="una-web-amb-react">Una web amb react</h3>
<div class="center-container">
<p><img data-src="../figs/slides/04-virt/server-3.png" style="width:60.0%"></p>
</div>
</section>
<section id="exemple-1-v" class="slide level2 smaller">
<h2>Exemple 1 (V)</h2>
<h3 id="això-no-escalarà-gairebé-bé">això no escalarà gairebé bé</h3>
<ul>
<li class="fragment">Cal definir usuaris i permisos per a cada aplicació.</li>
<li class="fragment">Cal evitar conflictes de versions de llibreries.</li>
<li class="fragment">I si Java necessita OpenSSL 1.1.x i Python OpenSSL 3.x?</li>
<li class="fragment">Cal evitar que una aplicació pugui accedir a fitxers d’una altra aplicació.</li>
<li class="fragment">Necessitem aïllament:
<ul>
<li class="fragment">Una màquina virtual per aplicació seria massa costosa en recursos.</li>
<li class="fragment">Necessitem un contenidor per aplicació!</li>
</ul></li>
</ul>
</section>
<section id="exemple-1-vi" class="slide level2 smaller">
<h2>Exemple 1 (VI)</h2>
<ul>
<li class="fragment">Contruïm un contenidor per a cada aplicació:
<ul>
<li class="fragment">Un contenidor amb Java + app Java</li>
<li class="fragment">Un contenidor amb Python + app Python</li>
<li class="fragment">Un contenidor amb Node.js + app React</li>
</ul></li>
<li class="fragment">Cada contenidor té el seu propi sistema d’arxius, llibreries i configuració.</li>
<li class="fragment">Compartim el mateix kernel del host, però cada aplicació està aïllada.</li>
</ul>
</section>
<section id="exemple-1-vii" class="slide level2">
<h2>Exemple 1 (VII)</h2>
<h3 id="i-ara-sí-que-escala-bé">I ara sí que escala bé!</h3>
<div class="center-container">
<p><img data-src="../figs/slides/04-virt/server-4.png" style="width:60.0%"></p>
</div>
</section>
<section id="imatge-ubuntu" class="slide level2">
<h2>Imatge <code>ubuntu</code></h2>
<ul>
<li class="fragment">La imatge d’<code>ubuntu</code> és una imatge oficial lleugera de Ubuntu.</li>
<li class="fragment">Conté una sola capa.</li>
<li class="fragment">Podeu utiltizar <code>docker inspect &lt;image_name&gt;</code> per veure els detalls com les capes, el sistema d’arxius i la configuració.</li>
</ul>
</section>
<section id="mida-de-les-imatges" class="slide level2 smaller">
<h2>Mida de les imatges</h2>
<p>Si utiltizeu la comanda <code>docker pull ubuntu &amp;&amp; docker image ls ubuntu</code>, veureu que la imatge ocupa només 139 MB.</p>
<div class="fragment">
<p>Aquest imatge únicament conté el <strong>userspace filesystem</strong> i els paquets bàsics de Ubuntu. No conté:</p>
<ul>
<li class="fragment">Kernel</li>
<li class="fragment">Drivers</li>
<li class="fragment">Serveis de <code>systemd</code></li>
<li class="fragment">Entorn gràfic</li>
<li class="fragment">bootloader</li>
</ul>
</div>
<div class="center-container fragment">
<p>Un contenidor no és una VM, és un procés aïllat que comparteix el kernel del host.</p>
</div>
</section>
<section id="dockerfile-bàsic" class="slide level2 smaller">
<h2>Dockerfile bàsic</h2>
<ul>
<li class="fragment">Crear un fitxer anomenat <code>Dockerfile</code>.</li>
<li class="fragment">Afegeix al fitxer, la imatge per on vols començar:</li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb8-1"><a></a><span class="kw">FROM</span> ubuntu</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li class="fragment">Per construir la imatge, utilitza la comanda:</li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a></a><span class="ex">docker</span> build . <span class="at">-t</span> amsa</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li class="fragment">Aquesta imatge <strong>amsa</strong> té una sola capa, basada en <code>ubuntu</code>.</li>
</ul>
</section>
<section id="dockerfile-amb-més-instruccions" class="slide level2 smaller">
<h2>Dockerfile amb més instruccions</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a></a><span class="ex">FROM</span> ubuntu</span>
<span id="cb10-2"><a></a><span class="ex">RUN</span> apt update <span class="kw">&amp;&amp;</span> <span class="ex">apt</span> install figlet</span>
<span id="cb10-3"><a></a><span class="ex">CMD</span> figlet <span class="st">"amsa"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li class="fragment"><p><code>RUN</code> executa comandes a la imatge base.</p></li>
<li class="fragment"><p><code>CMD</code> defineix la comanda per defecte quan s’executa el contenidor.</p></li>
<li class="fragment"><p>La imatge resultatn tindrà 2 capes:</p>
<ul>
<li class="fragment">Capa base: <code>ubuntu</code></li>
<li class="fragment">Capa RUN: amb <code>figlet</code> instal·lat i les dependències actualitzades.</li>
</ul></li>
</ul>
<div class="center-container fragment">
<p><strong>Ouch! Com és que estic instal·lant sense <code>sudo</code>?</strong></p>
</div>
<aside class="notes">
<ul>
<li>Explica que dins del contenidor, el procés s’executa com a root per defecte.</li>
<li>Això no afecta el sistema host, ja que el contenidor està aïllat.</li>
<li>Però cal tenir cura amb els permisos quan es munten volums o es comparteixen recursos.</li>
</ul>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section id="executant-la-imatge" class="slide level2">
<h2>Executant la imatge</h2>
<ol type="1">
<li class="fragment">Reconstruïm la imatge: <code>docker build . -t amsa</code></li>
<li class="fragment">Executem el contenidor: <code>docker run amsa</code></li>
</ol>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a></a><span class="ex">$</span> docker run amsa</span>
<span id="cb11-2"><a></a></span>
<span id="cb11-3"><a></a>  <span class="ex">__</span> _ _ __ ___  ___  __ _</span>
<span id="cb11-4"><a></a> <span class="ex">/</span> _<span class="kw">`</span> <span class="kw">|</span> <span class="st">'_ ` _ \/ __|/ _` |</span></span>
<span id="cb11-5"><a></a><span class="st">| (_| | | | | | \__ \ (_| |</span></span>
<span id="cb11-6"><a></a><span class="st"> \__,_|_| |_| |_|___/\__,_|</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li class="fragment">Veurem que s’executa la comanda <code>figlet "amsa"</code> i es mostra el text ASCII.</li>
</ul>
</section>
<section id="execució-interactiva" class="slide level2">
<h2>Execució interactiva</h2>
<p>Per executar el contenidor de manera interactiva, utilitzeu: <code>docker run -it amsa bash</code>.</p>
<ul>
<li class="fragment">Aquesta comanda dona al contenidor una terminal interactiva mantenint STDIN obert (-i) i assignant una terminal TTY (-t).</li>
</ul>
<div class="fragment">
<p><code>docker run -it ubuntu</code> us permetrà explorar el sistema de fitxers d’Ubuntu dins del contenidor amb una shell bash, mentre que <code>docker run ubuntu</code> només executa la comanda per defecte i surt.</p>
</div>
</section>
<section id="compartint-fitxers" class="slide level2 smaller">
<h2>Compartint fitxers</h2>
<p>Anem a modificar <code>figlet</code> per mostrar un missatge personalitzat, a partir d’un fitxer local <code>message.txt</code>.</p>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a></a><span class="bu">echo</span> <span class="st">"Hello from amsa!"</span> <span class="op">&gt;</span> message.txt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li class="fragment">COPY <origen> <destí> copia fitxers/directoris del host al sistema de fitxers del contenidor.</destí></origen></li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb13-1"><a></a><span class="kw">FROM</span> ubuntu</span>
<span id="cb13-2"><a></a><span class="kw">COPY</span> message.txt my-message.txt</span>
<span id="cb13-3"><a></a><span class="kw">RUN</span> <span class="ex">apt</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt</span> install <span class="at">-y</span> figlet</span>
<span id="cb13-4"><a></a><span class="kw">CMD</span> <span class="fu">cat</span> my-message.txt <span class="kw">|</span> <span class="ex">figlet</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="center-container fragment">
<p>Cada cop que modifiqueu el fitxer <code>message.txt</code>, haureu de reconstruir la imatge per veure els canvis.</p>
</div>
</section>
<section id="pregunta-1" class="slide level2 smaller">
<h2>Pregunta 1</h2>
<p>Quina és la diferència entre aquests dos Dockerfiles?</p>
<div class="columns">
<div class="column" style="width:50%;">
<h3 id="a">A</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb14-1"><a></a><span class="kw">FROM</span> ubuntu</span>
<span id="cb14-2"><a></a><span class="kw">COPY</span> message.txt my-message.txt</span>
<span id="cb14-3"><a></a><span class="kw">RUN</span> <span class="ex">apt</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt</span> install <span class="at">-y</span> figlet</span>
<span id="cb14-4"><a></a><span class="kw">CMD</span> <span class="fu">cat</span> my-message.txt <span class="kw">|</span> <span class="ex">figlet</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div><div class="column" style="width:50%;">
<h3 id="b">B</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb15-1"><a></a><span class="kw">FROM</span> ubuntu</span>
<span id="cb15-2"><a></a><span class="kw">RUN</span> <span class="ex">apt</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt</span> install <span class="at">-y</span> figlet</span>
<span id="cb15-3"><a></a><span class="kw">COPY</span> message.txt my-message.txt</span>
<span id="cb15-4"><a></a><span class="kw">CMD</span> <span class="fu">cat</span> my-message.txt <span class="kw">|</span> <span class="ex">figlet</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div></div>
<div class="fragment">
<p>Les capes es construeixen en ordre. Si el fitxer <code>message.txt</code> canvia, només la capa que el copia (COPY) es tornarà a construir en el Dockerfile <strong>A</strong>. En el Dockerfile <strong>B</strong>, si <code>message.txt</code> canvia, tota la capa RUN (instal·lació de figlet) també es tornarà a construir, fent el procés més lent.</p>
</div>
</section>
<section id="treballant-amb-python" class="slide level2 smaller">
<h2>Treballant amb python</h2>
<p>Imagine que teniu un projecte amb python amb els fitxers següents:</p>
<pre><code>├── main.py
├── message.txt      # The message we want pfiglet to print
├── requirements.txt # pyfiglet declared as a dependency
└── .venv            # The python virtual env</code></pre>
<p>on el <code>main.py</code> conté:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a></a><span class="im">from</span> pyfiglet <span class="im">import</span> Figlet</span>
<span id="cb17-2"><a></a></span>
<span id="cb17-3"><a></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"message.txt"</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb17-4"><a></a>  <span class="bu">print</span>(Figlet().renderText(<span class="bu">file</span>.read()))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="dockerfile-per-a-laplicació-python" class="slide level2 smaller">
<h2>Dockerfile per a l’aplicació Python</h2>
<ul>
<li class="fragment">Normalment, per executar-ho sense contenidors, faríem:</li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a></a><span class="ex">python</span> <span class="at">-m</span> venv .venv</span>
<span id="cb18-2"><a></a><span class="bu">source</span> .venv/bin/activate</span>
<span id="cb18-3"><a></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb18-4"><a></a><span class="ex">python</span> main.py</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li class="fragment">Però amb Docker, podem crear un Dockerfile així:</li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb19-1"><a></a><span class="kw">FROM</span> python</span>
<span id="cb19-2"><a></a><span class="kw">COPY</span> main.py main.py</span>
<span id="cb19-3"><a></a><span class="kw">COPY</span> message.txt message.txt</span>
<span id="cb19-4"><a></a><span class="kw">COPY</span> requirements.txt requirements.txt</span>
<span id="cb19-5"><a></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb19-6"><a></a><span class="kw">CMD</span> <span class="ex">python</span> main.py</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="center-container fragment">
<p>Com és que no estem utilitzant un entorn virtual <code>.venv</code> dins del contenidor?</p>
</div>
<aside class="notes">
<ul>
<li>Explica que dins del contenidor, el sistema està aïllat.</li>
<li>No hi ha conflictes amb altres aplicacions o versions de Python.</li>
<li>Per això, no és necessari utilitzar un entorn virtual dins del contenidor.</li>
</ul>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section id="copy-.-." class="slide level2 smaller">
<h2><code>COPY . .</code></h2>
<ul>
<li class="fragment">En lloc de copiar fitxer per fitxer, podem copiar tot el directori de treball amb:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb20-1"><a></a><span class="kw">FROM</span> python</span>
<span id="cb20-2"><a></a><span class="kw">COPY</span> . .</span>
<span id="cb20-3"><a></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb20-4"><a></a><span class="kw">CMD</span> <span class="ex">python</span> main.py</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="optimitzant-la-imatge" class="slide level2">
<h2>Optimitzant la imatge</h2>
<ul>
<li class="fragment">Quan es treballa amb contenidors, és important mantenir les imatge tant petites com sigui possible.</li>
<li class="fragment">El contenidor únicament necessita (<code>message.txt</code>, <code>main.py</code>, <code>requirements.txt</code>).</li>
<li class="fragment">Com estem fent <code>COPY . .</code>, també estem copiant el directori <code>.venv</code>, que pot ser molt gran i innecessari dins del contenidor.</li>
</ul>
</section>
<section id="dockerignore" class="slide level2">
<h2>Dockerignore</h2>
<ul>
<li class="fragment">Per evitar copiar fitxers/directoris innecessaris, podem utilitzar un fitxer <code>.dockerignore</code>.</li>
<li class="fragment">Sembla un <code>.gitignore</code>, però per a Docker.</li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a></a><span class="bu">echo</span> <span class="st">".venv"</span> <span class="op">&gt;&gt;</span> .dockerignore</span>
<span id="cb21-2"><a></a><span class="bu">echo</span> <span class="st">"Dockerfile"</span> <span class="op">&gt;&gt;</span> .dockerignore</span>
<span id="cb21-3"><a></a><span class="bu">echo</span> .dockerignore <span class="op">&gt;&gt;</span> .dockerignore</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li class="fragment">Això evitarà que el directori <code>.venv</code>, el <code>Dockerfile</code> i el propi <code>.dockerignore</code> es copiïn a la imatge.</li>
</ul>
</section>
<section id="optimització-final-del-dockerfile" class="slide level2">
<h2>Optimització final del Dockerfile</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb22-1"><a></a><span class="kw">FROM</span> python</span>
<span id="cb22-2"><a></a><span class="kw">COPY</span> . .</span>
<span id="cb22-3"><a></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb22-4"><a></a><span class="kw">CMD</span> <span class="ex">python</span> main.py</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li class="fragment"><strong>Què més es pot optimitzar?</strong></li>
<li class="fragment">Què passa si únicament modifico el fitxer <code>message.txt</code>?</li>
</ul>
</section>
<section id="caché-de-capes" class="slide level2">
<h2>Caché de capes</h2>
<ul>
<li class="fragment">Els projectes reals tenen moltes dependències, i haver de reinstal·lar-les cada cop que un fitxer canvia seria molt lent.</li>
<li class="fragment">És bona pràctica primer copiar només els fitxers necessaris per instal·lar les dependències, i després copiar la resta del projecte:</li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb23-1"><a></a><span class="kw">FROM</span> python</span>
<span id="cb23-2"><a></a><span class="kw">COPY</span> requirements.txt requirements.txt</span>
<span id="cb23-3"><a></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb23-4"><a></a><span class="kw">COPY</span> . .</span>
<span id="cb23-5"><a></a><span class="kw">CMD</span> <span class="ex">python</span> main.py</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<aside class="notes">
<ul>
<li>Explica que així, si només canvia <code>message.txt</code> o <code>main.py</code>, només es tornarà a construir la capa que copia aquests fitxers.</li>
<li>La capa que instal·la les dependències es mantindrà en caché, fent el procés de construcció molt més ràpid.</li>
</ul>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section id="dockerfile-ubuntu" class="slide level2 smaller">
<h2>Dockerfile <code>ubuntu</code></h2>
<p>Si mireu el contingut de la imatge oficial d’<code>ubuntu</code>, veureu que el Dockerfile és així:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb24-1"><a></a><span class="kw">FROM</span> scratch</span>
<span id="cb24-2"><a></a><span class="kw">ADD</span> rootfs-22.04-amd64.tar /</span>
<span id="cb24-3"><a></a><span class="kw">CMD</span> [<span class="st">"/bin/bash"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li class="fragment"><code>FROM scratch</code> indica que aquesta imatge no té cap capa base (és buida).</li>
<li class="fragment"><code>ADD rootfs-22.04-amd64.tar /</code> semblant a <code>COPY</code>, però amb més funcionalitats, per exemple, pot descomprimir arxius.</li>
<li class="fragment"><code>CMD ["/bin/bash"]</code> estableix la comanda per defecte quan s’executa el contenidor.</li>
</ul>
<div class="center-container fragment">
<p>Quina diferència hi ha entre <code>CMD["/bin/bash"]</code> i <code>CMD /bin/bash</code>? És el mateix?</p>
</div>
<aside class="notes">
<ul>
<li>Explica que la primera forma és la forma exec (recomanada), on s’executa directament el binari sense passar per un shell.</li>
<li>La segona forma és la forma shell, on s’executa a través d’un shell (com <code>/bin/sh -c</code>).</li>
<li>La forma exec és més eficient i evita problemes amb senyals i processos fills.</li>
</ul>
<style type="text/css">
        span.MJX_Assistive_MathML {
          position:absolute!important;
          clip: rect(1px, 1px, 1px, 1px);
          padding: 1px 0 0 0!important;
          border: 0!important;
          height: 1px!important;
          width: 1px!important;
          overflow: hidden!important;
          display:block!important;
      }</style></aside>
</section>
<section id="exercici-1-contenidor-amb-dependències" class="slide level2">
<h2>Exercici 1: Contenidor amb dependències</h2>
<p>Imagineu que executeu la comanda següent:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a></a><span class="ex">docker</span> run python:3.9 python <span class="at">-c</span> <span class="st">"import numpy as np; print(np.random.rand())"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Explica què passa?</p>
</section>
<section id="exercici-1-contenidor-amb-dependències-solució" class="slide level2">
<h2>Exercici 1: Contenidor amb dependències (solució)</h2>
<p>La imatge oficial de <code>python:3.9</code> no inclou la llibreria NumPy per defecte. Per tant, quan s’intenta executar el codi Python que importa NumPy, es produeix un error perquè la llibreria no està instal·lada dins del contenidor.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb26-1"><a></a><span class="kw">FROM</span> python:3.9</span>
<span id="cb26-2"><a></a><span class="kw">RUN</span> <span class="ex">pip</span> install numpy</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="exercici-2-compartint-dades" class="slide level2">
<h2>Exercici 2: Compartint dades</h2>
<p>Imagina que tens un script de Python anomenat <code>hola.py</code> al teu sistema host amb el següent contingut:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a></a><span class="bu">print</span>(<span class="st">"Hola món!"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Vols executar aquest script dins d’un contenidor Docker basat en la imatge oficial de Python 3.9. Com ho faries?</p>
</section>
<section id="exercici-2-compartint-dades-solució-1" class="slide level2">
<h2>Exercici 2: Compartint dades (solució 1)</h2>
<p>Creariam un dockerfile per a la nostra aplicació Python:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb28-1"><a></a><span class="kw">FROM</span> python:3.9</span>
<span id="cb28-2"><a></a><span class="kw">COPY</span> hola.py hola.py</span>
<span id="cb28-3"><a></a><span class="kw">CMD</span> <span class="ex">python</span> hola.py</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="exercici-3-compartint-dades-de-sortida" class="slide level2">
<h2>Exercici 3: Compartint dades de sortida</h2>
<p>Però, i si volem que el script <code>hola.py</code> escrigui un fitxer de sortida anomenat <code>sortida.txt</code> dins del sistema host? Com ho faríem?</p>
</section>
<section id="compartint-dades-amb-un-contenidor-docker" class="slide level2">
<h2>Compartint dades amb un contenidor Docker</h2>
<p>Per compartir dades estàtiques estem utiltizant la instrucció <code>COPY</code> al Dockerfile. Però, i si volem compartir dades dinàmiques entre el sistema host i el contenidor, com els fitxers de sortida generats pel contenidor?</p>
<p>Cal compartir un directori o fitxer entre el sistema host i el contenidor. Per això, utilitzarem l’opció <code>-v</code> de la comanda <code>docker run</code>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a></a><span class="ex">docker</span> run <span class="at">-v</span> <span class="op">&lt;</span>directori_host<span class="op">&gt;</span>:<span class="op">&lt;</span>directori_contenidor<span class="op">&gt;</span> <span class="op">&lt;</span>imatge<span class="op">&gt;</span> <span class="op">&lt;</span>comanda<span class="op">&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="quins-són-els-directoris-del-contenidor" class="slide level2 smaller">
<h2>Quins són els directoris del contenidor?</h2>
<ul>
<li class="fragment">Podem utilitzar la comanda <code>docker run -it &lt;imatge&gt; bash</code> per accedir a la consola del contenidor i explorar el sistema de fitxers.</li>
<li class="fragment">Un cop dins, podem utilitzar comandes com <code>ls</code>, <code>pwd</code> i <code>cd</code> per navegar pels directoris.</li>
<li class="fragment">Alguns directoris comuns són:
<ul>
<li class="fragment"><code>/app</code>: sovint utilitzat com a directori de treball per a aplicacions.</li>
<li class="fragment"><code>/data</code>: sovint utilitzat per emmagatzemar dades persistents.</li>
<li class="fragment"><code>/tmp</code>: directori temporal.</li>
</ul></li>
</ul>
</section>
<section id="workdir" class="slide level2 smaller">
<h2><code>WORKDIR</code></h2>
<ul>
<li class="fragment">La instrucció <code>WORKDIR</code> al Dockerfile estableix el directori de treball per a qualsevol comanda següent (<code>RUN</code>, <code>CMD</code>, <code>ENTRYPOINT</code>, <code>COPY</code>, <code>ADD</code>).</li>
<li class="fragment">Si el directori no existeix, Docker el crearà automàticament.</li>
<li class="fragment">Per exemple:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb30-1"><a></a><span class="kw">FROM</span> python:3.9</span>
<span id="cb30-2"><a></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb30-3"><a></a><span class="kw">COPY</span> hola.py .</span>
<span id="cb30-4"><a></a><span class="kw">CMD</span> <span class="ex">python</span> hola.py</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="exericici-3-compartint-dades-de-sortida-solució" class="slide level2">
<h2>Exericici 3: Compartint dades de sortida (solució)</h2>
<p>Primer, crearem un script <code>hola2.py</code> que escriu un fitxer de sortida:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a></a>output <span class="op">=</span> <span class="bu">open</span>(<span class="st">"sortida.txt"</span>, <span class="st">"w"</span>)</span>
<span id="cb31-2"><a></a>output.write(<span class="st">"Hola món!"</span>)</span>
<span id="cb31-3"><a></a>output.close()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Després, executarem el contenidor Docker amb l’opció <code>-v</code> per compartir el directori actual del sistema host amb el directori <code>/app</code> del contenidor:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a></a><span class="ex">docker</span> run <span class="at">-v</span> <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>:/app python:3.9 python /app/hola2.py</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="taula-de-comandes-útils-de-docker" class="slide level2 smaller">
<h2>Taula de comandes útils de Docker</h2>
<table class="caption-top">
<colgroup>
<col style="width: 39%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th>Comanda</th>
<th>Descripció</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>docker build -t &lt;nom&gt; .</code></td>
<td>Construir una imatge des del Dockerfile actual.</td>
</tr>
<tr class="even">
<td><code>docker run &lt;imatge&gt;</code></td>
<td>Executar un contenidor des d’una imatge.</td>
</tr>
<tr class="odd">
<td><code>docker run -it &lt;imatge&gt; bash</code></td>
<td>Executar un contenidor en mode interactiu amb una shell.</td>
</tr>
<tr class="even">
<td><code>docker ps</code></td>
<td>Llistar els contenidors en execució.</td>
</tr>
<tr class="odd">
<td><code>docker stop &lt;contenidor&gt;</code></td>
<td>Aturar un contenidor en execució.</td>
</tr>
<tr class="even">
<td><code>docker rm &lt;contenidor&gt;</code></td>
<td>Eliminar un contenidor aturat.</td>
</tr>
<tr class="odd">
<td><code>docker rmi &lt;imatge&gt;</code></td>
<td>Eliminar una imatge.</td>
</tr>
<tr class="even">
<td><code>docker images</code></td>
<td>Llistar les imatges disponibles.</td>
</tr>
<tr class="odd">
<td><code>docker logs &lt;contenidor&gt;</code></td>
<td>Veure els logs d’un contenidor.</td>
</tr>
<tr class="even">
<td><code>docker inspect &lt;imatge/contenidor&gt;</code></td>
<td>Veure els detalls d’una imatge o contenidor.</td>
</tr>
</tbody>
</table>
</section>
<section id="xarxes-i-contenidors" class="slide level2">
<h2>Xarxes i Contenidors</h2>
<p>Imagineu que tenim un servidor web molt simple:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a></a>python <span class="op">-</span>m http.server <span class="op">&lt;</span>port<span class="op">&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Si executem aquesta comanda exposarem els fitxers a una interfície de xarxa del host.</p>

<img data-src="../figs/slides/04-virt/python-webserver.png" class="r-stretch"></section>
<section id="contenidor-amb-servidor-web" class="slide level2">
<h2>Contenidor amb servidor web</h2>
<ol type="1">
<li class="fragment">Creem un Dockerfile per al servidor web:</li>
</ol>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb34-1"><a></a><span class="kw">FROM</span> python</span>
<span id="cb34-2"><a></a><span class="kw">CMD</span> [<span class="st">"python"</span>, <span class="st">"-m"</span>, <span class="st">"http.server"</span>, <span class="st">"8080"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ol start="2" type="1">
<li class="fragment">Construïm la imatge i executem el contenidor:</li>
</ol>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a></a><span class="ex">docker</span> build . <span class="at">-t</span> amsa</span>
<span id="cb35-2"><a></a><span class="ex">docker</span> run AMSA</span>
<span id="cb35-3"><a></a><span class="ex">Serving</span> HTTP on 0.0.0.0 port 8080 <span class="er">(</span><span class="ex">http://0.0.0.0:8080/</span><span class="kw">)</span> <span class="ex">...</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="center-container fragment">
<p>Si accedim a <code>http://localhost:8080</code> des del host, no veurem res!</p>
</div>
</section>
<section id="per-què-no-funciona" class="slide level2">
<h2>Per què no funciona?</h2>
<ul>
<li class="fragment">Els contenidors per defecte estan aïllats.</li>
<li class="fragment">A part del seu sistema de fitxers propri, també tenen la seva pròpia pila de xarxa.</li>
<li class="fragment">El port 8080 del contenidor no és el port 8080 de la màquina host.</li>
</ul>
</section>
<section id="mapeig-de-ports" class="slide level2">
<h2>Mapeig de ports</h2>
<ul>
<li class="fragment">Per accedir als serveis d’un contenidor des del host, cal fer un <strong>mapeig de ports</strong>.</li>
<li class="fragment">Utilitzem l’opció <code>-p</code> de <code>docker run</code> per mapar un port del host a un port del contenidor:</li>
</ul>
<div class="fragment">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a></a><span class="ex">docker</span> run <span class="at">-p</span> 8085:8080 amsa</span>
<span id="cb36-2"><a></a><span class="ex">Serving</span> HTTP on 0.0.0.0 port 8080 <span class="er">(</span><span class="ex">http://0.0.0.0:8080/</span><span class="kw">)</span> <span class="ex">...</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li class="fragment">La sintaxi és <code>-p &lt;port_host&gt;:&lt;port_contenidor&gt;</code>, on ara podem accedir al servidor web a <code>http://localhost:8085</code>.</li>
</ul>
</section>
<section id="exercicis" class="slide level2">
<h2>Exercicis</h2>
<ul>
<li class="fragment"><a href="../exercises/05-virtualitzation/01-docker.html">Exercicis de Contenidors Docker</a></li>
</ul>


</section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">
<p>Unitat 5 · Administració i Manteniment de Sistemes i Aplicacions (AMSA) <a href="../index.html">🏠</a></p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'fade',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
          const outerScaffold = trigger.parentElement.cloneNode(true);
          const codeEl = outerScaffold.querySelector('code');
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp("https:\/\/amsa-gei-udl-2526-105013\.github\.io\/course\/");
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>