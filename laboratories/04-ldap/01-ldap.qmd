---
title: "Gesti√≥ centralitzada d'usuaris utiltizant LDAP"
---

## üéØ Objectius del laboratori

En aquest laboratori desplegarem i configurarem una infraestructura LDAP completa utilitzant tres inst√†ncies EC2 a AWS Academy. L‚Äôobjectiu √©s entendre tant el funcionament intern d‚Äôun servei d‚Äôautenticaci√≥ centralitzada com la seva integraci√≥ amb clients Linux i eines d‚Äôadministraci√≥.

## üèóÔ∏è Infraestructura a desplegar

Treballarem amb tres m√†quines virtuals:

- **Servidor LDAP (OpenLDAP)** : Gestionar√† el directori, usuaris, grups i esquemes.
- **Client LDAP + SSSD**: Permetr√† que els usuaris definits al directori es puguin autenticar al sistema Linux.
- **Servidor web LAM (LDAP Account Manager)**: Oferir√† una interf√≠cie gr√†fica per administrar el directori de manera senzilla.

## üß† Qu√® aprendr√†s en aquest laboratori?

En finalitzar el laboratori ser√†s capa√ß de:

- Comprendre l‚Äôarquitectura i els components b√†sics d‚Äôun sistema LDAP.
- Instal¬∑lar i configurar OpenLDAP en un servidor Linux.
- Activar TLS/SSL i utilitzar LDAPS (port 636) per a connexions segures.
- Crear i gestionar usuaris, grups i unitats organitzatives (OU) al directori.
- Configurar un client Linux perqu√® utilitzi LDAP per autenticar usuaris (PAM + SSSD).
- Utilitzar LDAP Account Manager (LAM) per administrar visualment el directori.
- Verificar que un usuari creat al directori pot iniciar sessi√≥ al client Linux.

## üìå Resultats esperats

En acabar haur√†s desplegat un entorn funcional que simula un sistema d'autenticaci√≥ corporatiu, tal com es trobaria en una infraestructura real d‚Äôempresa.

---

## üß© Requisits per comen√ßar el laboratori

Per completar aquest laboratori necessitareu tres inst√†ncies EC2 que formaran la infraestructura LDAP. Utilitzarem Amazon Linux 2023, ja que √©s estable, lleuger i compatible amb les eines necess√†ries.

| Rol               | Nom recomanat          | Ports oberts | Programari necessari                            |
| ----------------- | ---------------------- | ------------ | ----------------------------------------------- |
| **Servidor LDAP** | `OpenLDAP-AMSA-Server` | 22, 389, 636 | OpenLDAP instal¬∑lat i configurat amb TLS/SSL    |
| **Client LDAP**   | `LDAP-Client`          | 22           | SSSD, Paquets `openldap-clients`                |
| **Servidor LAM**  | `LAM-WebServer`        | 22, 80       | Apache HTTPD + PHP + LDAP Account Manager (LAM) |


### üîê Grups de seguretat (Security Groups)

- **Regles d'entrada**:

| Rol               | Ports necessaris oberts                      |
| ----------------- | -------------------------------------------- |
| **Servidor LDAP** | SSH (22/tcp), LDAP (389/tcp), LDAPS (636/tcp)|
| **Client LDAP**   | SSH (22/tcp)                                 |
| **Servidor LAM**  | SSH (22/tcp), HTTP (80/tcp)                  |

- **Regles de sortida**: Totes per defecte (Allow All).




::: {.callout-tip}
## Checkpoint (‚úî)
Verifica que:

- Les 3 inst√†ncies EC2 estan creades. Apunta el DNS p√∫blic de cadascuna.
- Assegura't que pots connectar-te via SSH a cada inst√†ncia.
- Cada servei t√© els ports necessaris oberts al seu Security Group. Per comprovar-ho pots fer servir la comanda `nc -zv <IP_SERVIDOR> <PORT>`.

:::



## PART I ‚Äì Configuraci√≥ del servidor OpenLDAP

### üõ†Ô∏è Instal¬∑laci√≥ d‚Äôeines i depend√®ncies

Segons el manual oficial d‚Äôinstal¬∑laci√≥ [manual d'instal¬∑laci√≥](https://www.openldap.org/doc/admin26/install.html), OpenLDAP requereix un conjunt de biblioteques i eines per poder compilar:

- Compilador C (gcc)
- OpenSSL ‚Üí necessari per TLS/SSL
- Cyrus SASL ‚Üí suport d‚Äôautenticaci√≥ avan√ßada
- libevent ‚Üí millora del rendiment en gesti√≥ d‚Äôesdeveniments
- libargon2 / libsodium ‚Üí hashing de contrasenyes
- Eines de compilaci√≥: make, autoconf, libtool

```bash
sudo dnf install \
cyrus-sasl-devel make libtool autoconf libtool-ltdl-devel \
openssl-devel libdb-devel tar gcc perl perl-devel wget vim -y
```

### üì¶ Descarregar i descomprimir OpenLDAP


Descarregarem el paquet des de la p√†gina oficial mitjan√ßant FTP i el descomprimirem:

```bash
VER="2.6.3"
cd /tmp
wget ftp://ftp.openldap.org/pub/OpenLDAP/openldap-release/openldap-$VER.tgz
tar xzf openldap-$VER.tgz
cd openldap-$VER
```

::: {.callout-note title="`/tmp?`"}
`/tmp`: √âs un directori temporal, ideal per compilar programari sense embrutar el sistema. Un cop reiniciem, tot el que hi ha a `/tmp` es perd.
:::

::: {.callout-tip}
## Checkpoint (‚úî)
- `pwd` ha de mostrar `/tmp/openldap-2.6.3`.
- `ls -lah /tmp/openldap-2.6.3` ha de llistar els fitxers font d'OpenLDAP.
:::


### ‚öôÔ∏è Configuraci√≥ i instal¬∑laci√≥ d‚ÄôOpenLDAP

Un cop descarregat el codi font, procedirem a configurar, compilar i instal¬∑lar OpenLDAP. Aquest proc√©s ens permet controlar exactament quines funcionalitats tindr√† el servidor.

1. Configurem el paquet amb les opcions que necessitem:

    ```bash
    ./configure --prefix=/usr --sysconfdir=/etc --disable-static \
    --enable-debug --with-tls=openssl --with-cyrus-sasl --enable-dynamic \
    --enable-crypt --enable-spasswd --enable-slapd --enable-modules \
    --enable-rlookups  --disable-sql  \
    --enable-ppolicy --enable-syslog
    ```

   - `--prefix=/usr` ‚Üí OpenLDAP s'instal¬∑lar√† sota /usr (no /usr/local).
   - `--sysconfdir=/etc` ‚Üí Fitxers de configuraci√≥ a /etc/openldap.
   - `--with-tls=openssl` ‚Üí Activa TLS/SSL (LDAPS).
   - `--enable-slapd` ‚Üí Construeix el servidor LDAP.
   - `--enable-modules` ‚Üí Permet c√†rrega din√†mica de m√≤duls.
   - `--enable-ppolicy` ‚Üí Suport de pol√≠tiques de contrasenyes.
   - `--enable-debug` ‚Üí √ötil en entorns docents.

2. Compilem i instal¬∑lem el paquet:

    ```bash
    sudo make depend
    sudo make
    ```
  
::: {.callout-warning title="Dev/Prod"}
El comandament `make test` executa proves d‚Äôintegritat, per√≤ pot trigar for√ßa estona i no √©s necessari en aquest laboratori. En producci√≥, s√≠ que es recomana.
:::

1. Compilem els m√≤duls addicionals per suportar SHA-2: Per defecte, OpenLDAP utilitza SHA-1, que avui dia √©s insuficientment segur. Activarem suport per a SHA-256, SHA-384 i SHA-512.

    ```bash
    cd contrib/slapd-modules/passwd/sha2
    sudo make
    ```

2. Instal¬∑lem el servidor OpenLDAP:

    ```bash
    cd ../../../.. # Tornem a la carpeta inicial
    sudo make install
    ```
  
  Aquesta comanda instal¬∑lar√†:
     - el servidor **slapd**
     - eines d'administraci√≥ (`ldapadd`, `ldapsearch`, etc.)
     - configuraci√≥ base a `/etc/openldap/`

5. Instal¬∑lem els m√≤duls addicionals relacionats amb SHA-2:

    ```bash
    cd contrib/slapd-modules/passwd/sha2
    sudo make install
    ```

En aquest punt, si tot ha anat b√©, ja tindrem el servidor LDAP instal¬∑lat  al nostre servidor. Podeu comprovar:

- Els fitxers de configuraci√≥ a `/etc/openldap/`:
  
    ```bash
    sudo ls -la /etc/openldap/
    ```

- Els m√≤duls instal¬∑lats a `/usr/local/libexec/openldap/`:

    ```bash
    sudo ls -la /usr/local/libexec/openldap/
    # (o /usr/libexec/openldap/ si la vostra configuraci√≥ aix√≠ ho ha definit).
    ```

::: {.callout-tip}
## Checkpoint (‚úî)
Assegura't que la instal¬∑laci√≥ ha anat b√©:

- Verifica que existeix el directori `/etc/openldap`.
- Verifica que existeix el directori `/usr/local/libexec/openldap`.
- Verifica que existeix `/usr/local/libexec/openldap/pw-sha2.la`.
- Verifica `slapd -VV` per veure la versi√≥ i els m√≤duls carregats.
  
Si tot √©s correcte, ja tens OpenLDAP instal¬∑lat i llest per configurar.
:::

### üîê Generaci√≥ de contrasenyes amb SHA-512 (SSHA-512)

Un cop instal¬∑lats els m√≤duls SHA-2, podem generar contrasenyes utilitzant l‚Äôalgorisme SSHA-512, que √©s molt m√©s segur que el tradicional SHA-1. Aquest tipus de hash √©s el que s‚Äôutilitzar√† per emmagatzemar contrasenyes dins del directori LDAP.

#### üõ†Ô∏è Generaci√≥ del hash amb `slappasswd`

Utiltizarem la comanda `slappasswd` on cal indicar:

- quin algorisme de hash volem utilitzar (`-h "{SSHA512}"`), en aquest cas SHA-512.
- els m√≤duls que implementen aquest algorisme (`-o module-load=pw-sha2.la`).
- la ruta on es troben aquests m√≤duls (`-o module-path=/usr/local/libexec/openldap`).

```sh
slappasswd -h "{SSHA512}" -o module-load=pw-sha2.la -o module-path=/usr/local/libexec/openldap
```

#### üîë Introducci√≥ de la contrasenya

Quan executeu la comanda, se us demanar√† la contrasenya:

```sh
New password: ********
Re-enter new password: ********
```

::: {.callout-caution title="Seguretat de la contrasenya"}
En l‚Äôexemple del laboratori utilitzem 1234 per simplicitat, per√≤ en entorns reals aix√≤ seria extremadament insegur.
:::

#### üßÆ Exemple de resultat

El resultat generat ser√† un hash llarg similar al seg√ºent:

```sh
{SSHA512}CBVaUdQC9mVvAi+0O92J3hA+aPdiWUqf4lVr6bGRAUsFJX5aFOEb+1pSsY8PQwW1UKuuCGO2+160HotnfjXIaRKlryVekLnu
```

Aquesta cadena √©s el valor que es pot inserir al directori LDAP en atributs com **userPassword**.

### ‚öôÔ∏è Configuraci√≥ del servei `slapd.service`

√âs una bona pr√†ctica de seguretat que qualsevol servei del sistema s‚Äôexecuti amb un usuari propi i amb permisos m√≠nims. Aix√≤ evita que un possible atac comprometi tot el sistema. El servidor LDAP (`slapd`) no ha de ser executat com a **root**. En lloc d‚Äôaix√≤, crearem un usuari dedicat i un grup dedicat amb permisos estrictament limitats.

Crearem un grup de sistema anomenat ldap amb un GID fixat:

```sh
sudo groupadd -g 55 ldap
```

:::{.callout-note title="Per qu√® gid 55?"}
El GID 55 √©s una convenci√≥ comuna per al grup ldap en moltes distribucions Linux. Utilitzar un GID fixat ajuda a mantenir la coher√®ncia entre diferents sistemes i facilita la gesti√≥ d'usuaris i permisos relacionats amb el servei LDAP. Facilita tamb√© la migraci√≥ o sincronitzaci√≥ de dades entre sistemes.
:::

Crearem un usuari per al servei LDAP:

```sh
sudo useradd -r -M -d /var/lib/openldap -u 55 -g 55 -s /usr/sbin/nologin ldap
```

- `-r` ‚Üí crea un usuari de sistema (sense entrada en `/etc/login.defs`).
- `-M` ‚Üí no crea directori home (evita carpetes innecess√†ries).
- `-d /var/lib/openldap` ‚Üí defineix el directori ‚Äúbase‚Äù del servei.
- `-u 55` ‚Üí UID espec√≠fic, alineat amb el GID creat.
- `-g 55` ‚Üí assigna el grup ldap.
- `-s /usr/sbin/nologin` ‚Üí impedeix que l‚Äôusuari inici√Ø sessi√≥ interactiva.

:::{.callout-note title="**Least Privilege Principle**"}
El servei LDAP tindr√† nom√©s els permisos que necessiti, i res m√©s. 
:::

### ‚öôÔ∏è Configuraci√≥ del servei LDAP

#### üìÅ Creaci√≥ dels directoris necessaris

OpenLDAP utilitza dos elements importants:

- **Directori de dades** ‚Üí cont√© la base de dades i el PID del servei
- **Directori de configuraci√≥ slapd.d** ‚Üí cont√© la configuraci√≥ din√†mica generada per slapadd i slapd

Creem-los:

```bash
sudo mkdir -p /var/lib/openldap
sudo mkdir -p /etc/openldap/slapd.d
```

#### üõ°Ô∏è Assignaci√≥ de permisos

##### Assignaci√≥ de permisos al directori de dades

Com hem creat abans l'usuari i grup ldap, ara assignarem permisos correctes.

```bash
sudo chown -R ldap:ldap /var/lib/openldap
```

Aix√≤ permet que el servei pugui crear els fitxers de BD, sockets i el PID.

##### Permisos al fitxer de configuraci√≥

```bash
sudo chown root:ldap /etc/openldap/slapd.conf
sudo chmod 640 /etc/openldap/slapd.conf
```

El fitxer de configuraci√≥ ha de ser propietat de root, per√≤ el grup ldap ha de tenir permisos de lectura. Aix√≤ permet que el servei pugui llegir la configuraci√≥, per√≤ evita que altres usuaris no autoritzats hi accedeixin. Els permisos 640 signifiquen: el propietari (root) t√© permisos de lectura i escriptura, el grup (ldap) t√© permisos de lectura, i altres usuaris no tenen cap perm√≠s.

#### üõ†Ô∏è Creaci√≥ del fitxer de servei Systemd

Ara crearem un servei slapd.service perqu√® OpenLDAP s‚Äôintegri amb systemd i pugui arrencar autom√†ticament amb el sistema.

```bash
sudo bash -c "cat > /etc/systemd/system/slapd.service << 'EOL'
[Unit]
Description=OpenLDAP Server Daemon
After=syslog.target network-online.target
Documentation=man:slapd
Documentation=man:slapd-mdb

[Service]
Type=forking
PIDFile=/var/lib/openldap/slapd.pid
Environment=\"SLAPD_URLS=ldap:/// ldapi:/// ldaps:///\"
Environment=\"SLAPD_OPTIONS=-F /etc/openldap/slapd.d\"
ExecStart=/usr/libexec/slapd -u ldap -g ldap -h \${SLAPD_URLS} \$SLAPD_OPTIONS

[Install]
WantedBy=multi-user.target
EOL"
```

En la secci√≥ **[Unit]** definim el nom i les depend√®ncies del servei. El directiu `After=syslog.target network-online.target` garanteix que `slapd` no s‚Äôinici√Ø fins que el sistema de registre (`syslog`) i la connexi√≥ de xarxa estiguin plenament operatius.

En la secci√≥ **[Service]** especifiquem que el servei √©s de tipus *forking*, ja que el dimoni slapd es bifurca i continua executant-se en segon pla. Tamb√© indiquem el fitxer PID que *systemd* utilitzar√† per controlar el proc√©s, les variables d‚Äôentorn i la comanda d‚Äôinici.
La variable `SLAPD_URLS` defineix les URL on el servidor escoltar√† connexions:

- ldap:/// ‚Üí LDAP per TCP (port 389)
- ldapi:/// ‚Üí socket Unix local
- ldaps:/// ‚Üí LDAP sobre TLS (port 636)
  
La variable `SLAPD_OPTIONS` especifica la ubicaci√≥ del directori de configuraci√≥ din√†mica (`slapd.d`), que √©s el m√®tode modern de configuraci√≥ d‚ÄôOpenLDAP.

Finalment, en la secci√≥ **[Install]** indiquem que el servei ha d‚Äôactivar-se autom√†ticament en l‚Äôobjectiu `multi-user.target`, que correspon al nivell d‚Äôexecuci√≥ t√≠pic en servidors Linux.

:::{.callout-tip title="Abans d'iniciar el servei"}
Una bona pr√†ctica √©s reinciar **systemd** per informar-lo dels nous serveis creats: `sudo systemctl daemon-reload`.
:::


## üß© Creaci√≥ de la base de dades de configuraci√≥ (`cn=config`)

Abans que `slapd` pugui funcionar, cal inicialitzar la base de dades de configuraci√≥ din√†mica d‚ÄôOpenLDAP. Aquesta configuraci√≥ √©s diferent de la base de dades de dades (on viuran els usuaris) i s‚Äôanomena `cn=config`.

`cn=config` funciona com una BD LDAP normal:
- tot s√≥n objectes‚Ä¶
- cada objecte t√© un DN‚Ä¶
- i cada DN t√© objectClasses i atributs.

Aquesta estructura substitueix l‚Äôantic slapd.conf, i √©s molt m√©s flexible.

### Conceptes

#### Configuraci√≥ global (`dn: cn=config`)

El **dn** indica el nom distintiu de l‚Äôobjecte dins de l‚Äôarbre LDAP. En aquest cas, `cn=config` √©s el nom distintiu per a la configuraci√≥ global del servidor LDAP. Defineix par√†metres generals que afecten tot el servidor:

- Rutes per als fitxers de PID i arguments (.pid, .args)
- Configuraci√≥ TLS m√≠nima
- Pol√≠tica general del dimoni

#### M√≤duls (`dn: cn=module,cn=config`)

Els m√≤duls s√≥n components addicionals que amplien la funcionalitat del servidor LDAP. En aquest cas, carreguem:

- back_mdb.la ‚Üí el backend de base de dades MDB (el m√©s modern i recomanat)
- pw-sha2.la ‚Üí suport de contrasenyes SHA-256/384/512
- ‚ö†Ô∏è Nota: El m√≤dul pw-sha2.la pot estar a /usr/libexec/openldap o /usr/local/libexec/openldap segons la compilaci√≥. Per aix√≤ el fitxer defineix dues entrades.

#### Esquemes ‚Äî `cn=schema,cn=config`

Els esquemes defineixen quins objectes i atributs existeixen en el directori. En aquest cas, carreguem els esquemes t√≠pics:

- **core**: objectes b√†sics (person, organization, organizationalUnit, etc.)
- **cosine**: amplia atributs i objectes est√†ndard
- **nis**: atributs relacionats amb usuaris i grups d‚Äôestil Unix/NIS
- **inetorgperson**: l‚Äôesquema m√©s utilitzat per comptes d‚Äôusuari moderns (mail, telephoneNumber, etc.)

#### Frontend ‚Äî `dn: olcDatabase=frontend,cn=config`

Controla com s‚Äôaccedeixen totes les BDs. Nosaltres definirem:

- Quin hash utilitzar per defecte ‚Üí {SSHA512}
- Permisos:
  - tothom pot llegir cn=Subschema
  - root local UNIX (peercred) pot administrar TOT

#### Base de dades de configuraci√≥ ‚Äî `dn: olcDatabase=config,cn=config`

Defineix permisos acl per accedir al propi `cn=config`. 

### üìÑ Creaci√≥ del fitxer /etc/openldap/slapd.ldif

Aquest LDIF cont√© tota la configuraci√≥ inicial de slapd. El crearem aix√≠:

```bash
sudo bash -c "cat > /etc/openldap/slapd.ldif << 'EOL'
dn: cn=config
objectClass: olcGlobal
cn: config
olcArgsFile: /var/lib/openldap/slapd.args
olcPidFile: /var/lib/openldap/slapd.pid
olcTLSCipherSuite: TLSv1.2:HIGH:\!aNULL:\!eNULL
olcTLSProtocolMin: 3.3

dn: cn=schema,cn=config
objectClass: olcSchemaConfig
cn: schema

dn: cn=module,cn=config
objectClass: olcModuleList
cn: module
olcModulepath: /usr/libexec/openldap
olcModuleload: back_mdb.la

dn: cn=module,cn=config
objectClass: olcModuleList
cn: module
olcModulepath: /usr/local/libexec/openldap
olcModuleload: pw-sha2.la

include: file:///etc/openldap/schema/core.ldif
include: file:///etc/openldap/schema/cosine.ldif
include: file:///etc/openldap/schema/nis.ldif
include: file:///etc/openldap/schema/inetorgperson.ldif

dn: olcDatabase=frontend,cn=config
objectClass: olcDatabaseConfig
objectClass: olcFrontendConfig
olcDatabase: frontend
olcPasswordHash: {SSHA512}CBVaUdQC9mVvAi+0O92J3hA+aPdiWUqf4lVr6bGRAUsFJX5aFOEb+1pSsY8PQwW1UKuuCGO2+160HotnfjXIaRKlryVekLnu
olcAccess: to dn.base=\"cn=Subschema\" by * read
olcAccess: to *
  by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth\" manage
  by * none

dn: olcDatabase=config,cn=config
objectClass: olcDatabaseConfig
olcDatabase: config
olcRootDN: cn=config
olcAccess: to *
  by dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth\" manage
  by * none
EOL"
```

El script anterior t√© un problema: `olcTLSCipherSuite: TLSv1.2:HIGH:\!aNULL:\!eNULL` cont√© car√†cters especials (`\!`) per eliminar-los feu:

```bash
sudo sed -i 's/olcTLSCipherSuite: TLSv1\.2:HIGH:\\!aNULL:\\!eNULL/olcTLSCipherSuite: TLSv1.2:HIGH:!aNULL:!eNULL/' /etc/openldap/slapd.ldif
```


### üèóÔ∏è Carregar la configuraci√≥ inicial (cn=config) al servidor LDAP

En aquest punt, ja hem creat el fitxer `slapd.ldif` que descriu tota la configuraci√≥ del servidor LDAP:

 - par√†metres globals
 - m√≤duls i esquemes
 - ACL i bases de dades internes

Ara cal carregar aquesta configuraci√≥ dins la base de dades `cn=config` utilitzant l‚Äôeina `slapadd`.

#### Pas 1 ‚Äî Carregar la configuraci√≥ amb `slapadd`

```bash
cd /etc/openldap/
sudo slapadd -n 0 -F /etc/openldap/slapd.d -l /etc/openldap/slapd.ldif
sudo chown -R ldap:ldap /etc/openldap/slapd.d
```

- `slapadd` ‚Üí importa dades directament a una base de dades LDAP sense passar pel servidor.
- `-n 0` ‚Üí indica que volem modificar la base n√∫mero 0, que sempre correspon a `cn=config`.
- `-F /etc/openldap/slapd.d` ‚Üí defineix el directori on s‚Äôescriuran els fitxers de configuraci√≥ din√†mica.
- `-l slapd.ldif` ‚Üí fitxer amb el contingut que volem carregar.
  
Despr√©s de carregar la configuraci√≥, canviem els permisos perqu√® el servei LDAP (**slapd**) pugui llegir i escriure al directori `slapd.d`.

:::{.callout-warning title="Soluci√≥ d'errors"}
Si es produeix un error, podeu eliminar la base de dades i tornar a carregar la configuraci√≥. Per fer-ho, `sudo rm -rf /etc/openldap/slapd.d/*` i torneu a executar la comanda `slapadd`.
:::

#### Pas 2 ‚Äî Iniciar el servei LDAP

Un cop la base de dades `cn=config` est√† creada, ja podem arrencar `slapd` com a servei **systemd**:

```bash
sudo systemctl enable --now slapd
```

::: {.callout-tip}
## Checkpoint (‚úî)
Verifica que el servei s‚Äôha iniciat correctament:

- Comprova l‚Äôestat del servei amb:  `systemctl status slapd`
:::

### üóÇÔ∏è Configurant l‚Äôestructura de la base de dades del directori

Un cop tenim configurada la base `cn=config`, √©s moment de crear la base de dades LDAP que contindr√† les dades reals: *usuaris, grups i unitats organitzatives*. Aquesta base de dades es defineix mitjan√ßant una entrada dins `cn=config` anomenada: `dn: olcDatabase=mdb,cn=config`. 

#### `rootdn.ldif` ‚Äî Creaci√≥ de l'usuari admin i configuraci√≥ de la base de dades

Crearem un fitxer amb la configuraci√≥ de la base de dades principal i el root admin.

```bash

BASE="dc=amsa,dc=udl,dc=cat"
sudo bash -c "cat << EOL > /etc/openldap/rootdn.ldif
dn: olcDatabase=mdb,cn=config
objectClass: olcDatabaseConfig
objectClass: olcMdbConfig
olcDatabase: mdb
olcDbMaxSize: 42949672960
olcDbDirectory: /var/lib/openldap
olcSuffix: $BASE
olcRootDN: cn=admin,$BASE
olcRootPW: {SSHA512}CBVaUdQC9mVvAi+0O92J3hA+aPdiWUqf4lVr6bGRAUsFJX5aFOEb+1pSsY8PQwW1UKuuCGO2+160HotnfjXIaRKlryVekLnu
olcDbIndex: uid pres,eq
olcDbIndex: cn,sn pres,eq,approx,sub
olcDbIndex: mail pres,eq,sub
olcDbIndex: objectClass pres,eq
olcDbIndex: loginShell pres,eq
olcAccess: to attrs=userPassword,shadowLastChange,shadowExpire
  by self write
  by anonymous auth
  by dn.subtree=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth\" manage
  by dn.subtree=\"ou=system,$BASE\" read
  by * none
olcAccess: to dn.subtree=\"ou=system $BASE\"
  by dn.subtree=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth\" manage
  by * none
olcAccess: to dn.subtree=\"$BASE\"
  by dn.subtree=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth\" manage
  by users read
  by * none
EOL"
```

Observa que:

- El node arrel de la base de dades ser√† `dc=amsa,dc=udl,dc=cat`. Aquest node defineix l‚Äôabast del directori LDAP i √©s on s‚Äôemmagatzemaran tots els usuaris i grups. Tot el que crearem viur√† sota aquest node.
- L‚Äôusuari administrador ser√† `cn=admin,dc=amsa,dc=udl,dc=cat`. Aquest usuari tindr√† privilegis elevats per gestionar el directori. La seva contrasenya est√† definida mitjan√ßant un hash SSHA-512 (ara mateix √©s 1234), per√≤ podeu canviar-la generant un nou hash amb `slappasswd`.
- Els √≠ndexs definits optimitzen les cerques habituals en el directori (per exemple, per uid, cn, sn, mail, etc.).
- Els ACLs (Access Control Lists) defineixen qui pot accedir a quins atributs i entrades dins del directori. Per exemple, nom√©s l‚Äôusuari admin i el root local poden gestionar tot, mentre que els usuaris normals nom√©s poden llegir. Ning√∫ m√©s t√© acc√©s. El root s'aconsegueix amb `peercred`.

#### Carregar la configuraci√≥ de la base de dades

Un cop creat el fitxer, carreguem la configuraci√≥ a la base de dades:

```bash
sudo ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/rootdn.ldif
```

Aquesta comanda:

- `ldapadd` ‚Üí eina per afegir entrades a una base de dades LDAP.
- `-Y EXTERNAL` ‚Üí utilitza l‚Äôautenticaci√≥ SASL EXTERNAL, que permet autenticar-se com a usuari del sistema (en aquest cas, root).
- `-H ldapi:///` ‚Üí utilitza el socket local (ldapi) per connectar-se al servidor LDAP.
- `-f rootdn.ldif` ‚Üí fitxer amb la configuraci√≥ que volem carregar.

### Creaci√≥ de l'estructura del directori LDAP

Un cop creada la base de dades MDB i configurat l‚Äôusuari administrador (cn=admin,$BASE), ja podem definir l‚Äôestructura b√†sica del Directori d‚ÄôInformaci√≥ (DIT).
Aquesta estructura seguir√† un patr√≥ molt habitual en entorns Linux i empreses:

- **ou=users** ‚Üí usuaris del sistema
- **ou=groups** ‚Üí grups del sistema
- **ou=system** ‚Üí comptes o recursos especials

Per tant, la nostra estructura b√†sica ser√†:

- **dc=amsa,dc=udl,dc=cat**: Node principal de la jerarquia LDAP.
- **ou=groups,dc=amsa,dc=udl,dc=cat**. Aquesta entrada representa una organitzaci√≥ per als grups. Contindr√† entrades de tipus posixGroup o groupOfNames.
- **ou=users,dc=amsa,dc=udl,dc=cat**. Aquesta entrada representa una organitzaci√≥ per als usuaris. Contindr√† entrades de tipus inetOrgPerson, posixAccount, o altres objectClasses d‚Äôusuaris.
- **ou=system,dc=amsa,dc=udl,dc=cat**: Aquesta entrada representa una organitzaci√≥ per al sistema. √âs habitual crear aquesta OU per comptes especials del sistema, serveis, ACL internes, o objectes que no s√≥n ‚Äúusuaris reals‚Äù.

Aquesta estructura fa que el directori sigui ordenat, modular i coherent amb els sistemes Linux quan utilitzen **NSS/LDAP**.

Per a crear aquesta estructura, primer crearem un fitxer LDIF anomenat `basedn.ldif`:

```bash
BASE="dc=amsa,dc=udl,dc=cat"
DC="amsa"

sudo bash -c "cat << EOL >> basedn.ldif
dn: $BASE
objectClass: dcObject
objectClass: organization
objectClass: top
o: AMSA
dc: $DC

dn: ou=groups,$BASE
objectClass: organizationalUnit
objectClass: top
ou: groups

dn: ou=users,$BASE
objectClass: organizationalUnit
objectClass: top
ou: users

dn: ou=system,$BASE
objectClass: organizationalUnit
objectClass: top
ou: system
EOL"
```

Com que el nostre servidor permet `peercred` com a administrador, podem afegir aquests objectes amb:

```bash
sudo ldapadd -Y EXTERNAL -H ldapi:/// -f basedn.ldif
```

:::{.callout-note title="Seguretat del socket ldapi"}
`-Y EXTERNAL -H ldapi:///` √©s el m√®tode m√©s segur: autentica via socket Unix com a root local del sistema, sense enviar cap contrasenya. En altres entorns, `ldapadd -x -D "cn=admin,$BASE" -W -f basedn.ldif` demanar√† la contrasenya de l'usuari admin.
:::

### üìÇ Creaci√≥ d‚Äôusuaris i grups dins del directori LDAP

Ara que ja tenim l‚Äôestructura b√†sica `(ou=users, ou=groups, ou=system)`, podem comen√ßar a crear usuaris i grups reals dins el directori. La creaci√≥ d‚Äôun usuari en LDAP es fa mitjan√ßant un fitxer LDIF que descriu totes les seves propietats.

#### üë§ Exemple b√†sic: Creaci√≥ d‚Äôun usuari
```ldif
dn: uid=johndoe,ou=users,dc=amsa,dc=udl,dc=cat
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
objectClass: top
cn: John Doe
sn: Doe
uid: johndoe
uidNumber: 1000
gidNumber: 1000
homeDirectory: /home/johndoe
loginShell: /bin/bash
userPassword: {SSHA512}CBVaUdQC9mVvAi+0O92J3hA+aPdiWUqf4lVr6bGRAUsFJX5aFOEb+1pSsY8PQwW1UKuuCGO2+160HotnfjXIaRKlryVekLnu
```

on:

- **inetOrgPerson**: Permet atributs de persona (nom, cognom, email...).
- **posixAccount**: Necessari perqu√® el sistema Linux pugui validar UID, GID, shell, home, etc.
- **shadowAccount**: Permet gestionar atributs com caducitat de contrasenya.
- **uidNumber / gidNumber**: Identificadors reals d‚Äôusuari i grup.
- **loginShell**: Shell que s'executar√† quan entri al sistema.
- **userPassword**: Hash generat pr√®viament (SSHA-512).


:::{.callout-tip title="üîê Qu√® √©s un usuari OSProxy?"}
√âs habitual crear un usuari especial **OSProxy**, amb la missi√≥ de permetre a sistemes Linux consultar:

- UID d‚Äôusuaris
- GID de grups
- Llistes de membres

Aix√≤ forma part del model de seguretat **least privilege**: Un compte limitat que nom√©s pot llegir informaci√≥ essencial del directori, sense privilegis administratius.
:::

#### üõ†Ô∏è Creaci√≥ del fitxer `users.ldif` amb usuaris i grups

```bash
sudo bash -c '
BASE="dc=amsa,dc=udl,dc=cat"

groups=("programadors" "dissenyadors")
gids=("4000" "5000")
users=("ramon" "manel")
sns=("mateo" "lopez")
uids=("4001" "5001")

# Crear fitxer LDIF
cat > /etc/openldap/users.ldif << EOL1
dn: cn=osproxy,ou=system,${BASE}
objectClass: organizationalRole
objectClass: simpleSecurityObject
cn: osproxy
userPassword: {SSHA512}CBVaUdQC9mVvAi+0O92J3hA+aPdiWUqf4lVr6bGRAUsFJX5aFOEb+1pSsY8PQwW1UKuuCGO2+160HotnfjXIaRKlryVekLnu
description: OS proxy for resolving UIDs/GIDs

EOL1

# GRUPS
for (( j=0; j<${#groups[@]}; j++ )); do
cat >> /etc/openldap/users.ldif << EOL2
dn: cn=${groups[$j]},ou=groups,${BASE}
objectClass: posixGroup
cn: ${groups[$j]}
gidNumber: ${gids[$j]}

EOL2
done

# USUARIS
for (( j=0; j<${#users[@]}; j++ )); do
cat >> /etc/openldap/users.ldif << EOL3
dn: uid=${users[$j]},ou=users,${BASE}
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
cn: ${users[$j]}
sn: ${sns[$j]}
uid: ${users[$j]}
uidNumber: ${uids[$j]}
gidNumber: ${uids[$j]}
homeDirectory: /home/${users[$j]}
loginShell: /bin/bash
userPassword: {SSHA512}CBVaUdQC9mVvAi+0O92J3hA+aPdiWUqf4lVr6bGRAUsFJX5aFOEb+1pSsY8PQwW1UKuuCGO2+160HotnfjXIaRKlryVekLnu

EOL3
done
'
```
#### Carregar els usuaris i grups al directori LDAP

```bash
sudo ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/users.ldif
```


### üß™ Testeig inicial de la instal¬∑laci√≥ LDAP (abans de TLS)

#### üîç Buscar objectes amb ldapsearch (mode local ldapi:///)

Per comprovar que la base de dades cont√© els usuaris creats, fem una cerca a `ou=users`:

```bash
ldapsearch -H ldapi:/// -Y EXTERNAL -b "ou=users,dc=amsa,dc=udl,dc=cat"
# La sortida ha de mostrar els usuaris creats com el ramon i el manel amb els seus atributs
```

#### üîç Buscar objectes amb ldapsearch (mode an√≤nim)

Tamb√© podem provar una connexi√≥ LDAP an√≤nima (sense autenticar) per veure quina informaci√≥ √©s accessible p√∫blicament:

```bash
ldapsearch -x -H ldapi:/// -b "ou=users,dc=amsa,dc=udl,dc=cat"
```

Si tot est√† configurat correctament, haur√†s de veure nom√©s els atributs que l‚ÄôACL permet per a usuaris an√≤nims (normalment molt pocs o cap).

#### üîê Prova amb l‚Äôusuari admin (connexi√≥ autenticada)

Tamb√© podem provar una connexi√≥ LDAP cl√†ssica utilitzant `cn=admin,$BASE`.

```bash
ldapsearch -x -W \
  -H ldapi:/// \
  -D "cn=admin,dc=amsa,dc=udl,dc=cat" \
  -b "ou=users,dc=amsa,dc=udl,dc=cat"
```

On:

- El par√†metre -x indica que utilitzem autenticaci√≥ simple (sense SASL).
- El par√†metre -D especifica el DN de l‚Äôusuari amb el qual ens autenticarem (admin).

### Altres comandes √∫tils per a la gesti√≥ LDAP

Aquestes s√≥n les eines b√†siques per gestionar qualsevol directori LDAP:

| Eina           | Funci√≥                      |
| -------------- | --------------------------- |
| **ldapsearch** | Cerca i consulta entrades   |
| **ldapadd**    | Afegeix entrades (LDIF)     |
| **ldapmodify** | Modifica entrades existents |
| **ldapdelete** | Elimina entrades            |
| **ldappasswd** | Canvia contrasenyes         |


Us recomano familiaritzar-vos amb aquestes eines, ja que s√≥n fonamentals per a l‚Äôadministraci√≥ di√†ria d‚Äôun servidor LDAP. Feu proves amb elles per entendre com funcionen. Per exemple, podeu provar a canviar la contrasenya d‚Äôun usuari amb `ldappasswd`.

```bash
ldappasswd -H ldapi:/// \
  -D "cn=admin,dc=amsa,dc=udl,dc=cat" \
  -x -W \
  "uid=manel,ou=users,dc=amsa,dc=udl,dc=cat"
```

Aquesta comanda canviar√† la contrasenya de l‚Äôusuari manel. Et demanar√†: la contrasenya de l‚Äôadmin i despr√©s la nova contrasenya per a manel (2 vegades). Recordeu que `ldappasswd` genera autom√†ticament el hash de la contrasenya. No us cal fer-ho manualment. Podeu introduir la contrasenya en text pla, i `ldappasswd` s‚Äôencarregar√† de convertir-la al format correcte (SSHA512).

### Exercicis d'ampliaci√≥

#### Exercic 1: `middleearth.ldif` ‚Äî Creaci√≥ de la base de dades MiddleEarth

A partir del que has fet a l‚Äôexercici anterior, crea una jerarquia nova per a middleearth dins el teu domini LDAP. Crea un fitxer middleearth.ldif que cont√©:

- els grups hobbits, elfs, nans, mags
- els seus gidNumber respectius
- Afegeix-lo al servidor amb ldapadd.
- Comprova que els grups s‚Äôhan creat amb ldapsearch

#### Exercici 2: Crear els usuaris de Middle-Earth

Crea un fitxer `users-middleearth.ldif` amb:

- els usuaris Frodo, Samwise, Gollum, Legolas, Gimli i Gandalf
- sn correctes
- uidNumber √∫nics
- gidNumber que coincideixi amb el seu grup

Verifica que pots consultar-los amb `ldapsearch`.

#### Exercici 3: Modificar grup amb `ldapmodify`

- Modificar el grup actual d'un usuari (per exemple, assigna a Gandalf el grup dels hobbits).
- Comprova que el canvi s'ha aplicat correctament amb `ldapsearch`.

#### Exercici 4: Eliminar usuari amb `ldapdelete`

- Elimina l'usuari Gollum del directori LDAP.
- Verifica que ja no existeix amb `ldapsearch`.


### üîê Configuraci√≥ de certificats TLS per LDAP (LDAPS)

Per protegir la comunicaci√≥ amb el servidor LDAP, activarem TLS perqu√® els clients puguin utilitzar LDAPS (port 636) o LDAP+StartTLS (port 389). Aix√≤ garanteix que:

- les contrasenyes viatgen xifrades
- totes les consultes i respostes es protegeixen contra interceptaci√≥
- els clients poden verificar la identitat del servidor

#### Generaci√≥ de certificats TLS amb OpenSSL

El primer pas ser√† generar un parell de claus i un certificat autosignat amb OpenSSL. Aix√≤ √©s suficient per a un laboratori, per√≤ en producci√≥ es faria amb una **CA real**.

:::{.callout-warning title="‚ö†Ô∏è IMPORTANT"}
El Common Name (CN) del certificat ha de coincidir amb el hostname del servidor LDAP que faran servir els clients.
:::

```bash
PATH_PKI="/etc/pki/tls"
HOSTNAME="ec2-xx-xxx-xxx-xxx.compute-1.amazonaws.com"  # Canvia-ho pel teu hostname p√∫blic o privat
commonname=$HOSTNAME
country=ES
state=Spain
locality=Igualada
organization=UdL
organizationalunit=IT
email=admin@udl.cat

sudo openssl req -days 500 -newkey rsa:4096 \
    -keyout "$PATH_PKI/ldapkey.pem" -nodes \
    -sha256 -x509 -out "$PATH_PKI/ldapcert.pem" \
    -subj "/C=$country/ST=$state/L=$locality/O=$organization/OU=$organizationalunit/CN=$commonname/emailAddress=$email"
```

Aix√≤ crear√† una clau privada RSA de 4096 bits i un certificat X.509 autosignat v√†lid per 500 dies.

#### Assignaci√≥ de permisos

La clau privada ha de ser llegible nom√©s per l‚Äôusuari ldap:

```bash
sudo chown ldap:ldap "$PATH_PKI/ldapkey.pem"
sudo chmod 400 "$PATH_PKI/ldapkey.pem"
```

:::{.callout-note title="Qu√® √©s una CA?"}
Una **CA** (Certificate Authority) √©s una entitat de confian√ßa que emet certificats digitals. Aquests certificats s'utilitzen per verificar la identitat d'un servidor o usuari i per establir connexions segures mitjan√ßant protocols com TLS/SSL. Quan un client es connecta a un servidor, utilitza el certificat em√®s per la CA per assegurar-se que est√† comunicant-se amb el servidor leg√≠tim i no amb un impostor. **Ens ajuda a establir una cadena de confian√ßa en les comunicacions segures**.
:::

Creem tamb√© un **CA** (per autosignats utilitzem el mateix certificat):

```bash
sudo cp "$PATH_PKI/ldapcert.pem" "$PATH_PKI/cacerts.pem"
```

:::{.callout-tip}
## (‚úîÔ∏è) Checkpoint

- Verifica que els fitxers s'han creat correctament: `openssl x509 -in /etc/pki/tls/ldapcert.pem -noout -text`

:::

### Afegir la configuraci√≥ TLS al servidor LDAP

Ara crearem un LDIF per dir al servidor LDAP on trobar els certificats.

```bash
sudo bash -c " cat << EOF > /etc/openldap/add-tls.ldif
dn: cn=config
changetype: modify
add: olcTLSCACertificateFile
olcTLSCACertificateFile: "$PATH_PKI/cacerts.pem"
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: "$PATH_PKI/ldapkey.pem"
-
add: olcTLSCertificateFile
olcTLSCertificateFile: "$PATH_PKI/ldapcert.pem"
EOF"
```

:::{.callout-note title="Per qu√® add: i no replace:?"}
Perqu√® aquests atributs encara no existeixen en la configuraci√≥ inicial. Si tornessis a aplicar TLS una segona vegada, aleshores s√≠ que hauries d‚Äôusar:

```ldif
changetype: modify
replace: olcTLSCertificateFile
```
:::

#### Carregar la configuraci√≥ TLS

```bash
sudo ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/add-tls.ldif
```

#### Reiniciar el servei LDAP

```bash
sudo systemctl restart slapd
```

:::{.callout-tip}

## (‚úîÔ∏è) Checkpoint

- Comprova que el servei s‚Äôha reiniciat correctament: `systemctl status slapd`
- Comprova que est√† escoltant als ports LDAP i LDAPS amb: `ss -tuln | grep slapd`
- Pots utilitzar `openssl s_client -connect localhost:636 -showcerts` per verificar que el certificat TLS s'ha carregat correctament.
- `ldapwhoami -H ldaps://$HOSTNAME -x -D "cn=admin,dc=amsa,dc=udl,dc=cat" -W` per assegurar-te que pots autenticar-te via LDAPS.
:::



## üñ•Ô∏è Configuraci√≥ del client LDAP

En aquest apartat configurarem una nova inst√†ncia EC2 perqu√® pugui:

- validar usuaris LDAP,
- utilitzar grups LDAP,
- crear autom√†ticament el directori /home/<usuari> quan un usuari LDAP entri al sistema,
- utilitzar LDAPS (TLS) per a totes les connexions.

### Instal¬∑lar els paquets necessaris

El client necessita eines LDAP i SSSD (System Security Services Daemon), que permet integrar LDAP amb PAM i NSS.

```bash
sudo dnf install -y openldap-clients sssd sssd-tools authselect oddjob-mkhomedir
```

- `openldap-clients` ‚Üí eines com ldapsearch, ldapadd, etc.
- `sssd` ‚Üí daemon que gestiona usuaris i credencials.
- `oddjob-mkhomedir` ‚Üí crea /home/<usuari> autom√†ticament.
- `authselect` ‚Üí configura PAM/NSS amb SSSD.

### Copiar el certificat CA del servidor LDAP

El client ha de confiar en el certificat TLS del servidor.

Al **servidor LDAP**:

```bash
sudo cat /etc/pki/tls/cacerts.pem
# Copia TOT el contingut.
```

Al **client LDAP**:

Crea el fitxer:

```bash
sudo vi /etc/pki/tls/cacert.crt
# Enganxa el contingut.
```

Es recomana establir permisos restrictius:

```bash
sudo chmod 644 /etc/pki/tls/cacert.crt
```

### Configurar `/etc/openldap/ldap.conf`

Aquest fitxer indica al client on trobar el servidor LDAP i la CA:

```bash
sudo bash -c "cat > /etc/openldap/ldap.conf << EOF
BASE dc=amsa,dc=udl,dc=cat
URI ldaps://ec2-XX-XXX-XXX-XXX.compute-1.amazonaws.com
TLS_CACERT /etc/pki/tls/cacert.crt
EOF"
```

### Configurar SSSD `/etc/sssd/sssd.conf`

```bash
sudo bash -c "cat > /etc/sssd/sssd.conf << EOF
[sssd]
services = nss, pam, sudo
config_file_version = 2
domains = default

[nss]

[pam]
offline_credentials_expiration = 60

[domain/default]
id_provider = ldap
auth_provider = ldap
chpass_provider = ldap
access_provider = ldap
sudo_provider = ldap
cache_credentials = True

ldap_uri = ldaps://ec2-XX-XXX-XXX-XXX.compute-1.amazonaws.com
ldap_search_base = dc=amsa,dc=udl,dc=cat
ldap_user_search_base = ou=users,dc=amsa,dc=udl,dc=cat
ldap_group_search_base = ou=groups,dc=amsa,dc=udl,dc=cat

ldap_default_bind_dn = cn=osproxy,ou=system,dc=amsa,dc=udl,dc=cat
ldap_default_authtok = 1234

ldap_tls_reqcert = demand
ldap_tls_cacert = /etc/pki/tls/cacert.crt

ldap_id_use_start_tls = True
ldap_search_timeout = 50
ldap_network_timeout = 60

ldap_access_filter = (objectClass=posixAccount)
EOF"
```

Aquest fitxer configura SSSD per utilitzar LDAP com a font d‚Äôusuaris i grups, amb connexi√≥ segura via LDAPS. Molt important: assegura't que `ldap_uri` i `ldap_default_bind_dn` coincideixen amb el teu servidor i usuari OSProxy. La contrasenya tamb√© ha de ser correcta.

:::{.callout-note title="Password en texto pl√†?"}
En aquest exemple, la contrasenya de l'usuari osproxy s'ha posat en text pla per simplicitat. En un entorn de producci√≥, √©s recomanable utilitzar m√®todes m√©s segurs per gestionar les contrasenyes, com ara fitxers de contrasenyes xifrats o utilitzar eines de gesti√≥ de secrets. Tot i aix√≤, recordeu que l'usuari proxy t√© permisos limitats per llegir nom√©s la informaci√≥ necess√†ria i no pot escriure/modificar res al directori LDAP.
:::

Assigneu els permisos correctes:

```bash
sudo chmod 600 /etc/sssd/sssd.conf
```

### Configurar Authselect

`authselect` √©s una eina que simplifica la configuraci√≥ d‚Äôautenticaci√≥ en sistemes Linux. Ens permet no tenir que configurar PAM i NSS manualment.

```bash
sudo authselect select sssd --force
```

### Configurar Oddjob per a la creaci√≥ autom√†tica de directoris d'inici

El servei `oddjobd` crea els directoris `/home/<usuari>` quan un usuari LDAP inicia sessi√≥ per primera vegada.

```bash
sudo systemctl enable --now oddjobd
```

Afegeix la seg√ºent l√≠nia al fitxer `/etc/pam.d/system-auth` per habilitar aquesta funcionalitat:

```bash
sudo bash -c 'echo "session optional pam_oddjob_mkhomedir.so skel=/etc/skel/ umask=0077" >> /etc/pam.d/system-auth'
```

### Iniciar i habilitar SSSD

```bash
sudo systemctl enable --now sssd
```

### Testar la configuraci√≥ del client LDAP

Prova a cercar usuaris LDAP amb `id` i `getent`:

```bash
id ramon
getent passwd ramon
getent group programadors
```

### Testar amb creaci√≥ manual

```bash
sudo mkdir /home/ramon
sudo chown 4001::4000 /home/ramon
ls -ld /home/ramon
# Si veus que el propietari √©s ramon i el grup √©s programadors, tot funciona correctament.
# Si veus, 4001:4000, vol dir que SSSD no est√† funcionant correctament.
```


## üåê Instal¬∑laci√≥ i configuraci√≥ d‚Äôun client web LDAP (LAM)

Per facilitar l‚Äôadministraci√≥ del servidor LDAP, instal¬∑larem LAM ‚Äî LDAP Account Manager, una interf√≠cie web que permet:

- veure usuaris i grups de manera visual
- modificar entrades LDAP
- afegir nous usuaris i grups
- gestionar contrasenyes
- aplicar plantilles d‚Äôusuaris i perfils

√âs una eina molt √∫til perqu√® els estudiants entenguin com est√† organitzat el directori i com funcionen els objectClasses. Aquesta configuraci√≥ es pot fer en la mateixa inst√†ncia del servidor LDAP o en una inst√†ncia separada. Nosaltres ho farem en una inst√†ncia separada per simular un entorn real on el client web est√† a√Øllat del servidor LDAP.

### Instal¬∑laci√≥ de depend√®ncies

Cal instal¬∑lar Apache i els m√≤duls PHP necessaris perqu√® LAM funcioni:

```bash
sudo dnf install -y httpd php php-ldap php-mbstring php-gd php-gmp php-zip
sudo systemctl enable --now httpd
```

### Instal¬∑laci√≥ de LAM

Per fer-ho, descarregarem el paquet RPM oficial de LAM i l‚Äôinstal¬∑larem:

```bash
sudo wget https://github.com/LDAPAccountManager/lam/releases/download/9.0.RC1/ldap-account-manager-9.0.RC1-0.fedora.1.noarch.rpm
sudo dnf install -y ldap-account-manager-9.0.RC1-0.fedora.1.noarch.rpm
```

:::{.callout-note title="Verifica la versi√≥ m√©s recent"}
Comprova a la p√†gina oficial de [LAM Releases](https://github.com/LDAPAccountManager/lam/releases) si hi ha una versi√≥ m√©s recent i actualitza l'enlla√ß de desc√†rrega si cal.
:::

LAM quedar√† instal¬∑lat a `/usr/share/lam` i accessible via **http://<server_ip>/lam**.

### Configuraci√≥ de LAM

Per configurar LAM, es pot fer des de la interf√≠cie web. Accedeix a: `http://<IP_SERVER>/lam`, el usuari per defecte √©s `lam` i la contrasenya tamb√© `lam`. √âs molt important que canvieu aquesta contrasenya en el primer acc√©s per motius de seguretat. 

  ![](../../figs/laboratories/05-aws-ldap/lam-01.png)

Aneum a **LAM Configuration**:

- Edit general settings:
  - Importeu el certificat CA del servidor LDAP a la secci√≥ **TLS/SSL** per permetre connexions segures. Copieu l'adre√ßa del servidor LDAP (e.g `ldaps://XXXXXXXX.compute-1.amazonaws.com:636`) i feu clic a **Import from server**. 
  
- Edit server profiles:
  - Server Address: `ldaps://XXXXXXXX.compute-1.amazonaws.com:636` o b√© si esteu utilitzant el vostre servidor LDAP, `ldap://localhost:389`.
  - Activate TLS: Marcat.
  - List of Valid Users: `cn=osproxy,ou=system,dc=amsa,dc=udl,dc=cat`.
  - Tree suffix: `dc=amsa,dc=udl,dc=cat`.
- Account Types:
  - Users: `ou=users,dc=amsa,dc=udl,dc=cat`.
  - Groups: `ou=groups,dc=amsa,dc=udl,dc=cat`.
- List of Valid Users: `cn=osproxy,ou=system,dc=amsa,dc=udl,dc=cat`.

:::{.callout-tip title="Configuraci√≥ de LAM"}
Aquesta configuraci√≥ es guarda en un fitxer anomenat `config.inc.php` a `/etc/lam/`. Si necessites canviar la configuraci√≥ manualment, pots editar aquest fitxer.
:::

## Testing de LAM

Un cop configurat correctament, haur√≠eu de poder iniciar sessi√≥ a LAM amb l'usuari `osproxy` i la contrasenya que heu definit anteriorment. Un cop dins, podreu veure i gestionar els usuaris i grups del vostre directori LDAP de manera visual. Ara podeu afegir nous usuaris, modificar els existents i gestionar grups f√†cilment.

  ![](../../figs/laboratories/05-aws-ldap/lam-04.png)

