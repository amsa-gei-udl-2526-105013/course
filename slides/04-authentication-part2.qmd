---
title: "Autenticaci√≥ i Autoritzaci√≥ (Part 2)"
subtitle: "Unitat 4 ¬∑ Administraci√≥ i Manteniment de Sistemes i Aplicacions (AMSA)"
author: "Jordi Mateo Forn√©s"
logo: "/figs/corporative/institute.png"
format: 
  revealjs:
    transition: fade
    slide-number: true
    incremental: true 
    chalkboard: false
    css: styles.css
    footer: "Unitat 4 ¬∑ Administraci√≥ i Manteniment de Sistemes i Aplicacions (AMSA) [üè†](/index.html)</a>"
editor: visual

execute:
  freeze: auto
  echo: false

mermaid:
  theme: forest
---

# PAM: Pluggable Authentication Modules

## Necessitat d‚Äôautenticaci√≥ {.smaller}

- Els sistemes i serveis moderns requereixen m√®todes d‚Äôautenticaci√≥ **flexibles**, **segurs** i **integrats**.
- Cal gestionar diversos mecanismes d‚Äôautenticaci√≥ (*contrasenyes, claus SSH, biometria, targetes intel¬∑ligents, etc.*) de manera **centralitzada** i coherent.
- Cada aplicaci√≥ **no hauria de gestionar per separat** la seva pr√≤pia autenticaci√≥.
- Es necessita un **sistema com√∫ i modular** que permeti a les aplicacions reutilitzar mecanismes d‚Äôautenticaci√≥ compartits.

::: {.fragment .center-container}
**Centralitzar** i **unificar la gesti√≥ de l‚Äôautenticaci√≥**: simplifica el manteniment i millora la seguretat.
:::


## Qu√® √©s PAM? {.smaller}

- **Framework modular d‚Äôautenticaci√≥** utilitzat en sistemes Unix/Linux.
- Permet **integrar m√∫ltiples esquemes d‚Äôautenticaci√≥** (Unix, LDAP, biometria, targetes, etc.) a trav√©s d‚Äôuna API comuna que les aplicacions poden utilitzar.
- Els **administradors** poden modificar o afegir m√®todes d‚Äôautenticaci√≥ **sense canviar el codi** de les aplicacions.
- Els **programadors** nom√©s han de confiar en la interf√≠cie PAM; el sistema s‚Äôencarrega de gestionar els m√≤duls subjacents.

::: {.fragment .center-container}
```bash
man pam.d 
```
:::

## Esquema de funcionament de PAM

```{mermaid}
%%| echo: false
%%| column: screen-inset
flowchart TD
    subgraph A[Aplicacions]
        A1[sshd]
        A2[login]
        A3[sudo]
    end

    A --> B[libpam ¬∑ interf√≠cie PAM]

    B --> C["/etc/pam.d/sshd"]
    B --> D["/etc/pam.d/login"]
    B --> E["/etc/pam.d/sudo"]

    subgraph M[ M√≤duls d'autenticaci√≥ PAM ]
        M1["pam_unix.so 
            contrasenyes locals"]
        M2["pam_ldap.so
            autenticaci√≥ LDAP"]
        M3["pam_tally2.so 
            control d‚Äôintents fallits"]
        M4["pam_limits.so 
            l√≠mits de recursos"]
    end

    C --> M
    D --> M
    E --> M
```

## Tipus de m√≤duls PAM {.smaller}

Cada m√≤dul de PAM t√© un rol espec√≠fic dins del proc√©s d‚Äôautenticaci√≥ i gesti√≥ de sessions:

1. **Autenticaci√≥ (auth)**: Verifica la identitat de l‚Äôusuari mitjan√ßant contrasenyes, claus, biometria, etc.
2. **Gesti√≥ de comptes (account)**: Controla l‚Äôacc√©s als recursos segons pol√≠tiques establertes (horaris, permisos, etc.).
3. **Gesti√≥ de contrasenyes (password)**: S‚Äôencarrega de la modificaci√≥ i actualitzaci√≥ de les contrasenyes dels usuaris.
4. **Gesti√≥ de sessions (session)**: Gestiona tasques relacionades amb l‚Äôinici i tancament de sessions, com el registre d‚Äôactivitat o el muntatge de directoris.

# Stack de m√≤duls PAM (I) {.smaller}

Els m√≤duls PAM es combinen en stacks que defineixen com es gestiona l‚Äôautenticaci√≥ i les tasques relacionades per cada servei.

- Cada m√≤dul t√© una **funci√≥ espec√≠fica** i una **l√≤gica de control** que determina com afecta el resultat global de l‚Äôautenticaci√≥.
- Els m√≤duls s‚Äôorganitzen en piles (*stacks*) per cada servei i tipus de tasca.
- Cada servei (com `sshd`, `login`, `sudo`, etc.) t√© una pila de m√≤duls per a cada tipus de tasca: *autenticaci√≥, compte, contrasenya i sessi√≥*.

# Stack de m√≤duls PAM (I) {.smaller}

- Ordre de processament:
    - Els tipus de m√≤dul s‚Äôexecuten en aquest ordre: auth ‚Üí account ‚Üí password ‚Üí session.
    - Dins de cada tipus, els m√≤duls es processen de dalt a baix tal com apareixen al fitxer de configuraci√≥.
    - L‚Äôefecte global dep√®n de les flags de cada m√≤dul (*required, requisite, sufficient, optional*).
- Cada pila pot contenir **un o m√©s m√≤duls**, processats **en ordre**, amb el resultat final de l‚Äôautenticaci√≥ determinat per les flags.


## Llistat de m√≤duls PAM comuns {.smaller}

Per veure tots els m√≤duls disponibles al vostre sistema, consulteu: `/lib/security/` o `/lib64/security/` segons l‚Äôarquitectura.

| M√≤dul              | Funci√≥                                       |
| ------------------ | -------------------------------------------- |
| `pam_unix.so`      | Integraci√≥ amb autenticaci√≥ cl√†ssica d‚ÄôUNIX. |
| `pam_ldap.so`      | Integraci√≥ amb LDAP.                         |
| `pam_krb5.so`      | Integraci√≥ amb Kerberos5.                    |
| `pam_cracklib.so`  | Verificaci√≥ de la for√ßa de les contrasenyes. |
| `pam_env.so`       | Inicialitzaci√≥ de variables d‚Äôentorn.        |
| `pam_limits.so`    | Gesti√≥ dels l√≠mits de recursos del sistema.  |
| `pam_tally2.so`    | Control d‚Äôintents fallits d‚Äôautenticaci√≥.    |
| `pam_mkhomedir.so` | Creaci√≥ autom√†tica del directori home.       |
| `pam_access.so`    | Control d‚Äôacc√©s basat en host.               |




## L√≤gica de les flags dels m√≤duls PAM {.smaller}

Les flags determinen com cada m√≤dul afecta el resultat global de l‚Äôautenticaci√≥ dins d‚Äôun stack PAM.

| Flag           | Comportament                                                                                                    |
| -------------- | --------------------------------------------------------------------------------------------------------------- |
| **required**   | Ha de passar; si falla, la pila continua processant els altres m√≤duls, per√≤ **finalment l‚Äôautenticaci√≥ falla**. |
| **requisite**  | Ha de passar; si falla, PAM retorna **error immediatament** (evita delays o *timing attacks*).                  |
| **sufficient** | Si passa, PAM **omite la resta** de la pila (millora efici√®ncia); si falla, es continua amb els altres m√≤duls.  |
| **optional**   | Ignorat tret que sigui l‚Äô√∫nic m√≤dul de la pila; rara vegada √©s cr√≠tic.                                          |
| **include**    | Inclou un altre fitxer de configuraci√≥ PAM, √∫til per **reutilitzar configuracions comunes**.                    |
| **substack**   | Permet agrupar m√≤duls dins d‚Äôuna pila per aplicar **l√≤giques m√©s complexes**.                                   |

::: notes
Un timing attack √©s un tipus d‚Äôatac on l‚Äôatacant intenta deduir informaci√≥ sensible (com contrasenyes) mesurant el temps que triga el sistema a respondre a diferents entrades.
:::

# Exemple d'stack PAM {.smaller}

```bash
auth    required    pam_unix.so
auth    optional    pam_cap.so
account required    pam_unix.so
```

```{mermaid}
flowchart LR
A[Usuari inicia sessi√≥] --> B[pam_unix.so ¬∑ auth, required]
B --> C[pam_cap.so ¬∑ auth, optional]
C --> D[pam_unix.so ¬∑ account, required]
D --> E{Acc√©s perm√®s?}
E -->|S√≠| F[Servei concedit]
E -->|No| G[Acc√©s denegat]
```

- Els flags (`required`, `optional`) determinen l‚Äô**impacte de cada m√≤dul** sobre l‚Äôautenticaci√≥.
- L‚Äôordre dels m√≤duls √©s **estricte**:
  - Els obligatoris han de passar per permetre l‚Äôacc√©s.
  - Els opcionals afegeixen funcionalitat extra sense bloquejar l‚Äôautenticaci√≥.


## Configuraci√≥ de PAM {.smaller}

- Els fitxers de configuraci√≥ defineixen com s‚Äôaplica PAM per a cada servei i tipus de tasca.
- Es troben a `/etc/pam.d/` i cada servei t√© el seu fitxer propi, per exemple:
  - `/etc/pam.d/sshd`
  - `/etc/pam.d/login`
  - `/etc/pam.d/sudo`
- En aquests fitxers s‚Äôespecifica:
  - Quins m√≤duls s‚Äôutilitzen per a cada tipus de tasca (*auth, account, password, session*).
  - Les **flags** corresponents per a cada m√≤dul (*required, optional, etc.*).


## Estructura d‚Äôun fitxer de config {.smaller}

Cada l√≠nia t√© la seg√ºent estructura:

```bash
<tipus>   <flag>   <m√≤dul>   [opcions]
```
- **tipus**: Tipus de tasca (*auth, account, password, session*).
- **flag**: Comportament del m√≤dul (*required, requisite, sufficient, optional*).
- **m√≤dul**: Nom del m√≤dul PAM (per exemple, `pam_unix.so`).
- **[opcions]**: Par√†metres addicionals per al m√≤dul.

## Opcions comunes dels m√≤duls PAM {.smaller}

Per consultar totes les opcions disponibles per a un m√≤dul espec√≠fic, utilitzeu: `man pam_modulename`.

| Opci√≥            | Descripci√≥ breu                                                                        |
| ---------------- | -------------------------------------------------------------------------------------- |
| `nullok`         | Permet usuaris sense contrasenya.                                                      |
| `try_first_pass` | Intenta utilitzar la contrasenya ja proporcionada abans d‚Äôentrar una nova.             |
| `use_first_pass` | Utilitza la contrasenya anterior; si falla, no demana una nova.                        |
| `minlen=N`       | (pam_cracklib) Longitud m√≠nima de la contrasenya.                                      |
| `retry=N`        | Nombre de intents per introduir la contrasenya abans de fallar.                        |
| `difok=N`        | (pam_cracklib) Nombre m√≠nim de car√†cters diferents respecte a la contrasenya anterior. |
| `sha512`         | (pam_unix) Encriptaci√≥ de la contrasenya amb SHA-512.                                  |
| `remember=N`     | N√∫mero de contrasenyes recordades pel canvi de password.                               |


## Exemples de configuracions {.smaller}

### `/etc/pam.d/ssh`

```bash
# Autenticaci√≥ amb contrasenyes locals; permet usuaris sense contrasenya
auth     required   pam_unix.so nullok    
# Gesti√≥ de comptes; comprova permisos i restriccions
account  required   pam_unix.so      
 # Gesti√≥ de sessions; registra inici i tancament de sessi√≥     
session  required   pam_unix.so    
```      

### `/etc/pam.d/sudo` 

```bash
# Autenticaci√≥ amb contrasenya; prova primer la contrasenya de l'usuari
auth     required   pam_unix.so try_first_pass
# Denega immediatament en determinades condicions
auth     requisite  pam_deny.so
# Permet sempre l'acc√©s (nom√©s si altres no fallen)
auth     required   pam_permit.so

```

::: notes
- requisite: si el m√≤dul falla, PAM retorna error immediatament i no processa m√©s m√≤duls de la pila.
- required: si el m√≤dul falla, PAM continua processant la resta de la pila, per√≤ finalment l‚Äôautenticaci√≥ global falla.
- sufficient: si passa, PAM omet la resta de la pila; si falla, es continua.  
- optional: nom√©s √©s rellevant si √©s l‚Äô√∫nic m√≤dul de la pila; rarament cr√≠tic.
Exemple pr√†ctic: pam_deny.so sol usar-se amb requisite per bloquejar l‚Äôacc√©s immediatament.
:::

## Configuraci√≥ avan√ßada de PAM (types) {.smaller}

PAM permet definir condicions complexes per a cada m√≤dul mitjan√ßant **valors-accions** basats en el codi de retorn del m√≤dul.

- El camp `type` pot incloure una llista de **valors-accions** separats per comes per controlar com s‚Äôinterpreta cada resultat.

::: {.fragment}
```bash
type[success=ok new_authtok_reqd=ok default=die] module.so options
```
:::

::: {.fragment}
Aquesta configuraci√≥ permet:

- Interpretar codis de retorn espec√≠fics de cada m√≤dul.
- Aplicar regles diferents segons l‚Äô√®xit, error o necessitat de canvi de token.
:::

## Accions comuns en PAM {.smaller}

| Acci√≥              | Descripci√≥                                                                     |
| ------------------ | ------------------------------------------------------------------------------ |
| `ignore`           | Ignorar el resultat del m√≤dul.                                                 |
| `ok`               | Considerar el m√≤dul com a passat.                                              |
| `die`              | Considerar el m√≤dul com a fallit.                                              |
| `reset`            | Reiniciar el comptador d‚Äôintents fallits o l‚Äôestat de la pila.                 |
| `bad`              | Considerar el m√≤dul com a fallit i incrementar el comptador d‚Äôintents fallits. |
| `done`             | Finalitzar el processament de la pila.                                         |
| `N`                | Com `ok`, per√≤ pot saltar sobre els propers N m√≤duls.                          |



## Fitxers de configuraci√≥ PAM (defaults) {.smaller}

Els fitxers `common-*` defineixen configuracions est√†ndard que poden ser reutilitzades per m√∫ltiples serveis, evitant duplicaci√≥ de codi.

- `/etc/pam.d/common-auth`: Configuraci√≥ comuna per a l‚Äôautenticaci√≥.
- `/etc/pam.d/common-account`: Configuraci√≥ comuna per a la gesti√≥ de comptes.
- `/etc/pam.d/common-password`: Configuraci√≥ comuna per a la gesti√≥ de contrasenyes.
- `/etc/pam.d/common-session`: Configuraci√≥ comuna per a la gesti√≥ de sessions.

::: {.fragment .center-container}
Els fitxers espec√≠fics de servei (`/etc/pam.d/sshd`) solen incloure aquests fitxers comuns amb la directiva **include**, permetent aplicar la mateixa pol√≠tica a tots els serveis de manera centralitzada.
:::

## Depuraci√≥ de PAM {.smaller}

PAM ofereix diverses opcions per obtenir informaci√≥ detallada del proc√©s d‚Äôautenticaci√≥.

- Afegir l‚Äôopci√≥ debug als m√≤duls PAM dins dels fitxers de configuraci√≥, per exemple:

::: {.fragment}
```bash
auth required pam_unix.so debug
```
:::

- Executar aplicacions amb PAM en mode depuraci√≥ utilitzant les opcions:

::: {.fragment}
```bash
ssh -vvv usuari@host       # SSH amb depuraci√≥ 
login -d                   # Login amb depuraci√≥ 
```
:::

## Logs de PAM i autenticaci√≥ {.smaller}

Els logs s√≥n essencials per monitoritzar i depurar l‚Äôautenticaci√≥ gestionada per PAM.

1. `/var/log/auth.log`
   - Distribucions basades en Debian (Ubuntu).
   - Cont√© registres d‚Äôautenticaci√≥ i autoritzaci√≥ d‚Äôusuaris, incloent els generats per PAM.

2. `/var/log/secure`

   - Distribucions basades en Red Hat (CentOS, Fedora).
   - Registres relacionats amb seguretat i autenticaci√≥, incloent PAM.

3. `/var/log/syslog`

   - Algunes distribucions utilitzen el syslog general per registrar els esdeveniments de PAM.
   - Especialment √∫til si no hi ha `auth.log` o `secure` configurats.


## Bones pr√†ctiques amb PAM {.smaller}

1. Fer c√≤pies de seguretat abans de modificar fitxers de configuraci√≥.
2. Provar els canvis amb cura per evitar bloquejos d‚Äôacc√©s al sistema.
3. Minimitzar l‚Äô√∫s de **sufficient**, ja que pot permetre l‚Äôacc√©s encara que altres m√≤duls fallin.
4. Aplicar el nivell de restricci√≥ m√©s estricte per a cada servei.
5. Mantenir PAM i el sistema operatiu actualitzats per evitar vulnerabilitats conegudes.
6. Configurar auditoria i monitoritzaci√≥ dels intents d‚Äôautenticaci√≥ per detectar anomalies.
7. Evitar modificar els fitxers de PAM per ning√∫ altre que no sigui l‚Äôadministrador del sistema (√∫s `sudo`). Permisos 600 s√≥n recomanables.


## Compatibilitat amb PAM {.smaller}

- PAM √©s ampliament suportat en la majoria de distribucions Linux i sistemes Unix.
- Per comprovar si una aplicaci√≥ utilitza PAM:
  - Revisar la documentaci√≥ de l‚Äôaplicaci√≥.
  - Inspeccionar els fitxers de configuraci√≥ a `/etc/pam.d/`.
  - Verificar si un programa est√† lligat a PAM amb `ldd`:

:::{.fragment}
```bash
sudo ldd /usr/sbin/sshd | grep libpam.so
```
Si apareix `libpam.so`, el programa utilitza PAM per a l‚Äôautenticaci√≥.
:::

## `/etc/pam.d/sshd`  {.smaller}

```bash
# Usuari es valida primer amb els m√≤duls de password-auth i postlogin
auth       substack     password-auth
auth       include      postlogin
# Es verifica que l'usuari compleix les condicions d'acc√©s
account    required     pam_sepermit.so
account    required     pam_nologin.so
account    include      password-auth
# Gesti√≥ de contrasenyes amb els m√≤duls de password-auth
password   include      password-auth
# Es configura i registra la sessi√≥ de l'usuari
session    required     pam_selinux.so close
session    required     pam_loginuid.so
session    required     pam_selinux.so open env_params
session    required     pam_namespace.so
session    optional     pam_keyinit.so force revoke
session    optional     pam_motd.so
session    include      password-auth
session    include      postlogin
```

::: notes 

1. Auth (autenticaci√≥)
    - substack password-auth ‚Üí reutilitza un conjunt com√∫ de m√≤duls d‚Äôautenticaci√≥ (usuari/contrasenya).
    - include postlogin ‚Üí afegeix passos addicionals despr√©s del login, com missatges o hooks espec√≠fics.

2. Account (gesti√≥ de comptes)

    - pam_sepermit.so ‚Üí controla permisos SELinux abans de concedir acc√©s.
    - pam_nologin.so ‚Üí denega acc√©s si el fitxer /etc/nologin existeix (per manteniment o restriccions temporals).
    - include password-auth ‚Üí aplica regles comunes de control d‚Äôacc√©s i restriccions d‚Äôusuari.

3. Password (gesti√≥ de contrasenyes)

    - include password-auth ‚Üí centralitza la pol√≠tica de contrasenyes (for√ßa m√≠nima, historial, encriptaci√≥).

4. Session (gesti√≥ de sessi√≥)

    - pam_selinux.so close ‚Üí tanca contextos SELinux antics abans d‚Äôiniciar una nova sessi√≥.
    - pam_loginuid.so ‚Üí registra l‚ÄôUID de l‚Äôusuari per a control d‚Äôauditoria.
    - pam_selinux.so open env_params ‚Üí obre el context SELinux per a la sessi√≥ de l‚Äôusuari.
    - pam_namespace.so ‚Üí crea entorns de namespace (a√Øllament de recursos).
    - pam_keyinit.so force revoke ‚Üí inicialitza/gestiona claus d‚Äôusuari.
    - pam_motd.so ‚Üí mostra missatges del dia.
:::

## Exercicis proposats {.smaller}

- [Configuraci√≥ de PAM per SSH amb 2FA utilitzant Google Authenticator](../exercises/04-accounts/01-pam.qmd)
