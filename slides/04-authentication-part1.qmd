---
title: "Autenticaci√≥ i Autoritzaci√≥ (Part 1)"
subtitle: "Unitat 4 ¬∑ Administraci√≥ i Manteniment de Sistemes i Aplicacions (AMSA)"
author: "Jordi Mateo Forn√©s"
logo: "/figs/corporative/institute.png"
format: 
  revealjs:
    transition: fade
    slide-number: true
    incremental: true 
    chalkboard: false
    css: styles.css
    footer: "Unitat 4 ¬∑ Administraci√≥ i Manteniment de Sistemes i Aplicacions (AMSA) [üè†](/index.html)</a>"
editor: visual

execute:
  freeze: auto
  echo: false
---

# Usuaris, grups i credencials a Linux

> We trust you have received the usual lecture from the local System Administrator. It usually boils down to these three things: (1) Respect the privacy of others. (2) Think before you type. (3) With great power comes great responsibility. ‚Äì Output of sudo(8) upon first invocation.

## Arquitectura de credencials del kernel

``` c
struct cred {
    // Identitats reals, efectives i de seguretat
    kuid_t uid, euid, suid, fsuid; 
    // Grups associats     
    kgid_t gid, egid, sgid, fsgid;
    // Capabilities heretables      
    kernel_cap_t cap_inheritable; 
    // Capabilities permeses      
    kernel_cap_t cap_permitted;
    // Capabilities actives         
    kernel_cap_t cap_effective;  
    // Claus de sessi√≥      
    struct key *session_keyring;
    // Estructura d'usuari global        
    struct user_struct *user;           
};
```

Els attributs **euid/egid** permet als progames operar amb elevaci√≥ de privilegis.

## Usuaris a Linux {.smaller}

-   Cada entitat al sistema t√© un **Identificador √önic** (UID) i un **Grup Primari** (GID).
-   Els recursos (fitxers, directoris, processos) s√≥n propietat d'un UID i un GID.
-   **Objectiu de Seguretat**: Implementar el **Principi de M√≠nims Privilegis (PoLP)**.
-   **Objectiu d'Auditoria**: Registrar i tra√ßar les accions de cada usuari.

::: fragment
| Rang | Categoria | Descripci√≥ | Pol√≠tica |
|:-----------------|:-----------------|:-----------------|:-----------------|
| **0** | **root** | Superusuari, privilegis absoluts | Evitar-ne l'√∫s directe |
| **1‚Äì999** | **Sistema** | dimonis, serveis (`nginx`, `mysql`) | Sense shell interactiu |
| **1000+** | **Humans** | Usuaris interactius, grups secundaris | PAM, auditoria |
| **65534** | **nobody** | Sense privilegis | A√Øllament de processos |
:::

## El Superusuari (`root`) {.smaller}

-   **UID 0** amb privilegis il¬∑limitats i acc√©s absolut a tots els fitxers i processos.
-   **Recomanaci√≥ de Seguretat**: **Evitar l'√∫s directe** de `root`.
    -   Un error com√®s per `root` pot ser catastr√≤fic.
    -   Augmenta el rastre d'auditoria de l'usuari real.

## Elevaci√≥ de Privilegis {.smaller}

-   **`sudo`**: Permet executar comandes com a un altre usuari (per defecte `root`).
    -   La configuraci√≥ es fa al fitxer `/etc/sudoers` mitjan√ßant **`visudo`**.
    -   Permet un control **granular**: qui, des d'on, i quines comandes pot executar.
-   **`su -c comanda`**: Permet executar una comanda com a un altre usuari incloent `root`.
    -   Requereix la contrasenya de l'usuari objectiu.
    -   No ofereix control granular ni registre detallat.

## Grups d'usuaris {.smaller}

-   Un grup √©s una col¬∑lecci√≥ d'usuaris que comparteixen permisos comuns en fitxers i directoris.
-   Cada usuari t√© un grup primari i pot pert√†nyer a m√∫ltiples grups.

::: fragment
``` bash
$ id usuari
uid=1001(usuari) gid=1001(usuari) groups=1001(usuari),27(sudo),1002(grup2)

$ groups usuari
usuari : usuari sudo grup2
```
:::

## Bases de dades {.smaller}

| Fitxer         | Propietari | Permisos | Contingut                           |
|:---------------|:-----------|:---------|:------------------------------------|
| `/etc/passwd`  | root       | 644      | uid, gid, comentari, shell (p√∫blic) |
| `/etc/shadow`  | root       | 600      | hashs de contrasenyes (secret)      |
| `/etc/group`   | root       | 644      | definicions de grups                |
| `/etc/gshadow` | root       | 600      | contrasenyes de grups (rares)       |

::: fragment
Cal comprovar regularment els permissos de:

``` bash
stat /etc/passwd /etc/shadow /etc/group
```
:::

## `/etc/passwd` {.smaller}

El fitxer `/etc/passwd` √©s un fitxer que cont√© la base de dades d‚Äôusuaris del sistema. Cada l√≠nia del fitxer descriu un compte d‚Äôusuari.

``` bash
$ less /etc/passwd
nom:clau:uid:gid:comentari:directori:shell
```

-   **nom**: Algunes versions limiten el nom a 8 car√†cters. Es recomana utilitzar m√≠niscules i n√∫meros.
-   **clau**: √âs un camp que ja no s‚Äôutilitza. La clau s‚Äôemmagatzema en `/etc/shadow`.
-   **uid**: N√∫mero intern associat al nom d‚Äôusuari.
-   **gid**: N√∫mero associat al grup principal de l‚Äôusuari. Cada identificador t√© la seva entrada a `/etc/group`.
-   **comentari**: Normalment s‚Äôutilitza per al nom complet de l‚Äôusuari o altres dades descriptives.
-   **directori**: Directori d‚Äôinici de l‚Äôusuari.
-   **shell**: Int√®rpret de comandes per defecte de l‚Äôusuari (per exemple, `/bin/bash`).

## `/etc/passwd`: nom {.smaller}

-   Ha de ser √∫nic.
-   No pot contenir els car√†cters `:`, `\n`
-   Es permet fins a 32 car√†cters. El primer car√†cter ha de ser **min√∫scula** o \_.
-   S‚Äôaccepten **maj√∫scules**, **min√∫scules, -, \_ i n√∫meros**.
-   Es recomana m√†xim 8 car√†cters per tenir compatibilitat amb *legacy systems*.
-   Es recomana no utilitzar maj√∫scules.
-   Es recomana no utilitzar nicknames.
-   Es recomana mantenir un esquema de noms.

## `/etc/group` {.smaller}

El fitxer `/etc/group` √©s un fitxer que cont√© la base de dades de grups del sistema. Cada l√≠nia del fitxer descriu un grup d‚Äôusuaris.

``` bash
$ less /etc/group
nom:clau:gid:llista_usuaris
```

-   **nom**: Nom del grup. Pot ser el mateix que el de l‚Äôusuari (si √©s l‚Äô√∫nic membre). S‚Äôaconsella min√∫scules i n√∫meros.
-   **clau**: Fa refer√®ncia a una contrasenya opcional pel grup. Un \* com a car√†cter inv√†lid impedeix que els usuaris normals canvi√Øn al grup. Una **x** fa refer√®ncia al fitxer de contrasenya separat `/etc/gshadow`. `gpasswd`
-   **gid**: N√∫mero intern associat al grup. Els nombres baixos es reserven pels grups de sistema. Els nombres 200, 500 o 1000 es troben els comptes normals.
-   **membres**: Una llista de noms d‚Äôusuaris separats per comes. Aquesta llista cont√© tots els usuaris que tenen aquest grup com a grup secundari, √©s a dir, que s√≥n membres d‚Äôaquest grup, per√≤ tenen un valor diferent del camp GID del seu `/etc/passwd`.

## `/etc/shadow` {.smaller}

El fitxer `/etc/shadow` √©s un fitxer que cont√© la informaci√≥ de les contrasenyes dels usuaris del sistema. Aquest fitxer √©s llegible nom√©s per l‚Äôusuari root i els processos amb privilegis elevats.

``` bash
$ less /etc/shadow
nom:password_hash:change:min:max:warn:grace:lock
```

| Camp | Descripci√≥ | Gesti√≥ |
|---------------|-------------------------------------------|---------------|
| password_hash | Hash (xifrat) de la contrasenya + salt. |  |
| change | Data de l'√∫ltim canvi (dies des de 01-01-1970). | `chage -m` |
| min | Dies m√≠nims entre canvis de contrasenya. | `chage -m` |
| max | Dies m√†xims abans de l'expiraci√≥. | `chage -M` |
| warn | Dies d'av√≠s abans de l'expiraci√≥. | `chage -W` |
| grace | Dies de gr√†cia despr√©s de l'expiraci√≥ abans de bloquejar el compte. | `chage -I` |
| lock | Data d'expiraci√≥ del compte (Bloqueig). | `chage -E` |

## Xifrat de Contrasenyes {.smaller}

Els sistemes moderns utilitzen algorismes de hashing forts amb salt.

-   **SHA-512**: El m√©s segur i actual (per defecte a Debian/RedHat).
-   **SHA-256**: Encara com√∫.
-   **MD5**: Considerat insegur (Legacy).

::: fragment
Normalment el xifrat es configura a `/etc/login.defs` o `/etc/pam.d/common-password`. M√©s endavant veurem PAM i els seus m√≤duls com `pam_pwquality.so`.
:::

::: fragment
Fins al moment, els algorismes de xifratge atorguen una seguretat adequada per a la majoria d‚Äôaplicacions. Per a entorns amb requisits de seguretat m√©s estrictes, es poden utiltizar m√®todes addicionals com l‚Äôautenticaci√≥ de dos factors (2FA) o l‚Äô√∫s de tokens de seguretat. La **computaci√≥ qu√†ntica** podria afectar els algorismes actuals en el futur, per√≤ encara no √©s una amena√ßa immediata per a la majoria dels sistemes.
:::

# Gestio d'usuaris i grups

## `useradd` {.smaller}

Creaci√≥ d‚Äôun nou compte d‚Äôusuari amb `useradd [opcions] [nom_usuari]`.

| Opci√≥ | Clau | Descripci√≥ | Aplicaci√≥ |
|:-----------------|:-----------------|:-----------------|:-----------------|
| -c *comentari* | Comentari | Nom complet o informaci√≥ addicional. | Identificaci√≥ d‚Äôusuaris. |
| -e `YYYY-MM-DD` | Expiraci√≥ | Data de caducitat del compte. | Comptes temporals. |
| -g grup | Grup Primari | Assigna el grup primari de l‚Äôusuari. | Gesti√≥ de permisos. |
| -k `/directori/skel` | Esquelet | Especifica un directori d‚Äôesquelet diferent. | Configuraci√≥ personalitzada. |
| -m | Crea Home | Crea el directori home si no existeix. | A√Øllament d‚Äôusuaris. |

## `usermod` i `userdel` {.smaller}

-   La comanda `usermod` permet modificar un compte d‚Äôusuari existent amb `usermod [opcions] [nom_usuari]`. Les opcions s√≥n similars a les de `useradd`. Per veure les opcions `man usermod`.

-   La comanda `userdel` permet eliminar el compte d'un usuari amb `userdel [-r] [nom_usuari]` . L'argument `r` elimina el directori `home`i la b√∫stia de correu de l'usuari.

-   La comanda `userdel` no elimina les dades relacionades amb les tasques **cron** (`crontabs`).

## `passwd` (Gesti√≥ de Contrasenyes I) {.smaller}

``` bash
passwd
$ passwd
Changing password for jmateo.
(current) UNIX password:12345678
Enter new UNIX password:87654321
Retype new UNIX password:87654321
passwd: password updated successfull
# Show info
$ passwd -S jmateo
# Lock the account
$ passwd -l jmateo
# Unlock the account
$ passwd -u jmateo
# Password change at most every 7 days
$ passwd -n 7 jmateo
# Password change at least every 30 days
$ passwd -x 30 jmateo
# 3 days grace period before password expires
$ passwd -w 3 jmateo
```

## `chage` (Gesti√≥ de Contrasenyes II) {.smaller}

``` bash
# Lock account from 1 Dec 2009
$ chage -E 2009-12-01 jmateo
# Cancel expiry date
$ chage -E -1 jmateo
# Grace period 1 week from password expiry
$ chage -I 7 jmateo
# Like passwd -n
$ chage -m 7 jmateo
# Like passwd -x
$ chage -M 7 jmateo
# Like passwd -w
$ chage -W 3 jmateo
```

## Exemples de comandes (usuaris) {.smaller}

``` bash
# Crear usuari amb opcions de seguretat avan√ßada
sudo useradd -m -d /home/ana -s /bin/bash \
    -c "Ana Garc√≠a" -g developers -G sudo,docker \
    -e 2025-12-31 -f 7 ana

# Modificar data de caducitat
sudo usermod -e 2025-06-30 ana

# Bloquejar/desbloquejar compte
sudo passwd -l ana          # Lock
sudo passwd -u ana          # Unlock

# Consultar estat de la contrasenya i pol√≠tiques
sudo chage -l ana
```

**Recomanaci√≥:** Manualment, revisar UIDs actius: `awk -F: '$3 >= 1000 {print}' /etc/passwd`

## Gesti√≥ de Grups {.smaller}

``` bash
$ groupadd [-g GID] [group name]
# Modificaci√≥ del grup: -g modifica el GID,
# -n actualitza el nom.
$ groupmod [-g GID] [-n nom] [group name]
# Eliminant grups
$ grupdel [group name]
# Afegint un usuari a un grup
$ gpasswd -a [user] [group]
# Eliminant l‚Äôusuari del grup
$ gpasswd -d [user] [group]
```

-   Un compte d'usuari pot pert√†nyer a m√∫ltiples grups secundaris.
-   Un compte d'usuari nom√©s pot tenir un grup primari.
-   El grup primari s'especifica al camp GID del fitxer `/etc/passwd`.

## Exemples de comandes (grups) {.smaller}

``` bash
# Crear grup amb GID espec√≠fic
sudo groupadd -g 2001 devops

# Afegir usuari a grup secundari sense perdre altres
sudo usermod -aG devops,docker,audit ana

# Consultar grups de l'usuari
id ana
groups ana

# Canviar temporalment el grup
newgrp devops

# Llistar membres d'un grup
getent group devops
```

# Autoritzaci√≥ a Linux

## Permisos cl√†ssics Unix {.smaller}

``` bash
drwxr-xr-x  3 joan developers 4096 Oct 15 10:20 project/
‚îÇ‚îÇ  ‚îÇ ‚îî‚îÄ others: r-x (lectura, acc√©s)
‚îÇ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ group: r-x (lectura, acc√©s)
‚îÇ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ owner: rwx (total)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ type: d (directori)
```

-   Cada fitxer i directori t√© associats tres tipus de permisos:
    -   **Read (r)**: Permet llegir el contingut del fitxer o llistar el contingut del directori.
    -   **Write (w)**: Permet modificar el contingut del fitxer o crear/eliminar fitxers dins del directori.
    -   **Execute (x)**: Permet executar el fitxer com un programa o accedir als fitxers dins del directori.
-   Els permisos s'apliquen a tres categories d'usuaris:
    -   **Owner (u)**: L'usuari propietari del fitxer o directori.
    -   **Group (g)**: Els usuaris que pertanyen al grup associat al fitxer o directori.
    -   **Others (o)**: Tots els altres usuaris del sistema.

## `chmod`: Canviant permisos {.smaller}

-   La comanda `chmod` s'utilitza per canviar els permisos d'un fitxer o directori.

::: fragment
``` bash
chmod [opcions] mode fitxer/directori
```
:::

-   El mode es pot especificar de dues maneres:
    -   **Simbolica**: Utilitza lletres per representar usuaris i permisos.
        -   Exemple: `chmod u+rwx,g+rx,o-r file.txt`
    -   **Octal**: Utilitza n√∫meros per representar els permisos.
        -   Exemple: `chmod 755 file.txt` (rwxr-xr-x)

## Exmmples pr√†ctics `chmod` (I)

``` bash
jordi@debianlab:~$ chmod +x a.txt
jordi@debianlab:~$ ls -la a.txt
-rwxr-xr-x 1 jordi jordi 0 11 de jul.  11:26 a.txt
jordi@debianlab:~$ chmod -x a.txt
jordi@debianlab:~$ ls -la a.txt
-rw-r--r-* 1 jordi jordi 0 11 de jul.  11:26 a.txt
jordi@debianlab:~$ chmod o-r a.txt
jordi@debianlab:~$ ls -la a.txt
-rw-r----* 1 jordi jordi 0 11 de jul.  11:26 a.txt
jordi@debianlab:~$ chmod g+w a.txt
jordi@debianlab:~$ ls -la a.txt
-rw-rw---* 1 jordi jordi 0 11 de jul.  11:26 a.txt
jordi@debianlab:~$ chmod o+w a.txt
jordi@debianlab:~$ ls -la a.txt
-rw-rw--w* 1 jordi jordi 0 11 de jul.  11:26 a.txt
```

## Exmmples pr√†ctics `chmod` (II)

``` bash
jordi@debianlab:~$ chmod a-w a.txt
jordi@debianlab:~$ ls -la a.txt
-r--r----* 1 jordi jordi 0 11 de jul.  11:26 a.txt
jordi@debianlab:~$ echo "a" >> a.txt
-bash: a.txt: S‚Äôha denegat el perm√≠s
jordi@debianlab:~$ cat a.txt
jordi@debianlab:~$ chmod +w a.txt
jordi@debianlab:~$ echo "a" >> a.txt
jordi@debianlab:~$ cat a.txt
a
jordi@debianlab:~$ chmod -r a.txt
jordi@debianlab:~$ cat a.txt
cat: a.txt: S‚Äôha denegat el perm√≠s
```

## `chown` i `chgrp`: Canviant propietaris i grups {.smaller}

-   La comanda `chown` s'utilitza per canviar el propietari d'un fitxer o directori.

::: fragment
``` bash
chown [opcions] nou_propietari fitxer/directori
```
:::

-   La comanda `chgrp` s'utilitza per canviar el grup associat a un fitxer o directori.

::: fragment
``` bash
chgrp [opcions] nou_grup fitxer/directori
```
:::

## Comandes B√†siques {.smaller}

``` bash
# Canviar permisos (simb√≤lic i octal)
chmod u+rwx,g+rx,o-r fitxer        # Simb√≤lic
chmod 750 fitxer                   # Octal: rwxr-x---

# Canviar propietari i grup
sudo chown joan:developers fitxer
sudo chgrp developers fitxer

# Aplicar recursivament 
## -R per recursiu
## --changes per mostrar canvis
sudo chmod -R 750 /home/joan --changes
```

## `umask` {.smaller}

-   La `umask` (user file-creation mode mask) √©s un valor que determina els permisos per defecte dels fitxers i directoris nous creats per un usuari.

::: fragment
``` bash
# Umask actual (resta de 777/666)
umask                              # Ex: 0022

# Crear fitxer: 666 - 022 = 644 (rw-r--r--)
# Crear directori: 777 - 022 = 755 (rwxr-xr-x)

# Canviar umask per sessi√≥ (segura)
umask 0077                         # Els nous arxius: -rw------- (600)

# Configurar permanent a ~/.bashrc
echo "umask 0077" >> ~/.bashrc
```
:::

::: fragment
S'aconsella utilitzar una umask 0002 en entorns on els usuaris treballen en grups, ja que permet als membres del grup escriure als fitxers creats per altres membres del mateix grup. Aix√≤ facilita la col¬∑laboraci√≥ i l'intercanvi de fitxers dins del grup.
:::

## Permisos especials {.smaller}

-   **Setuid (s)**: Quan s'aplica a un fitxer executable, permet que el programa s'executi amb els privilegis del propietari del fitxer.
-   **Setgid (s)**: Quan s'aplica a un fitxer executable, permet que el programa s'executi amb els privilegis del grup del fitxer. Quan s'aplica a un directori, els fitxers creats dins d'aquest directori hereten el grup del directori.
-   **Sticky bit (t)**: Quan s'aplica a un directori, nom√©s el propietari del fitxer o el propietari del directori poden eliminar o renombrar fitxers dins d'aquest directori.

::: fragment
``` bash
# Exemple de permisos especials
chmod u+s programa   # Setuid
chmod g+s directori  # Setgid
chmod +t directori   # Sticky bit
```
:::

## Setuid (s): Executar com a propietari {.smaller}

``` bash
# El programa 'passwd' s'executa com a root
ls -l /usr/bin/passwd
-rwsr-xr-x  1 root root 68208 /usr/bin/passwd

# Permetre a programa espec√≠fic operar com a root
sudo chmod u+s /usr/local/bin/myscript
```

Els programes amb setuid poden ser un vector d'atac si tenen vulnerabilitats. Es important auditar-los peri√≤dicament.

``` bash
find / -perm -4000 -type f 2>/dev/null | sort
```

## Setgid (s): Her√®ncia de grup en directoris {.smaller}

``` bash
# Col¬∑laboraci√≥: Els fitxers nous hereten el grup del directori
sudo mkdir /srv/projectX
sudo chgrp developers /srv/projectX
sudo chmod g+s /srv/projectX           # setgid activat
sudo chmod g+w /srv/projectX

# Tots els fitxers creats dins seran del grup developers
```

## Sticky bit (t): Protecci√≥ en `/tmp` {.smaller}

``` bash
# Nom√©s el propietari pot eliminar el seu fitxer
ls -ld /tmp
drwxrwxrwt 12 root root 4096 /tmp

# Aplicar sticky a directori compartit
sudo chmod +t /srv/shared
```

## Limitacions del model tradicional {.smaller}

**Problema:** Tres usuaris (alice, bob, charlie) necessiten permisos diferents sobre un fitxer, per√≤ el model tradicional nom√©s permet propietari, grup, altres.

``` bash
alice ‚Üí R (read)
bob   ‚Üí RW (read, write)
charlie ‚Üí (cap acc√©s)
```

::: {.fragment .center}
**Soluci√≥:** ACL (Access Control Lists)
:::

## ACLs: Permissos granulars {.smaller}

-   Les **Access Control Lists (ACLs)** permeten definir permisos m√©s detallats per a usuaris i grups espec√≠fics.
-   El problema dels permisos tradicionals √©s que nom√©s permeten definir permisos per a l'usuari propietari, el grup i els altres usuaris.
-   Les ACLs permeten assignar permisos a m√∫ltiples usuaris i grups per a un mateix fitxer o directori.

::: fragment
``` bash
# Comandes b√†siques per gestionar ACLs
setfacl -m u:usuari:rwx fitxer      # Assigna permisos rwx a un usuari espec√≠fic
getfacl fitxer                      # Mostra les ACLs
setfacl -x u:usuari fitxer          # Elimina les ACLs d'un usuari espec√≠fic
setfacl -d -m g:grup:rwx directori  # Assigna permisos per defecte a un grup en un directori per als fitxers nous
```
:::

## Introducci√≥ a les ACL {.smaller}

``` bash
# Veure ACL actual
getfacl /srv/dades.txt

# file: /srv/dades.txt
# owner: root
# group: developers
user::rw-
user:alice:r--
user:bob:rw-
group::r--
mask::rw-
other::---
```

## Assignaci√≥ granular d'ACL {.smaller}

``` bash
# Donar lectura a usuari espec√≠fic
setfacl -m u:alice:r /srv/dades.txt

# Donar lectura i escriptura a grup
setfacl -m g:teamX:rw /srv/dades.txt

# Permetre execuci√≥ a un usuari
setfacl -m u:bob:rwx /srv/script.sh

# Eliminar ACL d'usuari
setfacl -x u:alice /srv/dades.txt
```

## ACL per defecte en directoris {.smaller}

``` bash
# ACL per defecte: nous fitxers hereten permisos
sudo mkdir /srv/shared
sudo setfacl -d -m u:alice:rx /srv/shared
sudo setfacl -d -m g:devops:rwx /srv/shared

# Verificar her√®ncia
touch /srv/shared/testfile.txt
getfacl /srv/shared/testfile.txt
```

La herencia d'ACL √©s especialment √∫til en entorns col¬∑laboratius on diversos usuaris necessiten accedir i modificar fitxers dins d'un directori compartit. Permet establir pol√≠tiques de permisos coherents i assegurar que els nous fitxers i directoris creats dins del directori heretin els permisos adequats.

------------------------------------------------------------------------

## M√†scara i preced√®ncia d'ACL {.smaller}

``` bash
# La m√†scara limita permisos m√†xims efectius
setfacl -m m::rx /srv/dades.txt     # Limita ACL a r-x
```

L'ordre de preced√®ncia:

1.  ACL de l'usuari propietari
2.  ACL espec√≠fic de l'usuari
3.  M√†scara
4.  ACL del grup propietari
5.  ACL de grup espec√≠fic
6.  Altres

Aquesta jerarquia assegura que els permisos m√©s espec√≠fics tinguin prioritat sobre els m√©s generals.

## Auditor√≠a i migracions d'ACL {.smaller}

``` bash
# Exportar ACL per backup
getfacl -R /srv/dades > acl_backup.txt

# Restaurar ACL
setfacl --restore=acl_backup.txt

# Identificar fitxers amb ACL no est√†ndar
find /home -type f -exec sh -c 'getfacl {} | grep -q "^user:" && echo {}' \;
```

# Elevaci√≥ de privilegis: sudo, setuid i capabilities

## `sudo` {.smaller}

-   `sudo` permet executar comandes amb els privilegis d'un altre usuari (per defecte `root`).
-   La configuraci√≥ es fa al fitxer `/etc/sudoers` mitjan√ßant l'eina `visudo`.
-   Permet un control **granular**: qui, des d'on, i quines comandes pot executar.

::: fragment
``` bash
# Configuraci√≥ a /etc/sudoers (editar amb 'visudo')
joan ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart apache2

# Sintaxi: user host=(runasuser) [NOPASSWD:] command
```
:::

::: fragment
L'usuari `joan` pot reiniciar el servei `apache2` sense necessitat de proporcionar la contrasenya.
:::

## Control granular de permisos {.smaller}

``` bash
# Definir alias per a reutilitzaci√≥
Cmnd_Alias RESTART = /usr/bin/systemctl restart *, /usr/bin/systemctl reload *
User_Alias SYSADMINS = joan, anna, pere
Host_Alias SERVERS = web01, web02

# Pol√≠tica: els sysadmins poden reiniciar serveis sense password
SYSADMINS SERVERS = NOPASSWD: RESTART

# Restricci√≥ per hora (integrada amb PAM)
joan web01 = (root) Cmnd=/usr/sbin/reboot [1-5/09:00-18:00]
```

## Auditor√≠a d'√∫s de `sudo` {.smaller}

``` bash
# Configurar log detallat a /etc/sudoers
Defaults logfile="/var/log/sudo.log"
Defaults log_output

# Visualitzar comandos executades
sudo journalctl SYSLOG_IDENTIFIER=sudo | head -20

# Script per auditar √∫s sospit√≥s
grep COMMAND /var/log/sudo.log | grep -E "(rm|dd|chmod|chown)"
```

## Capabilities: alternatives a setuid {.smaller}

``` bash
# En lloc de setuid root, es pot utilitzar capabilities
# Exemple: ping no necessita root complet
getcap /usr/bin/ping

# Si es necessita, assignar capability espec√≠fica
sudo setcap cap_net_raw+p /usr/bin/ping

# Capabilities comunes
# CAP_NET_BIND_SERVICE: obrir ports < 1024
# CAP_SYS_ADMIN: admin del sistema (omnibus)
# CAP_SETUID: canviar UID
# CAP_DAC_OVERRIDE: ignorar DAC
```

**Avantatge:** Menor superf√≠cie d'atac que setuid.

## Namespaces d'usuari i contenidors

``` bash
# Crear namespace d'usuari per a√Øllament
unshare --user --map-root-user --mount-proc bash

# Dins del namespace: sou root (UID 0 local)
# Per√≤ sense privilegis globals del sistema

# Fonament de contenidors: processos a√Øllats per UID
docker run --user=nobody:nogroup ubuntu id
# uid=65534(nobody) gid=65534(nogroup)
```

**Cas d'√∫s:** A√Øllament de microserveis i entorns CI/CD.

## Exercicis Propostas

-   [Lord of the system](../exercises/04-accounts/01-lord-of-system.qmd)