---
title: "Arrencada del sistema (Part 1)"
subtitle: "Unitat 2 ¬∑ Administraci√≥ i Manteniment de Sistemes i Aplicacions (AMSA)"
author: "Jordi Mateo Forn√©s"
logo: "/figs/corporative/institute.png"
format: 
  revealjs:
    transition: fade
    slide-number: true
    incremental: true 
    chalkboard: false
    css: styles.css
    footer: "Unitat 2 ¬∑ Administraci√≥ i Manteniment de Sistemes i Aplicacions (AMSA) [üè†](/index.html)</a>"
editor: visual

execute:
  freeze: auto
  echo: false
---

## Etapes de l'arrancada

![](../figs/slides/02-booting/linux-unix-booting-process.png)

## Fase 1: M√†quinaria {.smaller}

-   En pr√©mer el bot√≥ d'encesa, la placa base envia un senyal a la PSU (*Power Supply Unit*).
-   La PSU proporciona tensi√≥ estable a tots els components i activa la CPU.
-   La CPU inicialitza registres interns i col¬∑loca el Puntador d'Instrucci√≥ (**EIP**) a la direcci√≥ de reset `0xFFFFFFF0`.

![](../figs/slides/02-booting/fase1.png)

::: fragment
Aquesta adre√ßa cont√© una instrucci√≥ de salt (`jmp`) que redirigeix la CPU al Firmware (**BIOS/UEFI**) per iniciar el proc√©s de diagn√≤stic i arrencada del sistema (POST).
:::

## Fase 2: Firmware {.smaller}

El teu ordinador necessita un firmware per: *provar, detectar, configurar i inicialitzar dispositius*. Aquest firmware en sistemes moderns √©s l'**UEFI** i en sistemes antics el **BIOS** (normalment compatibles amb IBM PC). 

![](../figs/slides/02-booting/fase2.png)


> You‚Äôve probably read a lot of stuff on the internet about UEFI.
> Here is something important you should understand: 95% of it was probably garbage.
> ‚Äî [Adam Williamson](https://amsa.lol/weeks/week-1.html#/what-is-the-biosuefi:~:text=Such%20as%20Adam%20Williamson%20says%3A)

## Fase 2: Etapes {.smaller}

1. **Inicialitzaci√≥ del firmware**
   
   - Carrega i execuci√≥ del codi de firmware (BIOS/UEFI).
   - Lectura de la configuraci√≥ de la NVRAM.
   - Verificaci√≥ de la integritat del firmware.

2. **Diagn√≤stic i detecci√≥**
   
   - Power-On Self Test (POST): comprovaci√≥ de CPU, RAM, gr√†fics b√†sics‚Ä¶
   - Detecci√≥ i inicialitzaci√≥ dels dispositius connectats.
   - Aplicaci√≥ de la configuraci√≥ als dispositius.

3. **Arrencada del sistema**

   - Selecci√≥ del dispositiu d‚Äôarrencada.
   - C√†rrega del bootloader de primera etapa.
   - Transfer√®ncia del control al bootloader.


## Actualitzaci√≥ del firmware {.smaller}

El firmware est√† emmagatzemat en un xip de mem√≤ria flash a la placa base. L‚Äôactualitzaci√≥ (**flashing**) substitueix el contingut d‚Äôaquest xip per una versi√≥ nova.

::: columns 
::: {.column width="50%"}
### üöÄ Objectius 
-   Corregir errades de microcodi de la CPU.
-   Afegir suport per a nou maquinari (CPU, RAM, targetes).
-   Aplicar parches de seguretat (ex.: vulnerabilitats [Spectre](https://es.wikipedia.org/wiki/Spectre_(vulnerabilidad))/[Meltdown](https://es.wikipedia.org/wiki/Meltdown_(vulnerabilitat)).
-   Millorar funcions de gesti√≥ d‚Äôenergia i arrencada segura ([Secure Boot](https://es.wikipedia.org/wiki/Secure_Boot)).
:::
::: {.column width="50%"}
### ‚ö†Ô∏è Riscos
-   Un error en el proc√©s (tall de corrent, imatge corrupta, versi√≥ incorrecta) pot deixar el xip inservible (brick).
-   Alguns fabricants ofereixen mecanismes de recuperaci√≥ (dual BIOS, [BIOS flashback](https://www.asus.com/es/support/faq/1038568/), [c√†psules UEFI](https://www.preprints.org/manuscript/202502.1245/v1)).
-   En entorns de producci√≥, √©s recomanable validar la nova versi√≥ en un entorn de test abans de desplegar-la.
:::
:::


## Difer√®ncies entre BIOS i UEFI (I) {.smaller}

| Caracter√≠stica                   | BIOS                                                    | UEFI                                                                    |
| -------------------------------- | ------------------------------------------------------- | ----------------------------------------------------------------------- |
| **Emmagatzematge**         | Tradicionalment en **ROM** (avui dia flash EEPROM) | **Flash SPI** a la placa base + **EFI System Partition (ESP)** al disc     |
| **Capacitat de disc**            | Fins a 2,2 TB (per limitaci√≥ 32-bit LBA, sectors 512 B) | Fins a 9,4 ZB (GPT)                                                     |
| **Interf√≠cie**                   | Text                                                    | Gr√†fica, amb suport per ratol√≠ i resolucions altes                      |
| **Seguretat**                    | Sense proteccions avan√ßades                             | Secure Boot, verificaci√≥ de signatures i protecci√≥ contra codi malici√≥s |
| **Compatibilitat**               | Principalment IBM PC compatibles antics                 | Compatible amb sistemes moderns, amb suport per *Legacy BIOS* via CSM   |

## Difer√®ncies entre BIOS i UEFI (II) {.smaller}


| Caracter√≠stica                   | BIOS                                                    | UEFI                                                                    |
| -------------------------------- | ------------------------------------------------------- | ----------------------------------------------------------------------- |  
| **Velocitat d‚Äôarrencada**        | M√©s lenta                                               | M√©s r√†pida gr√†cies a inicialitzaci√≥ paral¬∑lela de drivers i *fast boot* |
| **Taula de particions** | MBR                                                     | GPT                                                                     |
| **Nombre m√†xim de particions**   | 4 prim√†ries (amb l√≤giques dins d‚Äôestesa)                | Fins a 128 entrades de particions                                       |
| **Modularitat**                  | Monol√≠tica                                              | Modular, permet afegir drivers, aplicacions i extensions UEFI           |


## Taula de particions MBR {.smaller}

:::::: columns
:::: {.column width="50%"}
### Estructura

-   **Bootloader de primera etapa (446 bytes)**: Cont√© el codi d'arrencada.
-   **Taula de particions (64 bytes)**: Cont√© la informaci√≥ de les particions. Pot contenir fins a 4 entrades.
-   **Signatura (2 bytes)**: Marca de final de la taula de particions. Permet identificar la taula de particions com a v√†lida.

::: {.fragment .callout-important title="L√≠mitaci√≥"}
1. Com MBR utiltiza entrades de 32 bits per blocs l√≤gics (LBA) ‚Üí  $2^{32}$ sectors √ó $512 B = 2 TB$ aproximadament.
2. Nom√©s suporta 4 particions prim√†ries.
:::

::::
::: {.column width="50%"}
![](../figs/slides/02-booting/MBR.png)
:::
::::::

## Particions MBR (I) {.smaller}

1. **Particions prim√†ries**

   - Fins a 4 per disc.
   - Contenen directament un sistema de fitxers (ext4, NTFS, FAT32).
   - Pot tenir un Volume Boot Record (**VBR**) que carrega el sistema operatiu de la partici√≥.

2. **Partici√≥ estesa**
  
   - Una partici√≥ prim√†ria especial per superar la limitaci√≥ de 4 prim√†ries.
   - No cont√© sistema de fitxers ni **VBR**; actua com a contenidor de particions l√≤giques.

3. **Particions l√≤giques**
    - Resideixen dins de la partici√≥ estesa.
    - Cada partici√≥ l√≤gica t√© un Extended Boot Record (**EBR**) amb la seva taula de particions.
    - La linked list d‚ÄôEBRs permet afegir din√†micament m√©s particions l√≤giques.
    - Pot contenir un VBR per carregar el sistema operatiu


## Particions MBR (II) {.smaller}

![](../figs/slides/02-booting/particionsMBR.png)

## Taula de particions GPT (I){.smaller}

1. Compatibilitat i protecci√≥
   - Bloqueja utilitats basades en MBR per no sobreescriure un disc GPT.
   - Cont√© una √∫nica partici√≥ especial que identifica el disc com GPT.
   - OS i eines que no suporten GPT reconeixen el disc, per√≤ normalment no el modifiquen.

2. GPT Header Primari
    - Situat al segon sector del disc (LBA 1).
    - Defineix els blocs utilitzables del disc.
    - Cont√© la taula de particions (m√≠nim 128 entrades, 128 B cadascuna).

3. GPT Header Secundari
    - C√≤pia de seguretat del Primary GPT Header.
    - Situat als √∫ltims sectors del disc.
    - Permet recuperar la informaci√≥ si el Primary Header est√† corrupte.


## Taula de particions GPT {.smaller}

::: center-container
![](../figs/slides/02-booting/particions-gpt.png){ width=60% }
:::

## Qu√® √©s UEFI? (I){.smaller}

- **Sistema de fitxers propi**
   - UEFI no utilitza MBR tradicional de *512 B* ni codi de boot limitat.
   - Disposa d‚Äôun filesystem propi (FAT32, *100 a 550 MB*) anomenat EFI System Partition (**ESP**).
   - La partici√≥ EFI √©s marcada amb boot flag, per√≤ mai cont√© OS partitions.
- **Estructura de la partici√≥ EFI**
   - Cada OS t√© la seva carpeta dins de la ESP.
   - Cont√© tots els fitxers necessaris per carregar el sistema operatiu.
   - En Linux, la ESP sovint es munta sota `/boot/efi`.

::: {.fragment}
```sh
/
‚îú‚îÄ‚îÄ boot
‚îÇ   ‚îú‚îÄ‚îÄ efi
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EFI
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BOOT
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BOOTX64.EFI
```
:::

## Qu√® √©s UEFI? (II){.smaller}

- **Mini sistema operatiu**
    - UEFI √©s com un mini sistema operatiu.
      - Executa fitxers en format EFI executable.
      - Permet drivers i aplicacions independents del SO.
    - Quan escrius un bootloader natiu UEFI, has de respectar aquest format.

- **UEFI Boot Manager**
    - Motor de pol√≠tica del firmware per arrencada.
    - Configurable via variables globals a NVRAM.
    - Carrega drivers UEFI i aplicacions UEFI (incloent OS bootloaders) en l‚Äôordre definit per les variables.
    - Linux disposa de l‚Äôeina `efibootmgr` per modificar la configuraci√≥ del boot manager.

## M√≤duls de la UEFI {.smaller}

![](../figs/slides/02-booting/UEFI-BOOT.png)

## `efibootmgr`  {.smaller}

``` sh
# efibootmgr -v
BootCurrent: 0002
Timeout: 3 seconds
BootOrder: 0003,0002,0000,0004
Boot0000* CD/DVD Drive  BIOS(3,0,00)
Boot0001* Hard Drive    HD(2,0,00)
Boot0002* Fedora        HD(1,800,61800,6d98f360-cb3e-4727-8fed-5ce0c040365d)File(\EFI\fedora\grubx64.efi)
Boot0003* opensuse      HD(1,800,61800,6d98f360-cb3e-4727-8fed-5ce0c040365d)File(\EFI\opensuse\grubx64.efi)
Boot0004* Hard Drive    BIOS(2,0,00)P0: ST1500DM003-9YN16G 
```

- Les entrades **Boot0000 i Boot0004** corresponen a modes de compatibilitat **BIOS (CSM)**, no s√≥n natives-  d‚ÄôUEFI.
- Generades autom√†ticament pel firmware, sense intervenci√≥ externa.
- S‚Äôafegeixen directament a les variables NVRAM del sistema.
- Entrades UEFI natives (**Boot0002, Boot0003**) apunten directament als fitxers EFI dels OS:
  - Fedora : `\EFI\fedora\grubx64.efi`
  - openSUSE: `\EFI\opensuse\grubx64.efi`
- L‚Äôordre d‚Äôarrencada es defineix a la variable `BootOrder`.

## Qu√® √©s la consola de la UEFI? {.smaller}

La **consola de la UEFI** √©s una interf√≠cie de l√≠nia de comandes que permet interactuar directament amb el firmware UEFI per realitzar tasques avan√ßades de diagn√≤stic, configuraci√≥ i manteniment del sistema.

::::: columns
::: {.column width="50%"}
### Funcions

- Configuraci√≥ del maquinari i perif√®rics (CPU, mem√≤ria, dispositius PCIe).
- Comprovaci√≥ del funcionament dels dispositius i diagn√≤stic de fallades.
- Acc√©s als sistemes de fitxers EFI i gesti√≥ de fitxers de boot.
- Instal¬∑laci√≥, reparaci√≥ o actualitzaci√≥ de bootloaders i OS.
- Execuci√≥ de aplicacions UEFI natives (mini-aplicacions tipus OS).
:::

::: {.column width="50%"}
### Acc√©s

- Prement una tecla durant l‚Äôengegada del sistema, segons el fabricant: **F2, F10, F12, ESC o Supr**.
- Des de sistemes operatius:
  - Linux: `efibootmgr` o `systemctl reboot --firmware-setup`.
  - Windows: Opci√≥ Advanced Startup i UEFI Firmware Settings.
  - macOS: Reboot amb Option/Alt.

:::
:::


## Comandes de la consola de la UEFI {.smaller}

| Comanda  | Funci√≥                                                             | Exemple                                                   |
| -------- | ------------------------------------------------------------------ | --------------------------------------------------------- |
| **map**  | Mostra els dispositius detectats i les unitats l√≤giques associades | `map fs*` ‚Üí llista tots els sistemes de fitxers detectats |
| **mem**  | Mostra l‚Äô√∫s de mem√≤ria i mapa f√≠sic de la RAM                      | `memmap` ‚Üí mapa detallat de la mem√≤ria f√≠sica             |
| **ls**   | Llista fitxers i directoris dins un FS accessible                  | `ls fs0:\EFI\Boot` ‚Üí mostra fitxers de la partici√≥ EFI    |
| **cd**   | Navegar entre carpetes dins del FS                                 | `cd EFI\Boot` ‚Üí mou a la carpeta d‚Äôarrencada EFI          |
| **cp**   | Copiar fitxers entre unitats o directoris                          | `cp fs0:\EFI\Boot\bootx64.efi fs1:\EFI\Backup\`           |
| **edit** | Editar fitxers, √∫til per configurar scripts d‚Äôarrencada            | `edit fs0:\EFI\Boot\bootx64.efi`                          |


## Import√†ncia de la partici√≥ EFI

- Punt de partida per a l‚Äôarrencada del sistema operatiu.
- Essencial per a l‚Äôarrencada dels sistemes UEFI.
- Cont√© fitxers cr√≠tics per carregar el bootloader de segona etapa, com:
  - GRUB (Linux)
  - Gestor d‚Äôarrencada de Windows
- Permet tenir m√∫ltiples sistemes operatius en el mateix disc.
- Facilita la gesti√≥ i actualitzaci√≥ de bootloaders sense afectar les particions del sistema operatiu.

## Arrencar sense partici√≥ EFI

- Te√≤ricament possible: configurar UEFI per carregar el bootloader directament des del disc dur.
- Poc com√∫ i no recomanat, ja que:
  - Complica la gesti√≥ dels sistemes operatius.
  - Impedeix actualitzacions i reparacions autom√†tiques dels bootloaders.
- La partici√≥ EFI proporciona un punt centralitzat i est√†ndard per a tots els fitxers d‚Äôarrencada.

## Tipus de bootloaders

1.  **Bootloader de primera etapa**: Carregat directament pel firmware (BIOS/UEFI). S'encarrega de carregar el bootloader de segona etapa.
2.  **Bootloader de segona etapa**: Carregat pel bootloader de primera etapa. S'encarrega de carregar el sistema operatiu.

::: {.fragment}
En sistemes UEFI, el bootloader de primera etapa √©s un fitxer executable en format EFI (per exemple, `grubx64.efi` per a GRUB). Mentre que en sistemes BIOS, el bootloader de primera etapa es troba en el MBR del disc. 
:::

## Funcions del bootloader

Un **bootloader** √©s el programa encarregat de:

1.  Mostrar un men√∫ amb les diverses opcions d'arrencada disponibles.
2.  Carregar el nucli (kernel) i l'Initrd (si s'escau) a la mem√≤ria principal.
3.  El kernel de linux t√© una [convenci√≥ d'arrencada](https://github.com/torvalds/linux/blob/v4.16/Documentation/x86/boot.txt) on el **bootloader** ha de preparar el mapa de mem√≤ria i els registres de la CPU abans de transferir el control al nucli.



## Diferents gestors d'arrencada {.smaller}

| Bootloader               | Compatibilitat | Caracter√≠stiques principals                                                |
| ------------------------ | -------------- | -------------------------------------------------------------------------- |
| **LILO**                 | BIOS           | Antic bootloader Linux, obsolet.                                           |
| **GRUB**                 | BIOS/UEFI      | Popular en Linux; men√∫ configurable; suport multiboot.                     |
| **GRUB2**                | BIOS/UEFI      | Versi√≥ moderna; suport FAT, NTFS, ext4; millor multiboot i scripting.      |
| **rEFInd**               | UEFI           | Permet arrencar m√∫ltiples OS; interf√≠cie gr√†fica amigable.                 |
| **systemd-boot**         | UEFI           | Simple i r√†pid; integraci√≥ amb systemd; no recomanat per multiboot.        |
| **Windows Boot Manager** | UEFI           | Gestiona arrencada de Windows i altres OS compatibles; integraci√≥ amb BCD. |

## Exercicis Propostas

- [Booting amb MBR i BIOS](../exercises/02-booting/01-ex-week2.qmd)
- [Booting amb UEFI](../exercises/02-booting/02-ex-week2.qmd)
- [Dual Boot amb UEFI](../exercises/02-booting/03-ex-week2.qmd)


## That's all

::::::: columns
:::: {.column width="45%"}
::: {.callout-note title="Take Home Message"}
El proc√©s d'arrencada √©s un proc√©s complex. Els administradors de sistemes han de con√®ixer aquest proc√©s per poder gestionar i solucionar problemes durant l'arrencada del sistema i garantir un sistema segur, estable i eficient.
:::
::::

::: {.column width="5%"}
:::

::: {.column width="50%"}
![](https://static.posters.cz/image/750/posters/looney-tunes-thats-all-folks-i295.jpg){width="70%"}
:::
:::::::

