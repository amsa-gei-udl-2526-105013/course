---
title: "Pràctica 01: Snapshots i restauració amb systemd i initramfs"
subtitle: "Unitat 2 · Administració i Manteniment de Sistemes i Aplicacions (AMSA)"
author: "Jordi Mateo Fornés <jordi.mateo@udl.cat>"
format: html
lang: ca
---

## Objectius
- Comprendre el procés d'arrencada en Linux (GRUB → initramfs → systemd).
- Configurar i gestionar serveis `systemd`.
- Crear snapshots de l’estat del sistema i restaurar-los.
- Introduir-se a la personalització d’`initramfs` i opcionalment GRUB.

## Context

En entorns reals, és freqüent necessitar tornar a un estat anterior del sistema després d’una fallada o una actualització incorrecta. Aquesta pràctica simula aquest escenari: configurarem un mecanisme de snapshots i un procés per restaurar-los en arrencar la màquina.

## Entorn de treball
- Màquina virtual amb Debian 12 i amb UEFI amb 20 GB de disc.
- Disc virtual addicional de 20 GB per emmagatzemar els snapshots.

## Preparació de la màquina virtual

Un cop arrencada la màquina virtual, afegiu un disc dur addicional de 20 GB. Aquest disc serà utilitzat per emmagatzemar els snapshots. Per exemple, si el disc principal és `/dev/nvme0n1`, el nou disc podria ser `/dev/nvme0n2`. Un cop afegit el disc, inicieu la màquina virtual i comproveu que el nou disc és visible amb `lsblk`.

Un cop identificat el nou disc, cal crear-hi un sistema de fitxers i muntar-lo. Per exemple, si el nou disc és `/dev/nvme0n2`, podeu fer-ho així:

```bash
# Com a root o amb sudo
mkfs.ext4 /dev/nvme0n2
mount /dev/nvme0n2 /mnt
mkdir -p /mnt/snapshots
```

Per evitar haver de muntar el disc manualment cada cop, afegiu una entrada a `/etc/fstab`. Per exemple, afegiu aquesta línia al final del fitxer:

```bash
/dev/nvme0n2  /mnt  ext4  defaults  0  2
```

:::{.callout-warning title="Advertència"}
Assegureu-vos d'indicar el disc correcte que pot ser nvme0n2, sdb, vdb,... No utilitzeu el disc principal on està instal·lat el sistema operatiu.
:::



Un cop muntat el disc, instal·leu `rsync` si no està instal·lat:

```bash
# Com a root o amb sudo
apt update
apt install rsync
```

En cas de problemes amb el `update`, igual necessitareu fer un `apt upgrade` abans.


## Tasques

1. **Crear snapshots amb `rsync` (bàsic)** 📝
   - Escriure un script que creï snapshots del directori `/home` i  a `/mnt/snapshots` utilitzant `rsync`.
   - Crea un primer snapshot manualment per tenir una base de dades inicial i anomeneu-lo `snapshot_00000000_000000`, feu servir script com a `root` o amb `sudo`.
   - Provar l’script manualment i assegurar-se que es poden crear diversos snapshots.
   - Utilitzar un format de nom com `snapshot_YYYYMMDD_HHMMSS` per al directori. 
   - Els snapshots han de ser còpies completes del sistema, excepte el directori de snapshots.
   - Implementar una política per mantenir el snapshot inicial i els 3 snapshots més recents, eliminant els més antics.
  
2. **Automatitzar la creació de snapshots amb `systemd` (nivell mitjà)** ⚙️
   - Crear un servei `systemd` que executi l’script de creació de snapshots a cada apagada de la màquina.
   - Validar que cada vegada que s’aturi la màquina es crea un nou snapshot.

3. **Restaurar snapshots en arrencada amb `systemd` (nivell mitjà)** 🔄
    - Escriure un script que mostri un llistat de snapshots disponibles i permeti seleccionar-ne un per restaurar.
    - Crear un servei `systemd` que s’executi abans de `multi-user.target` i cridi aquest script.
    - Comprovar que en arrencar la màquina es mostra el menú de snapshots.

4. **Restaurar snapshots des d’`initramfs` (nivell avançat)** 🚀
    - Afegir un parametre al kernel per indicar el fitxer de snapshot a restaurar.
    - Afegir un script a `initramfs` que carregui el disc secundari, llegeixi el paràmetre i restauri el snapshot abans de muntar `/`.
    - Reconstruir l’`initramfs` i validar que s'ha restaurat el snapshot correcte.

  
## Preguntes de reflexió

- Quins riscos implica restaurar snapshots a nivell de fitxers?  (**bàsic**)
- Com es pot assegurar la integritat dels snapshots creats?  (**intermedi**)
- Quina diferència hi ha entre executar el menú de restauració a initramfs i fer-ho amb systemd després d’arrencar? (**avançat**)



## Criteris d’avaluació

| Criteri                        | Puntuació |
|-------------------------------|-----------|
| Bàsic (script manual)         | 5 punts   |
| Intermedi (systemd)            | 7 punts   |
| Avançat (initramfs)            | 9 punts  |
| Extra (GRUB)                   | 10 punts  |


## Organització i lliurament

Creeu un directori anomenat `practica01` amb l’estructura següent i pengeu-lo al vostre repositori de GitHub:

```text
📂 practica01/
├── SOLUCIÓ.md                # Solució i explicació de cada part amb captures 
├── scripts/
│   ├── create_snapshot.sh    # Esquelet d'script per crear snapshots
│   ├── restore_snapshot.sh   # Esquelet d'script per restaurar snapshots
│   └── helpers.sh            # Funcions auxiliars (ordenar, netejar snapshots, etc.)
├── systemd/
│   ├── snapshot.service      # Unit file per crear snapshot al shutdown
│   └── restore.service       # Unit file per restaurar snapshot a l'arrencada
├── initramfs/
│   └── snapshot_menu         # Hook d’exemple per initramfs 
└── grub/
    └── 40_custom_snapshot    # Exemple d’entrada extra per GRUB 
```

Es permet també documentar la pràctica en un document `.pdf` enlloc de `.md` amb les explicacions i captures de pantalla. Assegureu-vos d’incloure totes les parts desenvolupades i les respostes a les preguntes de reflexió.

