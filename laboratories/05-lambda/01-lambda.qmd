---
title: "Laboratori: AWS Lambda, CloudWatch i Arquitectures Serverless d‚ÄôEvents"
subtitle: "Administraci√≥ de Sistemes i Aplicacions"
author: "Jordi Mateo Forn√©s"
---

# Introducci√≥


## Objectius del laboratori

- Conceptes de computaci√≥ *serverless* i execuci√≥ basada en esdeveniments
- Creaci√≥ i desplegament de funcions Lambda en dos formats:
  - ZIP a S3
  - Contenidor Docker a ECR
- Integraci√≥ de Lambda amb API Gateway i EventBridge
- Monitoratge avan√ßat amb CloudWatch Logs, Metrics i Alarms


## Tasques

### Tasca 1: Creaci√≥ d'una funci√≥ Lambda b√†sica (ZIP a S3)

En aquesta tasca, crearem un funci√≥ Lambda b√†sica que s'activa mitjan√ßant una crida HTTP a trav√©s d'API Gateway.


#### üìò Preparar el codi de la funci√≥ Lambda

AWS Lambda necessita un punt d‚Äôentrada anomenat **handler**, en aquest cas: ```nombre_fitxer.nom_funcio```. Per exemple, si el fitxer es diu `lambda_function.py` i la funci√≥ √©s `lambda_handler`, el handler ser√† `lambda_function.lambda_handler`.

- Crear un fitxer anomenat `lambda_function.py` amb el seg√ºent contingut:

```python
import json

def lambda_handler(event, context):
    response = {
        "message": "Hola des de Lambda!",
        "received_event": event
    }

    return {
        "statusCode": 200,
        "headers": {
            "Content-Type": "application/json"
        },
        "body": json.dumps(response)
    }
```

On:

- **event**: Cont√© les dades de l‚Äôesdeveniment que va activar la funci√≥ Lambda (per exemple, una crida HTTP).
- **context**: Proporciona informaci√≥ sobre l‚Äôexecuci√≥ de la funci√≥ (com el temps restant, l‚ÄôID de la funci√≥, etc.).
- La funci√≥ retorna un *JSON* que veurem quan la invoquem.

#### üì¶ Empaquetar la funci√≥ com un ZIP

Per pujar la funci√≥ a AWS Lambda, hem d‚Äôempaquetar el fitxer `lambda_function.py` en un arxiu ZIP.

```bash
zip function.zip lambda_function.py
```

#### ‚òÅÔ∏è Pujar el codi a un bucket S3

Crearem un bucket S3 per allotjar el codi de la funci√≥ Lambda i pujarem l‚Äôarxiu ZIP. Per exemple, utilitzant l‚ÄôAWS CLI:

:::{.callout-warning title="Assegura't!"}
No continuuis el proc√©s sense haver iniciat sessi√≥ amb el teu compte d'owner generat al laboratori d'AWS Educate amb les credencials corresponents. ```aws configure``` amb regio `us-east-1`.
:::

```bash
aws s3api create-bucket --bucket your-bucket-name --region us-east-1
aws s3 cp function.zip s3://your-bucket-name/
# on bucket-name pot ser amsa-lambda01-jmf
# aws s3api create-bucket --bucket amsa-lambda01-jmf --region us-east-1
# aws s3 cp function.zip s3://amsa-lambda01-jmf/
```

#### üöÄ Crear la funci√≥ Lambda

Per crear la funci√≥ Lambda, podem utilitzar la consola d‚ÄôAWS o l‚ÄôAWS CLI. Aqu√≠ utilitzarem l‚ÄôAWS CLI:

```bash
aws lambda create-function --function-name MyLambdaFunction \
  --runtime python3.12 \
  --role arn:aws:iam::<ACCOUNT-ID>:role/<ExistingLambdaRole> \
  --handler lambda_function.lambda_handler \
  --code S3Bucket=your-bucket-name,S3Key=function.zip

# aws lambda create-function --function-name activitat01 \
#    --runtime python3.12 \
#    --role arn:aws:iam::641672871019:role/LabRole \
#    --handler lambda_function.lambda_handler \
#    --code S3Bucket=amsa-lambda01-jmf,S3Key=function.zip

# Assegura't de substituir <ACCOUNT-ID> pel teu ID de compte AWS
# Utilitza LabRole com a nom del rol d'execuci√≥
```

| Par√†metre         | Significat                            |
| ----------------- | ------------------------------------- |
| `--function-name` | Nom visible a AWS                     |
| `--runtime`       | Versi√≥ de Python                      |
| `--role`          | Rol IAM que permet executar la funci√≥ |
| `--handler`       | Punt d‚Äôentrada (`arxiu.funci√≥`)       |
| `--code`          | On est√† el ZIP                        |


#### üß™ 5. Provar la funci√≥

Per poder testejar la nostra funci√≥ labmda, craerem un fitxer `event.json` amb el seg√ºent contingut:

```json
{
  "nom": "Nom"
}
```

on `nom` √©s un par√†metre que enviarem a la funci√≥ Lambda i `Nom` √©s el seu valor.

```bash
echo -e '{"nom":"Jordi"}' > event.json
```

Podem provar la funci√≥ Lambda directament des de la consola d‚ÄôAWS Lambda o utilitzant l‚ÄôAWS CLI.  En aquest cas, utilitzarem l‚ÄôAWS CLI:

```bash
aws lambda invoke --function-name MyLambdaFunction \
--payload file://event.json response.json
```

:::{.callout-warning title="Problemes de codificaci√≥?"}

Si quan executeu la invocaci√≥ obteniu un error relacionat amb la codificaci√≥, com ara: `Could not parse request body into json` o similars.


Si teniu problemes amb la codificaci√≥, podeu provar amb:

```bash
aws lambda invoke \
  --function-name MyLambdaFunction \
  --cli-binary-format raw-in-base64-out \
  --payload '{"nom":"Nom"}' \
  response.json
```

on `--cli-binary-format raw-in-base64-out` indica a l‚ÄôAWS CLI que el payload s‚Äôenvia en format brut i es codifica en base64 autom√†ticament.

:::

Ara, si revisem el fitxer `response.json`, haur√≠em de veure la resposta de la funci√≥ Lambda:

```bash
cat response.json
#{"statusCode": 200, "headers": {"Content-Type": "application/json"}, "body": "{\"message\": \"Hola des de Lambda!\", \"received_event\": {\"nom\": \"Jordi\"}}"}
```

o si volem veure-ho de manera m√©s llegible:

```json
{
  "statusCode": 200,
  "headers": {
    "Content-Type": "application/json"
  },
  "body": "{\"message\": \"Hola des de Lambda!\", \"received_event\": {\"nom\": \"Jordi\"}}"
}
```

#### üåê Invocar la funci√≥ a trav√©s d‚Äôun endpoint HTTP

##### Crear una API REST amb API Gateway

Per permetre que la funci√≥ Lambda sigui invocada mitjan√ßant una crida HTTP, utilitzarem l‚ÄôAPI Gateway per crear una API REST que redirigeixi les peticions a la funci√≥ Lambda. Ves a la secci√≥ **API GATEWAY**.

Passos:

- Fes clic a **Create API**
- Selecciona **REST API** ‚Üí **Build**
- Configura:
  - Seleccionar: **New API**.
  - **API Name**: Activitat01-API
  - **Security Policy**: SecurityPolicy_tls13_1_2 (per AWS Educate est√†ndard)
- Clic a **Create API**

##### Configurar la ruta i el m√®tode

La ruta ser√† `/hola` i el m√®tode ser√† `GET`. Els passos s√≥n:

- Fes clic a **Create Resource**
- Omple:
  - **Resource Name**: hola
  - **Resource Path**: /
  - Aix√≤ crear√† el recurs `/hola`
- Clic a **Create Resource**
- Selecciona el recurs `/hola` a l‚Äôarbre
- Clic a **Create Method**
- Tria **GET**
- Configura:
  - **Integration Type**: Lambda Function
  - **Use Lambda Proxy Integration**: ‚úì 
  - **Lambda Function**: MyLambdaFunction (*activitat01*)

:::{.callout-note title="Lambda Proxy Integration"}
Si activeu aquesta opci√≥, la funci√≥ Lambda rebr√† l‚Äôesdeveniment complet de la petici√≥ HTTP, incloent m√®tode, cap√ßaleres, par√†metres de consulta, etc. Aix√≤ implica que ha de retornar un format JSON est√†ndard (statusCode, headers, body). Si no, *API Gateway retornar√† 502 Malformed Lambda proxy response*.
:::


##### Desplegar l‚ÄôAPI

Perqu√® l‚ÄôAPI REST funcioni, cal desplegar-la en un stage: 

- A la part superior, clica **Actions**
- Selecciona **Deploy API**
- Configura:
  - **Deployment stage**: New Stage
  - **Stage name**: prod
- Clica **Deploy**
- API Settings et mostrar√† una URL p√∫blica (**Default endpoint**): `https://odv1r67fn2.execute-api.us-east-1.amazonaws.com`


##### Provar l‚ÄôAPI

Per testejar l‚Äôendpoint, podem utilitzar `curl` o un navegador web:

```bash
curl "https://odv1r67fn2.execute-api.us-east-1.amazonaws.com/prod/hola?nom=Jordi"
``` 

::: {.callout-tip}
## Checkpoint (‚úî)
Assegura‚Äôt que:

- La petici√≥ HTTP GET a l‚Äôendpoint de l‚ÄôAPI Gateway retorna un codi d‚Äôestat 200 amb informaci√≥ JSON com:
```json
{
  "message": "Hola des de Lambda!",
  "received_event": {
    "resource": "/hola",
    "path": "/hola/",
    "httpMethod": "GET",
    ... 
}
```

:::

### Exercici d'ampliaci√≥

Modifica la funci√≥ Lambda per llegir el par√†metre `nom` de la consulta HTTP i incloure'l en la resposta. Per exemple, si la crida √©s:

```bash
GET /hola?nom=Jordi
```
la resposta hauria de ser:

```json
{
  "message": "Hola, Jordi, des de Lambda!",
  "received_event": { ... }
}
```

Pots accedir als par√†metres de consulta a trav√©s de l'objecte `event` dins de la funci√≥ Lambda.

## Tasca 2: Observabilitat amb CloudWatch de Lambda

En aquesta tasca, configurarem el monitoratge de la funci√≥ Lambda utilitzant Amazon CloudWatch per supervisar els logs i les m√®triques d'execuci√≥.

### Accedir als logs de la Lambda (CloudWatch Logs)

- A la consola d'AWS, ves a **CloudWatch**.
- A la barra lateral, selecciona **Logs** ‚Üí **Log management**.
- Cerca el grup de logs associat a la teva funci√≥ Lambda, que tindr√† un nom similar a `/aws/lambda/MyLambdaFunction`.
- Observars una llista de streams de logs:

| Log Stream | Last Event Time        |
|------------|------------------------|
2025/12/09/[$LATEST]562a9136345a450b95c7ed75a3165829
2025-12-09 14:20:45 (UTC)

:::{.callout-tip title="Logs de Lambda"}
Cada vegada que la funci√≥ Lambda s'executa, es crea un nou stream de logs amb els detalls de l'execuci√≥, incloent qualsevol missatge impr√®s amb `print()` dins de la funci√≥.
:::

### Interpretar les m√®triques de Lambda (CloudWatch Metrics)

- Obra un log stream per veure els detalls de l'execuci√≥.

|Timestamp            | Message                                                                                                                            |
|---------------------|------------------------------------------------------------------------------------------------------------------------------------|
|2025-12-09T14:20:45.476Z| INIT_START Runtime Version: python:3.12.v99 Runtime Version ARN: arn:aws:lambda:us-east-1::runtime:42569371fb03ced3fe5b4d63763662bf9b13a5d4299cb453cc55a71374cbf30c |
|2025-12-09T14:20:45.570Z| START RequestId: 510c7270-9e27-4265-aecf-c8f139b89a3f Version: $LATEST                                                        |
|2025-12-09T14:20:45.587Z| END RequestId: 510c7270-9e27-4266-aecf-c8f139b89a3f                                                                  |
|2025-12-09T14:20:45.587Z| REPORT RequestId: 510c7270-9e27-4266-aecf-c8f-c8f139b89a3f Duration: 16.71 ms Billed Duration: 107 ms Memory Size: 128 MB Max Memory Used: 36 MB Init Duration: 89.89 ms |

En aquest log, podem veure informaci√≥ important sobre l'execuci√≥ de la funci√≥ Lambda:

| Camp                | Significat                                                          |
| ------------------- | ------------------------------------------------------------------- |
| **RequestId**       | ID √∫nic de la invocaci√≥                                             |
| **Duration**        | Temps real d‚Äôexecuci√≥                                               |
| **Billed Duration** | Temps que AWS factura (arrodonit a ms)                              |
| **Init Duration**   | Temps del *cold start* (nom√©s en la primera execuci√≥ del container) |
| **Max Memory Used** | Mem√≤ria utilitzada pel codi                                         |

En el cas de l'exemple anterior, la funci√≥ Lambda va trigar 16.71 ms a executar-se, per√≤ es va facturar per 107 ms. La mem√≤ria m√†xima utilitzada va ser de 36 MB. La diferencia entre el temps d'execuci√≥ i el temps facturat √©s Init Duration: 89.89 ms, que correspon al temps de *cold start*.

:::{.callout-note title="Cold Start"}
√âs el temps addicional necessari perqu√® AWS inicialitzi un nou entorn d‚Äôexecuci√≥ per a Lambda.
Aquest temps nom√©s apareix quan:

- La Lambda no ha estat invocada recentment
- AWS ha d‚Äôassignar un contenidor nou
:::

### Exercici d'ampliaci√≥

- Configura una alarma de CloudWatch que s'activi quan la funci√≥ Lambda estigui fallant m√©s del 5% de les invocacions en un per√≠ode de 5 minuts.

### Tasca 3: Desplegament de Lambda amb Contenidor Docker a ECR

En aquesta tasca, crearem una imatge Docker per a la funci√≥ Lambda i la pujarem a Amazon Elastic Container Registry (ECR).

#### Crear el Dockerfile

Crea un fitxer anomenat `Dockerfile` amb el seg√ºent contingut:

```Dockerfile
FROM public.ecr.aws/lambda/python:3.12

COPY lambda_function.py ${LAMBDA_TASK_ROOT}

CMD ["lambda_function.lambda_handler"]
```

#### Construir la imatge Docker

Construeix la imatge Docker localment:

```bash
docker build --platform linux/amd64 -t my-lambda-container .
# docker build --platform linux/amd64 -t activitat03 .
```

:::{.callout-note title="Arquitectura"}
Assegura't d'utilitzar `--platform linux/amd64` perqu√® Lambda no suporta ARM en totes les regions via ECR.
:::

#### Test local

Prova la imatge Docker localment utilitzant l‚ÄôAWS Lambda Runtime Interface Emulator (RIE):

```bash
docker run -p 9000:8080 my-lambda-container
# docker run -p 9000:8080 activitat03
```

Despr√©s, en una altra terminal, invoca la funci√≥ Lambda localment:

```bash
curl -XPOST "http://localhost:9000/2015-03-31/functions/function/invocations" \
    -d '{"nom": "Jordi"}'
```

Hauries de veure la resposta JSON de la funci√≥ Lambda:

```json
{"statusCode": 200, "headers": {"Content-Type": "application/json"}, "body": "{\"message\": \"Hola des de Lambda!\", \"received_event\": {\"nom\": \"Jordi\"}}"}
```

#### Pujar la imatge a ECR

Crea un repositori ECR per a la imatge Docker:

```bash
aws ecr create-repository --repository-name my-lambda-repo
# aws ecr create-repository --repository-name activitat03-repo
```

Navega al repositori creat i segueix les instruccions per pujar la imatge Docker a ECR. Fes clic a **View push commands** i segueix els passos indicats.

#### Crear la funci√≥ Lambda des de la imatge Docker

Crea la funci√≥ Lambda utilitzant la imatge Docker des de ECR:

```bash
aws lambda create-function --function-name MyDockerLambdaFunction \
  --package-type Image \
  --code ImageUri=<ECR-IMAGE-URI> \
  --role arn:aws:iam::<ACCOUNT-ID>:role/<ExistingLambdaRole>

# aws lambda create-function \
#  --function-name activitat03-container \
#  --package-type Image \
#  --code ImageUri=641672871019.dkr.ecr.us-east-1.amazonaws.com/activitat03-repo:latest \
#  --role arn:aws:iam::641672871019:role/LabRole
```

On `<ECR-IMAGE-URI>` √©s l'URI complet de la imatge Docker a ECR.

#### Provar la funci√≥ Lambda des de la imatge Docker

Prova la funci√≥ Lambda utilitzant l‚ÄôAWS CLI:

```bash
aws lambda invoke --function-name MyDockerLambdaFunction \
--payload file://event.json response.json
# aws lambda invoke --function-name activitat03-container \
# --payload file://event.json response.json
```

::: {.callout-tip}
## Checkpoint (‚úî)
Revisa el fitxer `response.json` per veure la resposta de la funci√≥ Lambda. Hauries de veure una resposta similar a la que vam obtenir anteriorment.
:::

## Activitat final

En aquesta activitat, dissenyareu i implementareu un sistema complet basat en AWS Lambda que:

![](../../figs/laboratories/06-lambda/cell-counting-aws-lambda.png)

Automatitzarem el processament d‚Äôimatges per comptar c√®l¬∑lules utilitzant una funci√≥ Lambda que s‚Äôactiva quan es puja una nova imatge a un bucket S3:

![](../../figs/laboratories/06-lambda/cell-counting-problem.png)

Tasques:

- Crea una funci√≥ Lambda que processi imatges per comptar c√®l¬∑lules utilitzant OpenCV utilitzant el codi proporcionat a continuaci√≥.
- Crea dos buckets S3 per a les imatges d'entrada i sortida.
- Crea un trigger perqu√® la funci√≥ Lambda s'activi quan es puja una nova imatge al bucket d'entrada (**PUT**).
- Verifica que la imatge processada es desa al bucket de sortida i que les c√®l¬∑lules s'han comptat correctament.
- Podeu utiltizar les imatges reals: 
  - [C√®l¬∑lules 1](./src/cells/IMG00197.JPG)
  - [C√®l¬∑lules 2](./src/cells/IMG00207.JPG)
  - [C√®l¬∑lules 3](./src/cells/IMG00226.JPG)
  - [C√®l¬∑lules 4](./src/cells/IMG00230.JPG)
  - [C√®l¬∑lules 5](./src/cells/IMG00232.JPG)
  - [C√®l¬∑lules 6](./src/cells/IMG00250.JPG)

#### Codi de la funci√≥ Lambda

Podeu utilitzar el seg√ºent codi per a la funci√≥ Lambda que processa les imatges [`lambda_function.py`](./src/lambda_function.py).


## Presentaci√≥ del laboratori

Documenta els passos seguits, els reptes trobats i les solucions implementades. Inclou captures de pantalla dels buckets S3 amb les imatges processades i els resultats obtinguts. Cal entregar un informe escrit en format PDF amb la resoluci√≥ de les 3 tasques proposades. Per fer-ho, utilitzeu l'activitat de [github classroom associada al laboratori](https://classroom.github.com/a/Rn_XI173)













